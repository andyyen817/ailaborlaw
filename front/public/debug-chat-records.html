<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©è®°å½•é‡å¤é—®é¢˜è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 3px; margin: 5px 0; }
        .error { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 3px; margin: 5px 0; }
        .warning { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 3px; margin: 5px 0; }
        .info { background-color: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 3px; margin: 5px 0; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .log { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: #f9f9f9; }
        .compare-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .compare-table th, .compare-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .compare-table th { background: #f5f5f5; }
        .duplicate { background-color: #ffebee; }
    </style>
</head>
<body>
    <h1>ğŸ” èŠå¤©è®°å½•é‡å¤é—®é¢˜è°ƒè¯•å·¥å…·</h1>
    
    <div class="section">
        <h2>ğŸ“‹ é—®é¢˜è¯Šæ–­æ­¥éª¤</h2>
        <button onclick="step1_checkAPI()">æ­¥éª¤1: æ£€æŸ¥APIè°ƒç”¨</button>
        <button onclick="step2_checkLocalStorage()">æ­¥éª¤2: æ£€æŸ¥localStorage</button>
        <button onclick="step3_compareData()">æ­¥éª¤3: å¯¹æ¯”æ•°æ®æº</button>
        <button onclick="step4_findDuplicates()">æ­¥éª¤4: æŸ¥æ‰¾é‡å¤åŸå› </button>
    </div>
    
    <div class="section">
        <h2>ğŸ“Š è°ƒè¯•ç»“æœ</h2>
        <div id="results"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ“ è¯¦ç»†æ—¥å¿—</h2>
        <div class="log" id="debug-log"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <script>
        const API_BASE_URL = 'https://wrrfvodsaofk.sealosgzg.site/api/v1';
        const debugLog = document.getElementById('debug-log');
        const results = document.getElementById('results');
        
        let apiData = null;
        let localStorageData = null;
        let processedLocalStorageData = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            debugLog.innerHTML = '';
        }
        
        function addResult(title, content, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = type;
            resultDiv.innerHTML = `<h3>${title}</h3>${content}`;
            results.appendChild(resultDiv);
        }
        
        async function step1_checkAPI() {
            log('ğŸš€ å¼€å§‹æ­¥éª¤1: æ£€æŸ¥APIè°ƒç”¨', 'info');
            
            const adminToken = localStorage.getItem('admin_access_token');
            if (!adminToken) {
                log('âŒ æ²¡æœ‰ç®¡ç†å‘˜Token', 'error');
                addResult('APIæ£€æŸ¥ç»“æœ', 'âŒ ç¼ºå°‘ç®¡ç†å‘˜è®¤è¯Tokenï¼Œæ— æ³•è°ƒç”¨API', 'error');
                return;
            }
            
            try {
                const testURL = `${API_BASE_URL}/admin/chat/sessions?page=1&limit=1000&status=all`;
                log(`ğŸŒ è°ƒç”¨API: ${testURL}`, 'info');
                
                const response = await fetch(testURL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`ğŸ“Š APIå“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    apiData = data;
                    
                    if (data.success && data.data && data.data.sessions) {
                        const sessions = data.data.sessions;
                        log(`âœ… APIè°ƒç”¨æˆåŠŸï¼Œè·å–åˆ° ${sessions.length} ä¸ªä¼šè¯`, 'success');
                        
                        addResult('APIè°ƒç”¨ç»“æœ', `
                            <p>âœ… APIè°ƒç”¨æˆåŠŸ</p>
                            <p>ğŸ“Š ä¼šè¯æ•°é‡: ${sessions.length}</p>
                            <p>ğŸ” æ•°æ®æ ·æœ¬:</p>
                            <pre>${JSON.stringify(sessions.slice(0, 2), null, 2)}</pre>
                        `, 'success');
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„sessionId
                        const sessionIds = sessions.map(s => s.sessionId);
                        const uniqueSessionIds = [...new Set(sessionIds)];
                        
                        if (sessionIds.length !== uniqueSessionIds.length) {
                            log(`âš ï¸ APIæ•°æ®ä¸­å‘ç°é‡å¤çš„sessionIdï¼`, 'warning');
                            addResult('APIé‡å¤æ£€æŸ¥', `
                                <p>âš ï¸ å‘ç°é‡å¤ï¼</p>
                                <p>æ€»ä¼šè¯æ•°: ${sessionIds.length}</p>
                                <p>å”¯ä¸€ä¼šè¯æ•°: ${uniqueSessionIds.length}</p>
                                <p>é‡å¤æ•°é‡: ${sessionIds.length - uniqueSessionIds.length}</p>
                            `, 'warning');
                        } else {
                            log(`âœ… APIæ•°æ®ä¸­æ²¡æœ‰é‡å¤çš„sessionId`, 'success');
                            addResult('APIé‡å¤æ£€æŸ¥', 'âœ… APIæ•°æ®ä¸­æ²¡æœ‰é‡å¤çš„ä¼šè¯ID', 'success');
                        }
                        
                    } else {
                        log(`âŒ APIå“åº”æ ¼å¼å¼‚å¸¸`, 'error');
                        addResult('APIè°ƒç”¨ç»“æœ', `âŒ APIå“åº”æ ¼å¼å¼‚å¸¸: ${JSON.stringify(data)}`, 'error');
                    }
                } else {
                    log(`âŒ APIè°ƒç”¨å¤±è´¥: ${response.status}`, 'error');
                    const errorText = await response.text();
                    addResult('APIè°ƒç”¨ç»“æœ', `âŒ APIè°ƒç”¨å¤±è´¥ (${response.status}): ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ APIè°ƒç”¨å¼‚å¸¸: ${error.message}`, 'error');
                addResult('APIè°ƒç”¨ç»“æœ', `âŒ APIè°ƒç”¨å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        async function step2_checkLocalStorage() {
            log('ğŸš€ å¼€å§‹æ­¥éª¤2: æ£€æŸ¥localStorage', 'info');
            
            try {
                const globalStoreKey = 'global_chat_history';
                const globalHistory = localStorage.getItem(globalStoreKey);
                
                if (!globalHistory) {
                    log('â„¹ï¸ localStorageä¸­æ²¡æœ‰å…¨å±€èŠå¤©å†å²æ•°æ®', 'info');
                    addResult('localStorageæ£€æŸ¥', 'â„¹ï¸ localStorageä¸­æ²¡æœ‰å…¨å±€èŠå¤©å†å²æ•°æ®', 'info');
                    return;
                }
                
                const historyData = JSON.parse(globalHistory);
                localStorageData = historyData;
                
                log(`ğŸ“¥ localStorageä¸­æœ‰ ${historyData.length} æ¡åŸå§‹è®°å½•`, 'info');
                
                // æŒ‰sessionIdåˆ†ç»„ç»Ÿè®¡
                const sessionGroups = {};
                historyData.forEach(msg => {
                    const sessionId = msg.conversationId || msg.sessionId;
                    if (sessionId) {
                        if (!sessionGroups[sessionId]) {
                            sessionGroups[sessionId] = [];
                        }
                        sessionGroups[sessionId].push(msg);
                    }
                });
                
                const sessionCount = Object.keys(sessionGroups).length;
                log(`ğŸ“Š localStorageä¸­åŒ…å« ${sessionCount} ä¸ªä¸åŒçš„ä¼šè¯`, 'info');
                
                // æ£€æŸ¥æ¯ä¸ªä¼šè¯çš„æ¶ˆæ¯é‡å¤æƒ…å†µ
                let duplicateCount = 0;
                for (const [sessionId, messages] of Object.entries(sessionGroups)) {
                    const messageContents = messages.map(m => `${m.type}:${m.content}`);
                    const uniqueContents = [...new Set(messageContents)];
                    
                    if (messageContents.length !== uniqueContents.length) {
                        duplicateCount++;
                        log(`âš ï¸ ä¼šè¯ ${sessionId} æœ‰é‡å¤æ¶ˆæ¯: ${messageContents.length} æ€»æ•°, ${uniqueContents.length} å”¯ä¸€`, 'warning');
                    }
                }
                
                addResult('localStorageæ•°æ®åˆ†æ', `
                    <p>ğŸ“Š åŸå§‹è®°å½•æ•°: ${historyData.length}</p>
                    <p>ğŸ“Š ä¼šè¯æ•°é‡: ${sessionCount}</p>
                    <p>âš ï¸ æœ‰é‡å¤æ¶ˆæ¯çš„ä¼šè¯: ${duplicateCount}</p>
                    <p>ğŸ” æœ€è¿‘5æ¡è®°å½•æ ·æœ¬:</p>
                    <pre>${JSON.stringify(historyData.slice(-5), null, 2)}</pre>
                `, duplicateCount > 0 ? 'warning' : 'success');
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥localStorageå¤±è´¥: ${error.message}`, 'error');
                addResult('localStorageæ£€æŸ¥', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function step3_compareData() {
            log('ğŸš€ å¼€å§‹æ­¥éª¤3: å¯¹æ¯”æ•°æ®æº', 'info');
            
            if (!apiData && !localStorageData) {
                log('âŒ éœ€è¦å…ˆæ‰§è¡Œæ­¥éª¤1å’Œæ­¥éª¤2è·å–æ•°æ®', 'error');
                addResult('æ•°æ®å¯¹æ¯”', 'âŒ è¯·å…ˆæ‰§è¡Œæ­¥éª¤1å’Œæ­¥éª¤2è·å–æ•°æ®', 'error');
                return;
            }
            
            let comparison = '<table class="compare-table"><tr><th>æ•°æ®æº</th><th>ä¼šè¯æ•°é‡</th><th>çŠ¶æ€</th><th>å¤‡æ³¨</th></tr>';
            
            // APIæ•°æ®
            if (apiData && apiData.success && apiData.data && apiData.data.sessions) {
                const apiSessions = apiData.data.sessions;
                comparison += `<tr><td>åç«¯API</td><td>${apiSessions.length}</td><td class="success">âœ… æ­£å¸¸</td><td>ç›´æ¥ä»APIè·å–</td></tr>`;
            } else {
                comparison += `<tr><td>åç«¯API</td><td>-</td><td class="error">âŒ å¤±è´¥</td><td>APIè°ƒç”¨å¤±è´¥æˆ–æ ¼å¼é”™è¯¯</td></tr>`;
            }
            
            // localStorageæ•°æ®
            if (localStorageData) {
                // æ¨¡æ‹ŸconvertToConversationså¤„ç†
                const sessionGroups = {};
                localStorageData.forEach(msg => {
                    const sessionId = msg.conversationId || msg.sessionId;
                    if (sessionId) {
                        if (!sessionGroups[sessionId]) {
                            sessionGroups[sessionId] = {
                                id: sessionId,
                                messages: []
                            };
                        }
                        sessionGroups[sessionId].messages.push(msg);
                    }
                });
                
                const convertedCount = Object.keys(sessionGroups).length;
                processedLocalStorageData = Object.values(sessionGroups);
                
                comparison += `<tr><td>localStorage (åŸå§‹)</td><td>${localStorageData.length} æ¡è®°å½•</td><td class="info">â„¹ï¸ åŸå§‹æ•°æ®</td><td>æœªå¤„ç†çš„æ¶ˆæ¯è®°å½•</td></tr>`;
                comparison += `<tr><td>localStorage (å¤„ç†å)</td><td>${convertedCount} ä¸ªä¼šè¯</td><td class="warning">âš ï¸ è½¬æ¢å</td><td>ç»è¿‡convertToConversationså¤„ç†</td></tr>`;
            } else {
                comparison += `<tr><td>localStorage</td><td>-</td><td class="info">â„¹ï¸ ç©º</td><td>æ²¡æœ‰æœ¬åœ°æ•°æ®</td></tr>`;
            }
            
            comparison += '</table>';
            
            addResult('æ•°æ®æºå¯¹æ¯”', comparison, 'info');
            
            // åˆ¤æ–­å½“å‰é¡µé¢ä½¿ç”¨çš„æ•°æ®æº
            if (apiData && apiData.success) {
                log('ğŸ“Š å‰ç«¯åº”è¯¥ä½¿ç”¨APIæ•°æ®', 'success');
                addResult('æ•°æ®æºåˆ¤æ–­', 'âœ… å‰ç«¯åº”è¯¥ä½¿ç”¨APIæ•°æ®ï¼ˆå¦‚æœæœ‰é‡å¤ï¼Œé—®é¢˜åœ¨APIæˆ–å‰ç«¯å¤„ç†ï¼‰', 'success');
            } else {
                log('ğŸ“Š å‰ç«¯ä¼šfallbackåˆ°localStorageæ•°æ®', 'warning');
                addResult('æ•°æ®æºåˆ¤æ–­', 'âš ï¸ å‰ç«¯ä¼šfallbackåˆ°localStorageæ•°æ®ï¼ˆå¦‚æœæœ‰é‡å¤ï¼Œé—®é¢˜åœ¨localStorageæˆ–è½¬æ¢é€»è¾‘ï¼‰', 'warning');
            }
        }
        
        async function step4_findDuplicates() {
            log('ğŸš€ å¼€å§‹æ­¥éª¤4: æŸ¥æ‰¾é‡å¤åŸå› ', 'info');
            
            let duplicateAnalysis = '<h4>é‡å¤åˆ†æç»“æœ:</h4>';
            
            // åˆ†æAPIæ•°æ®é‡å¤
            if (apiData && apiData.success && apiData.data && apiData.data.sessions) {
                const sessions = apiData.data.sessions;
                const sessionMap = new Map();
                
                sessions.forEach((session, index) => {
                    const key = `${session.userId}-${session.title}-${session.createdAt}`;
                    if (sessionMap.has(key)) {
                        sessionMap.get(key).push({session, index});
                    } else {
                        sessionMap.set(key, [{session, index}]);
                    }
                });
                
                const duplicateGroups = Array.from(sessionMap.entries()).filter(([key, sessions]) => sessions.length > 1);
                
                if (duplicateGroups.length > 0) {
                    duplicateAnalysis += `<div class="error">âŒ APIæ•°æ®ä¸­å‘ç° ${duplicateGroups.length} ç»„é‡å¤ä¼šè¯:</div>`;
                    duplicateGroups.forEach(([key, sessions], groupIndex) => {
                        duplicateAnalysis += `<div class="duplicate">é‡å¤ç»„ ${groupIndex + 1}: ${key}<br>`;
                        sessions.forEach(({session, index}) => {
                            duplicateAnalysis += `&nbsp;&nbsp;- sessionId: ${session.sessionId} (ç´¢å¼•: ${index})<br>`;
                        });
                        duplicateAnalysis += `</div>`;
                    });
                } else {
                    duplicateAnalysis += `<div class="success">âœ… APIæ•°æ®ä¸­æ²¡æœ‰å‘ç°é‡å¤ä¼šè¯</div>`;
                }
            }
            
            // åˆ†ælocalStorageæ•°æ®é‡å¤
            if (processedLocalStorageData) {
                const sessionMap = new Map();
                
                processedLocalStorageData.forEach((session, index) => {
                    const firstUserMessage = session.messages.find(m => m.type === 'user');
                    const key = firstUserMessage ? `${session.id}-${firstUserMessage.content.substring(0, 50)}` : session.id;
                    
                    if (sessionMap.has(key)) {
                        sessionMap.get(key).push({session, index});
                    } else {
                        sessionMap.set(key, [{session, index}]);
                    }
                });
                
                const duplicateGroups = Array.from(sessionMap.entries()).filter(([key, sessions]) => sessions.length > 1);
                
                if (duplicateGroups.length > 0) {
                    duplicateAnalysis += `<div class="error">âŒ localStorageå¤„ç†åæ•°æ®ä¸­å‘ç° ${duplicateGroups.length} ç»„é‡å¤ä¼šè¯:</div>`;
                    duplicateGroups.forEach(([key, sessions], groupIndex) => {
                        duplicateAnalysis += `<div class="duplicate">é‡å¤ç»„ ${groupIndex + 1}: ${key}<br>`;
                        sessions.forEach(({session, index}) => {
                            duplicateAnalysis += `&nbsp;&nbsp;- sessionId: ${session.id} (ç´¢å¼•: ${index})<br>`;
                        });
                        duplicateAnalysis += `</div>`;
                    });
                } else {
                    duplicateAnalysis += `<div class="success">âœ… localStorageå¤„ç†åæ•°æ®ä¸­æ²¡æœ‰å‘ç°é‡å¤ä¼šè¯</div>`;
                }
            }
            
            // æœ€ç»ˆç»“è®º
            duplicateAnalysis += '<h4>ğŸ¯ é—®é¢˜è¯Šæ–­ç»“è®º:</h4>';
            
            if (apiData && apiData.success) {
                duplicateAnalysis += '<div class="info">å½“å‰é¡µé¢åº”è¯¥ä½¿ç”¨APIæ•°æ®ã€‚å¦‚æœé¡µé¢æ˜¾ç¤ºé‡å¤ï¼Œé—®é¢˜å¯èƒ½åœ¨:</div>';
                duplicateAnalysis += '<ul>';
                duplicateAnalysis += '<li>1. APIæœ¬èº«è¿”å›é‡å¤æ•°æ®</li>';
                duplicateAnalysis += '<li>2. formatSessionsForDisplayå‡½æ•°å¤„ç†é”™è¯¯</li>';
                duplicateAnalysis += '<li>3. Vueæ¨¡æ¿æ¸²æŸ“é—®é¢˜</li>';
                duplicateAnalysis += '<li>4. filteredChatRecordsè®¡ç®—å±æ€§é—®é¢˜</li>';
                duplicateAnalysis += '</ul>';
            } else {
                duplicateAnalysis += '<div class="warning">å½“å‰é¡µé¢ä¼šfallbackåˆ°localStorageæ•°æ®ã€‚å¦‚æœé¡µé¢æ˜¾ç¤ºé‡å¤ï¼Œé—®é¢˜å¯èƒ½åœ¨:</div>';
                duplicateAnalysis += '<ul>';
                duplicateAnalysis += '<li>1. localStorageåŸå§‹æ•°æ®æœ‰é‡å¤è®°å½•</li>';
                duplicateAnalysis += '<li>2. convertToConversationså‡½æ•°å¤„ç†é”™è¯¯</li>';
                duplicateAnalysis += '<li>3. å»é‡é€»è¾‘ä¸å®Œå–„</li>';
                duplicateAnalysis += '</ul>';
            }
            
            addResult('é‡å¤åŸå› åˆ†æ', duplicateAnalysis, 'info');
            log('âœ… é‡å¤åŸå› åˆ†æå®Œæˆ', 'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        window.onload = function() {
            log('ğŸ”§ è°ƒè¯•å·¥å…·å·²åŠ è½½ï¼Œè¯·æŒ‰é¡ºåºæ‰§è¡Œæ­¥éª¤1-4è¿›è¡Œé—®é¢˜è¯Šæ–­', 'info');
            addResult('ä½¿ç”¨è¯´æ˜', `
                <p>ğŸ“‹ è¯·æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹æ­¥éª¤æ¥è¯Šæ–­é‡å¤æ˜¾ç¤ºé—®é¢˜:</p>
                <ol>
                    <li><strong>æ­¥éª¤1</strong>: æ£€æŸ¥åç«¯APIæ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œæ•°æ®æ˜¯å¦æœ‰é‡å¤</li>
                    <li><strong>æ­¥éª¤2</strong>: æ£€æŸ¥localStorageä¸­çš„å†å²æ•°æ®æƒ…å†µ</li>
                    <li><strong>æ­¥éª¤3</strong>: å¯¹æ¯”ä¸¤ä¸ªæ•°æ®æºï¼Œåˆ¤æ–­å‰ç«¯å®é™…ä½¿ç”¨å“ªä¸ª</li>
                    <li><strong>æ­¥éª¤4</strong>: æ·±åº¦åˆ†æé‡å¤çš„å…·ä½“åŸå› å’Œä½ç½®</li>
                </ol>
                <p>ğŸ¯ ç›®æ ‡ï¼šæ‰¾åˆ°å¯¼è‡´ç®¡ç†åå°æ˜¾ç¤ºé‡å¤èŠå¤©è®°å½•çš„ç¡®åˆ‡åŸå› </p>
            `, 'info');
        };
    </script>
</body>
</html> 