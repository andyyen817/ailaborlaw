<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å“¡APIèª¿è©¦å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        input[type="text"] { padding: 5px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç®¡ç†å“¡APIèª¿è©¦å·¥å…·</h1>
    
    <div class="section">
        <h2>ğŸ“ ç•¶å‰èªè­‰ç‹€æ…‹</h2>
        <div id="auth-status"></div>
        <button onclick="checkAuthStatus()">æª¢æŸ¥èªè­‰ç‹€æ…‹</button>
        <button onclick="setTestAdminToken()">è¨­ç½®æ¸¬è©¦ç®¡ç†å“¡Token</button>
    </div>
    
    <div class="section">
        <h2>ğŸŒ ç¶²è·¯é€£æ¥æ¸¬è©¦</h2>
        <div id="network-status"></div>
        <button onclick="testNetworkConnectivity()">æ¸¬è©¦ç¶²è·¯é€£æ¥</button>
        <button onclick="testAPIBaseURL()">æ¸¬è©¦APIåŸºç¤URL</button>
    </div>
    
    <div class="section">
        <h2>ğŸ” ç®¡ç†å“¡APIæ¸¬è©¦</h2>
        <button onclick="testGetAllSessions()">æ¸¬è©¦ç²å–æ‰€æœ‰æœƒè©±</button>
        <button onclick="testGetChatStats()">æ¸¬è©¦ç²å–çµ±è¨ˆæ•¸æ“š</button>
        <button onclick="testWithDifferentTokens()">æ¸¬è©¦ä¸åŒToken</button>
        <div id="api-results"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ“Š è©³ç´°èª¿è©¦ä¿¡æ¯</h2>
        <div class="log" id="debug-log"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
        <button onclick="exportDebugInfo()">å°å‡ºèª¿è©¦ä¿¡æ¯</button>
    </div>

    <script>
        const API_BASE_URL = 'https://wrrfvodsaofk.sealosgzg.site/api/v1';
        const debugLog = document.getElementById('debug-log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            debugLog.innerHTML = '';
        }
        
        function checkAuthStatus() {
            const adminToken = localStorage.getItem('admin_access_token');
            const adminData = localStorage.getItem('admin_data');
            const userToken = localStorage.getItem('auth_token');
            
            let statusHTML = '<h3>èªè­‰ç‹€æ…‹æª¢æŸ¥çµæœï¼š</h3>';
            
            if (adminToken) {
                statusHTML += `<p class="success">âœ… ç®¡ç†å“¡Tokenå­˜åœ¨: ${adminToken.substring(0, 20)}...</p>`;
                try {
                    const payload = parseJWT(adminToken);
                    if (payload) {
                        const exp = new Date(payload.exp * 1000);
                        const now = new Date();
                        statusHTML += `<p>TokenéæœŸæ™‚é–“: ${exp.toLocaleString()}</p>`;
                        statusHTML += `<p ${exp > now ? 'class="success"' : 'class="error"'}>Tokenç‹€æ…‹: ${exp > now ? 'æœ‰æ•ˆ' : 'å·²éæœŸ'}</p>`;
                    }
                } catch (e) {
                    statusHTML += `<p class="warning">âš ï¸ Tokenè§£æå¤±æ•—: ${e.message}</p>`;
                }
            } else {
                statusHTML += '<p class="error">âŒ ç®¡ç†å“¡Tokenä¸å­˜åœ¨</p>';
            }
            
            if (adminData) {
                try {
                    const admin = JSON.parse(adminData);
                    statusHTML += `<p class="success">âœ… ç®¡ç†å“¡è³‡æ–™: ${admin.name} (${admin.email})</p>`;
                } catch (e) {
                    statusHTML += `<p class="warning">âš ï¸ ç®¡ç†å“¡è³‡æ–™è§£æå¤±æ•—</p>`;
                }
            } else {
                statusHTML += '<p class="error">âŒ ç®¡ç†å“¡è³‡æ–™ä¸å­˜åœ¨</p>';
            }
            
            if (userToken) {
                statusHTML += `<p class="warning">âš ï¸ ç”¨æˆ¶Tokenä¹Ÿå­˜åœ¨: ${userToken.substring(0, 20)}...</p>`;
            }
            
            document.getElementById('auth-status').innerHTML = statusHTML;
            log('èªè­‰ç‹€æ…‹æª¢æŸ¥å®Œæˆ');
        }
        
        function setTestAdminToken() {
            const testToken = 'test_admin_token_' + Date.now();
            const testAdmin = {
                id: 'admin_test_001',
                name: 'æ¸¬è©¦ç®¡ç†å“¡',
                email: 'test@admin.com',
                role: 'admin'
            };
            
            localStorage.setItem('admin_access_token', testToken);
            localStorage.setItem('admin_data', JSON.stringify(testAdmin));
            localStorage.setItem('admin_token_expires', (Date.now() + 24 * 60 * 60 * 1000).toString());
            
            log('å·²è¨­ç½®æ¸¬è©¦ç®¡ç†å“¡Token', 'success');
            checkAuthStatus();
        }
        
        async function testNetworkConnectivity() {
            log('é–‹å§‹æ¸¬è©¦ç¶²è·¯é€£æ¥...');
            
            // æ¸¬è©¦åŸºæœ¬é€£æ¥
            try {
                const response = await fetch('https://httpbin.org/json');
                const data = await response.json();
                log('âœ… åŸºæœ¬ç¶²è·¯é€£æ¥æ­£å¸¸', 'success');
            } catch (error) {
                log(`âŒ åŸºæœ¬ç¶²è·¯é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                return;
            }
            
            // æ¸¬è©¦APIä¼ºæœå™¨é€£æ¥
            try {
                const response = await fetch(API_BASE_URL, { method: 'HEAD' });
                log(`âœ… APIä¼ºæœå™¨é€£æ¥ç‹€æ…‹: ${response.status}`, 'success');
            } catch (error) {
                log(`âŒ APIä¼ºæœå™¨é€£æ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testAPIBaseURL() {
            log('æ¸¬è©¦APIåŸºç¤URL...');
            
            try {
                const testURL = `${API_BASE_URL}/health`;
                log(`æ¸¬è©¦URL: ${testURL}`);
                
                const response = await fetch(testURL);
                const data = await response.text();
                
                log(`éŸ¿æ‡‰ç‹€æ…‹: ${response.status}`);
                log(`éŸ¿æ‡‰å…§å®¹: ${data.substring(0, 200)}...`);
                
                if (response.ok) {
                    log('âœ… APIåŸºç¤URLé€£æ¥æˆåŠŸ', 'success');
                } else {
                    log(`âš ï¸ APIéŸ¿æ‡‰ç‹€æ…‹ç•°å¸¸: ${response.status}`, 'warning');
                }
            } catch (error) {
                log(`âŒ APIåŸºç¤URLæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testGetAllSessions() {
            log('é–‹å§‹æ¸¬è©¦ç²å–æ‰€æœ‰æœƒè©±API...');
            
            const adminToken = localStorage.getItem('admin_access_token');
            if (!adminToken) {
                log('âŒ æ²’æœ‰ç®¡ç†å“¡Tokenï¼Œç„¡æ³•æ¸¬è©¦', 'error');
                return;
            }
            
            const testURL = `${API_BASE_URL}/admin/chat/sessions`;
            log(`æ¸¬è©¦URL: ${testURL}`);
            
            try {
                const response = await fetch(testURL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`éŸ¿æ‡‰ç‹€æ…‹: ${response.status}`);
                log(`éŸ¿æ‡‰æ¨™é ­: ${JSON.stringify(Object.fromEntries(response.headers))}`);
                
                const data = await response.json();
                log(`éŸ¿æ‡‰æ•¸æ“š: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok && data.success) {
                    log('âœ… ç²å–æœƒè©±APIèª¿ç”¨æˆåŠŸ', 'success');
                    const sessions = data.data?.sessions || [];
                    log(`ğŸ“Š ç²å–åˆ° ${sessions.length} å€‹æœƒè©±`);
                    
                    document.getElementById('api-results').innerHTML = `
                        <h3>APIæ¸¬è©¦çµæœï¼š</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    log(`âŒ APIèª¿ç”¨å¤±æ•—: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ ç¶²çµ¡è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
                log(`éŒ¯èª¤è©³æƒ…: ${error.stack}`, 'error');
            }
        }
        
        async function testGetChatStats() {
            log('é–‹å§‹æ¸¬è©¦ç²å–çµ±è¨ˆæ•¸æ“šAPI...');
            
            const adminToken = localStorage.getItem('admin_access_token');
            if (!adminToken) {
                log('âŒ æ²’æœ‰ç®¡ç†å“¡Tokenï¼Œç„¡æ³•æ¸¬è©¦', 'error');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const testURL = `${API_BASE_URL}/admin/chat/stats?startDate=${today}&endDate=${today}`;
            log(`æ¸¬è©¦URL: ${testURL}`);
            
            try {
                const response = await fetch(testURL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`éŸ¿æ‡‰ç‹€æ…‹: ${response.status}`);
                const data = await response.json();
                log(`éŸ¿æ‡‰æ•¸æ“š: ${JSON.stringify(data, null, 2)}`);
                
                if (response.ok && data.success) {
                    log('âœ… ç²å–çµ±è¨ˆæ•¸æ“šAPIèª¿ç”¨æˆåŠŸ', 'success');
                } else {
                    log(`âŒ APIèª¿ç”¨å¤±æ•—: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ ç¶²çµ¡è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testWithDifferentTokens() {
            log('æ¸¬è©¦ä¸åŒTokençµ„åˆ...');
            
            const tokens = [
                localStorage.getItem('admin_access_token'),
                localStorage.getItem('auth_token'),
                'test_invalid_token',
                null
            ];
            
            for (const [index, token] of tokens.entries()) {
                log(`æ¸¬è©¦Token ${index + 1}: ${token ? token.substring(0, 20) + '...' : 'null'}`);
                
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/chat/sessions`, {
                        method: 'GET',
                        headers: {
                            ...(token && { 'Authorization': `Bearer ${token}` }),
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    log(`Token ${index + 1} éŸ¿æ‡‰ç‹€æ…‹: ${response.status}`);
                    
                    if (response.status === 401) {
                        log(`Token ${index + 1}: èªè­‰å¤±æ•—`, 'warning');
                    } else if (response.status === 403) {
                        log(`Token ${index + 1}: æ¬Šé™ä¸è¶³`, 'warning');
                    } else if (response.ok) {
                        log(`Token ${index + 1}: æˆåŠŸ`, 'success');
                    }
                    
                } catch (error) {
                    log(`Token ${index + 1} è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
                }
            }
        }
        
        function parseJWT(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }
        
        function exportDebugInfo() {
            const debugInfo = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                localStorage: {
                    admin_access_token: localStorage.getItem('admin_access_token'),
                    admin_data: localStorage.getItem('admin_data'),
                    auth_token: localStorage.getItem('auth_token')
                },
                apiBaseURL: API_BASE_URL,
                logs: debugLog.innerHTML
            };
            
            const blob = new Blob([JSON.stringify(debugInfo, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-api-debug-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // åˆå§‹åŒ–æ™‚æª¢æŸ¥ç‹€æ…‹
        window.onload = function() {
            log('èª¿è©¦å·¥å…·å·²è¼‰å…¥');
            checkAuthStatus();
        };
    </script>
</body>
</html> 