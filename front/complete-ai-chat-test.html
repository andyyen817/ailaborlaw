<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´AIèŠå¤©åŠŸèƒ½è¨ºæ–·</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .success { color: #28a745; } .error { color: #dc3545; } .warning { color: #ffc107; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0056b3; }
        .result { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .input-group { margin: 10px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, .input-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .progress { width: 100%; background: #f0f0f0; border-radius: 4px; margin: 10px 0; }
        .progress-bar { height: 20px; background: #007bff; border-radius: 4px; transition: width 0.3s; text-align: center; color: white; line-height: 20px; }
    </style>
</head>
<body>
    <h1>ğŸ¤– AIèŠå¤©åŠŸèƒ½å®Œæ•´è¨ºæ–·å·¥å…·</h1>
    
    <!-- èªè­‰æ¸¬è©¦ -->
    <div class="section">
        <h2>ğŸ” æ­¥é©Ÿ1: èªè­‰æ¸¬è©¦</h2>
        <div class="input-group">
            <label>æ¸¬è©¦ç”¨æˆ¶éƒµç®±:</label>
            <input type="email" id="testEmail" value="test@example.com">
        </div>
        <div class="input-group">
            <label>æ¸¬è©¦ç”¨æˆ¶å¯†ç¢¼:</label>
            <input type="password" id="testPassword" value="test123">
        </div>
        <button class="button" onclick="testLogin()">1. æ¸¬è©¦ç™»éŒ„</button>
        <button class="button" onclick="checkAuthStatus()">2. æª¢æŸ¥èªè­‰ç‹€æ…‹</button>
        <div id="authResult" class="result"></div>
    </div>

    <!-- æœƒè©±ç®¡ç†æ¸¬è©¦ -->
    <div class="section">
        <h2>ğŸ’¬ æ­¥é©Ÿ2: æœƒè©±ç®¡ç†æ¸¬è©¦</h2>
        <button class="button" onclick="testSessionList()">1. æ¸¬è©¦ç²å–æœƒè©±åˆ—è¡¨</button>
        <button class="button" onclick="testCreateSession()">2. æ¸¬è©¦å‰µå»ºæœƒè©±</button>
        <button class="button" onclick="testSessionDetails()">3. æ¸¬è©¦ç²å–æœƒè©±è©³æƒ…</button>
        <div id="sessionResult" class="result"></div>
    </div>

    <!-- æ¶ˆæ¯ç™¼é€æ¸¬è©¦ -->
    <div class="section">
        <h2>ğŸš€ æ­¥é©Ÿ3: æ¶ˆæ¯ç™¼é€æ¸¬è©¦</h2>
        <div class="input-group">
            <label>æ¸¬è©¦æ¶ˆæ¯å…§å®¹:</label>
            <textarea id="testMessage" rows="3">è«‹å•åŠ ç­è²»å¦‚ä½•è¨ˆç®—ï¼Ÿ</textarea>
        </div>
        <button class="button" onclick="testSendMessage()">ç™¼é€æ¸¬è©¦æ¶ˆæ¯</button>
        <div id="messageResult" class="result"></div>
    </div>

    <!-- å‰ç«¯é é¢æ¸¬è©¦ -->
    <div class="section">
        <h2>ğŸ–¥ï¸ æ­¥é©Ÿ4: å‰ç«¯é é¢æ¸¬è©¦</h2>
        <button class="button" onclick="testHomePageAPI()">æ¸¬è©¦é¦–é "æœ€è¿‘è«®è©¢"</button>
        <button class="button" onclick="testMobilePageAPI()">æ¸¬è©¦ç§»å‹•ç«¯"æœ€è¿‘è«®è©¢"</button>
        <button class="button" onclick="testChatPageAPI()">æ¸¬è©¦èŠå¤©é é¢API</button>
        <div id="frontendResult" class="result"></div>
    </div>

    <!-- ç¶œåˆæ¸¬è©¦ -->
    <div class="section">
        <h2>ğŸ¯ æ­¥é©Ÿ5: å®Œæ•´æµç¨‹æ¸¬è©¦</h2>
        <div class="progress">
            <div id="progressBar" class="progress-bar" style="width: 0%">0%</div>
        </div>
        <button class="button" onclick="runCompleteTest()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹</button>
        <div id="completeResult" class="result"></div>
    </div>

    <script>
        const API_BASE_URL = '/api/v1';
        let currentToken = '';
        let currentSessionId = '';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ğŸ“';
            return `[${timestamp}] ${prefix} ${message}`;
        }
        
        async function apiRequest(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (currentToken) {
                headers['Authorization'] = currentToken.startsWith('Bearer ') ? currentToken : `Bearer ${currentToken}`;
            }
            
            const response = await fetch(`${API_BASE_URL}${url}`, {
                ...options,
                headers
            });
            
            const data = await response.json();
            
            return {
                response,
                data,
                ok: response.ok,
                status: response.status
            };
        }
        
        async function testLogin() {
            const resultEl = document.getElementById('authResult');
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            resultEl.textContent = log('æ­£åœ¨æ¸¬è©¦ç™»éŒ„...');
            
            try {
                const result = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                
                resultEl.textContent = log('ç™»éŒ„è«‹æ±‚å®Œæˆ') + '\n\n' +
                    `ç‹€æ…‹ç¢¼: ${result.status}\n` +
                    `éŸ¿æ‡‰: ${JSON.stringify(result.data, null, 2)}`;
                
                if (result.ok && result.data.success && result.data.data.token) {
                    currentToken = result.data.data.token;
                    localStorage.setItem('auth_token', currentToken);
                    if (result.data.data.user) {
                        localStorage.setItem('auth_user', JSON.stringify(result.data.data.user));
                        if (result.data.data.user.id) {
                            localStorage.setItem('auth_user_id', result.data.data.user.id);
                        }
                    }
                    resultEl.textContent += '\n\n' + log('ç™»éŒ„æˆåŠŸï¼Tokenå·²ä¿å­˜', 'success');
                } else {
                    resultEl.textContent += '\n\n' + log(`ç™»éŒ„å¤±æ•—ï¼š${result.data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                resultEl.textContent = log(`ç¶²çµ¡éŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function checkAuthStatus() {
            const resultEl = document.getElementById('authResult');
            
            currentToken = localStorage.getItem('auth_token') || currentToken;
            
            if (!currentToken) {
                resultEl.textContent = log('æœªæ‰¾åˆ°èªè­‰Token', 'error');
                return;
            }
            
            resultEl.textContent = log('æª¢æŸ¥èªè­‰ç‹€æ…‹...');
            
            try {
                const result = await apiRequest('/users/me');
                
                resultEl.textContent = log('èªè­‰æª¢æŸ¥å®Œæˆ') + '\n\n' +
                    `Token: ${currentToken.substring(0, 20)}...\n` +
                    `ç‹€æ…‹ç¢¼: ${result.status}\n` +
                    `éŸ¿æ‡‰: ${JSON.stringify(result.data, null, 2)}`;
                
                if (result.ok && result.data.success) {
                    resultEl.textContent += '\n\n' + log('èªè­‰æœ‰æ•ˆï¼', 'success');
                } else {
                    resultEl.textContent += '\n\n' + log(`èªè­‰å¤±æ•—ï¼š${result.data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                resultEl.textContent = log(`èªè­‰æª¢æŸ¥éŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function testSessionList() {
            const resultEl = document.getElementById('sessionResult');
            
            if (!currentToken) {
                resultEl.textContent = log('è«‹å…ˆå®Œæˆç™»éŒ„', 'error');
                return;
            }
            
            resultEl.textContent = log('æ¸¬è©¦ç²å–æœƒè©±åˆ—è¡¨...');
            
            try {
                const result = await apiRequest('/chat/sessions', {
                    method: 'GET'
                });
                
                resultEl.textContent = log('æœƒè©±åˆ—è¡¨è«‹æ±‚å®Œæˆ') + '\n\n' +
                    `ç‹€æ…‹ç¢¼: ${result.status}\n` +
                    `éŸ¿æ‡‰: ${JSON.stringify(result.data, null, 2)}`;
                
                if (result.ok && result.data.success) {
                    resultEl.textContent += '\n\n' + log('æœƒè©±åˆ—è¡¨ç²å–æˆåŠŸï¼', 'success');
                    if (result.data.data.sessions && result.data.data.sessions.length > 0) {
                        currentSessionId = result.data.data.sessions[0].sessionId;
                        resultEl.textContent += '\n' + log(`å·²é¸æ“‡ç¬¬ä¸€å€‹æœƒè©±ID: ${currentSessionId}`);
                    }
                } else {
                    resultEl.textContent += '\n\n' + log(`æœƒè©±åˆ—è¡¨ç²å–å¤±æ•—ï¼š${result.data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                resultEl.textContent = log(`ç¶²çµ¡éŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function testCreateSession() {
            const resultEl = document.getElementById('sessionResult');
            
            if (!currentToken) {
                resultEl.textContent = log('è«‹å…ˆå®Œæˆç™»éŒ„', 'error');
                return;
            }
            
            resultEl.textContent = log('æ¸¬è©¦å‰µå»ºæ–°æœƒè©±...');
            
            try {
                const result = await apiRequest('/chat/sessions', {
                    method: 'POST',
                    body: JSON.stringify({ title: 'è¨ºæ–·æ¸¬è©¦æœƒè©±' })
                });
                
                resultEl.textContent = log('å‰µå»ºæœƒè©±è«‹æ±‚å®Œæˆ') + '\n\n' +
                    `ç‹€æ…‹ç¢¼: ${result.status}\n` +
                    `éŸ¿æ‡‰: ${JSON.stringify(result.data, null, 2)}`;
                
                if (result.ok && result.data.success) {
                    currentSessionId = result.data.data.sessionId;
                    resultEl.textContent += '\n\n' + log(`æœƒè©±å‰µå»ºæˆåŠŸï¼ID: ${currentSessionId}`, 'success');
                } else {
                    resultEl.textContent += '\n\n' + log(`æœƒè©±å‰µå»ºå¤±æ•—ï¼š${result.data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                resultEl.textContent = log(`ç¶²çµ¡éŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function testSessionDetails() {
            const resultEl = document.getElementById('sessionResult');
            
            if (!currentToken || !currentSessionId) {
                resultEl.textContent = log('è«‹å…ˆå‰µå»ºæœƒè©±æˆ–ç²å–æœƒè©±åˆ—è¡¨', 'error');
                return;
            }
            
            resultEl.textContent = log('æ¸¬è©¦ç²å–æœƒè©±è©³æƒ…...');
            
            try {
                const result = await apiRequest(`/chat/sessions/${currentSessionId}`, {
                    method: 'GET'
                });
                
                resultEl.textContent = log('æœƒè©±è©³æƒ…è«‹æ±‚å®Œæˆ') + '\n\n' +
                    `æœƒè©±ID: ${currentSessionId}\n` +
                    `ç‹€æ…‹ç¢¼: ${result.status}\n` +
                    `éŸ¿æ‡‰: ${JSON.stringify(result.data, null, 2)}`;
                
                if (result.ok && result.data.success) {
                    resultEl.textContent += '\n\n' + log('æœƒè©±è©³æƒ…ç²å–æˆåŠŸï¼', 'success');
                } else {
                    resultEl.textContent += '\n\n' + log(`æœƒè©±è©³æƒ…ç²å–å¤±æ•—ï¼š${result.data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                resultEl.textContent = log(`ç¶²çµ¡éŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function testSendMessage() {
            const resultEl = document.getElementById('messageResult');
            const message = document.getElementById('testMessage').value;
            
            if (!currentToken || !currentSessionId) {
                resultEl.textContent = log('è«‹å…ˆå‰µå»ºæœƒè©±', 'error');
                return;
            }
            
            if (!message.trim()) {
                resultEl.textContent = log('è«‹è¼¸å…¥æ¸¬è©¦æ¶ˆæ¯', 'error');
                return;
            }
            
            resultEl.textContent = log('æ¸¬è©¦ç™¼é€æ¶ˆæ¯...');
            
            try {
                const result = await apiRequest(`/chat/sessions/${currentSessionId}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({
                        content: message,
                        messageType: 'question'
                    })
                });
                
                resultEl.textContent = log('ç™¼é€æ¶ˆæ¯è«‹æ±‚å®Œæˆ') + '\n\n' +
                    `æœƒè©±ID: ${currentSessionId}\n` +
                    `æ¶ˆæ¯å…§å®¹: ${message}\n` +
                    `ç‹€æ…‹ç¢¼: ${result.status}\n` +
                    `éŸ¿æ‡‰: ${JSON.stringify(result.data, null, 2)}`;
                
                if (result.ok && result.data.success) {
                    resultEl.textContent += '\n\n' + log('æ¶ˆæ¯ç™¼é€æˆåŠŸï¼', 'success');
                    if (result.data.data.aiResponse) {
                        const aiContent = result.data.data.aiResponse.content;
                        const preview = aiContent.length > 200 ? aiContent.substring(0, 200) + '...' : aiContent;
                        resultEl.textContent += '\n\nAIå›å¾©é è¦½:\n' + preview;
                    }
                } else {
                    resultEl.textContent += '\n\n' + log(`æ¶ˆæ¯ç™¼é€å¤±æ•—ï¼š${result.data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                resultEl.textContent = log(`ç¶²çµ¡éŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function testHomePageAPI() {
            const resultEl = document.getElementById('frontendResult');
            
            if (!currentToken) {
                resultEl.textContent = log('è«‹å…ˆå®Œæˆç™»éŒ„', 'error');
                return;
            }
            
            resultEl.textContent = log('æ¸¬è©¦é¦–é "æœ€è¿‘è«®è©¢"API...');
            
            try {
                // æ¨¡æ“¬é¦–é çš„APIèª¿ç”¨
                const result = await apiRequest('/chat/sessions', {
                    method: 'GET'
                });
                
                resultEl.textContent = log('é¦–é APIæ¸¬è©¦å®Œæˆ') + '\n\n' +
                    `APIç«¯é»: /chat/sessions\n` +
                    `ç‹€æ…‹ç¢¼: ${result.status}\n` +
                    `éŸ¿æ‡‰: ${JSON.stringify(result.data, null, 2)}`;
                
                if (result.ok && result.data.success) {
                    resultEl.textContent += '\n\n' + log('é¦–é APIæ­£å¸¸ï¼', 'success');
                    if (result.data.data.sessions) {
                        resultEl.textContent += '\n' + log(`æ‰¾åˆ° ${result.data.data.sessions.length} å€‹æœƒè©±`);
                    }
                } else {
                    resultEl.textContent += '\n\n' + log(`é¦–é APIå¤±æ•—ï¼š${result.data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                resultEl.textContent = log(`é¦–é APIéŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function testMobilePageAPI() {
            const resultEl = document.getElementById('frontendResult');
            
            if (!currentToken) {
                resultEl.textContent = log('è«‹å…ˆå®Œæˆç™»éŒ„', 'error');
                return;
            }
            
            resultEl.textContent = log('æ¸¬è©¦ç§»å‹•ç«¯"æœ€è¿‘è«®è©¢"API...');
            
            try {
                // æ¨¡æ“¬ç§»å‹•ç«¯çš„APIèª¿ç”¨ï¼ˆèˆ‡é¦–é ç›¸åŒï¼‰
                const result = await apiRequest('/chat/sessions', {
                    method: 'GET'
                });
                
                resultEl.textContent = log('ç§»å‹•ç«¯APIæ¸¬è©¦å®Œæˆ') + '\n\n' +
                    `APIç«¯é»: /chat/sessions\n` +
                    `ç‹€æ…‹ç¢¼: ${result.status}\n` +
                    `éŸ¿æ‡‰: ${JSON.stringify(result.data, null, 2)}`;
                
                if (result.ok && result.data.success) {
                    resultEl.textContent += '\n\n' + log('ç§»å‹•ç«¯APIæ­£å¸¸ï¼', 'success');
                } else {
                    resultEl.textContent += '\n\n' + log(`ç§»å‹•ç«¯APIå¤±æ•—ï¼š${result.data.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            } catch (error) {
                resultEl.textContent = log(`ç§»å‹•ç«¯APIéŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function testChatPageAPI() {
            const resultEl = document.getElementById('frontendResult');
            
            if (!currentToken) {
                resultEl.textContent = log('è«‹å…ˆå®Œæˆç™»éŒ„', 'error');
                return;
            }
            
            resultEl.textContent = log('æ¸¬è©¦èŠå¤©é é¢API...');
            
            try {
                // æ¨¡æ“¬èŠå¤©é é¢çš„æ‰€æœ‰APIèª¿ç”¨
                const tests = [
                    { name: 'ç²å–æœƒè©±åˆ—è¡¨', endpoint: '/chat/sessions' },
                    { name: 'å‰µå»ºæœƒè©±', endpoint: '/chat/sessions', method: 'POST', body: { title: 'æ¸¬è©¦æœƒè©±' } }
                ];
                
                let allResults = '';
                let allPassed = true;
                
                for (const test of tests) {
                    try {
                        const result = await apiRequest(test.endpoint, {
                            method: test.method || 'GET',
                            body: test.body ? JSON.stringify(test.body) : undefined
                        });
                        
                        allResults += `\n${test.name}: ${result.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`;
                        if (!result.ok) {
                            allPassed = false;
                            allResults += ` - ${result.data.message}`;
                        }
                    } catch (error) {
                        allResults += `\n${test.name}: âŒ éŒ¯èª¤ - ${error.message}`;
                        allPassed = false;
                    }
                }
                
                resultEl.textContent = log('èŠå¤©é é¢APIæ¸¬è©¦å®Œæˆ') + allResults + '\n\n' +
                    log(allPassed ? 'æ‰€æœ‰èŠå¤©é é¢APIæ­£å¸¸ï¼' : 'éƒ¨åˆ†èŠå¤©é é¢APIå­˜åœ¨å•é¡Œ', allPassed ? 'success' : 'error');
                
            } catch (error) {
                resultEl.textContent = log(`èŠå¤©é é¢APIéŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }
        
        async function runCompleteTest() {
            const progressBar = document.getElementById('progressBar');
            const resultEl = document.getElementById('completeResult');
            
            resultEl.textContent = log('é–‹å§‹åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹...');
            
            const steps = [
                { name: 'ç™»éŒ„æ¸¬è©¦', func: testLogin },
                { name: 'èªè­‰æª¢æŸ¥', func: checkAuthStatus },
                { name: 'æœƒè©±åˆ—è¡¨', func: testSessionList },
                { name: 'å‰µå»ºæœƒè©±', func: testCreateSession },
                { name: 'ç™¼é€æ¶ˆæ¯', func: testSendMessage },
                { name: 'é¦–é API', func: testHomePageAPI }
            ];
            
            let passedTests = 0;
            
            for (let i = 0; i < steps.length; i++) {
                const progress = ((i + 1) / steps.length) * 100;
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${Math.round(progress)}%`;
                
                try {
                    await steps[i].func();
                    passedTests++;
                    resultEl.textContent += '\n' + log(`${steps[i].name}: å®Œæˆ`, 'success');
                } catch (error) {
                    resultEl.textContent += '\n' + log(`${steps[i].name}: å¤±æ•— - ${error.message}`, 'error');
                }
                
                // æ·»åŠ å»¶é²ä»¥ä¾¿è§€å¯Ÿé€²åº¦
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const finalResult = passedTests === steps.length ? 
                `ğŸ‰ å®Œæ•´æ¸¬è©¦å®Œæˆï¼æ‰€æœ‰ ${steps.length} é …æ¸¬è©¦é€šé` :
                `âš ï¸ æ¸¬è©¦å®Œæˆï¼š${passedTests}/${steps.length} é …é€šé`;
            
            resultEl.textContent += '\n\n' + log(finalResult, passedTests === steps.length ? 'success' : 'warning');
        }
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥èªè­‰ç‹€æ…‹
        window.addEventListener('load', function() {
            const savedToken = localStorage.getItem('auth_token');
            if (savedToken) {
                currentToken = savedToken;
                document.getElementById('authResult').textContent = log('æª¢æ¸¬åˆ°å·²ä¿å­˜çš„Tokenï¼Œå¯ç›´æ¥é€²è¡Œæ¸¬è©¦');
            }
        });
    </script>
</body>
</html> 