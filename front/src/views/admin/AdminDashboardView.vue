<template>
  <div class="p-0"> <!-- AdminLayout å·²ç»æœ‰ p-6ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ä¸º p-0 æˆ–æ ¹æ®éœ€è¦è°ƒæ•´ -->
    <!-- ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-6">
      <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-blue-500 text-white mr-4">
            <!-- Heroicon - outline - users -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-600">æ€»ç”¨æˆ·æ•°</p>
            <p class="text-2xl font-semibold text-gray-800">{{ stats.totalUsers }}</p>
          </div>
        </div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-green-500 text-white mr-4">
            <!-- Heroicon - outline - user-plus -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766Z" />
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-600">ä»Šæ—¥æ–°å¢</p>
            <p class="text-2xl font-semibold text-gray-800">{{ stats.newUsersToday }}</p>
          </div>
        </div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-yellow-500 text-white mr-4">
            <!-- Heroicon - outline - user-group (for active users) -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-600">æ´»è·ƒç”¨æˆ·</p>
            <p class="text-2xl font-semibold text-gray-800">{{ stats.activeUsers }}</p>
          </div>
        </div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-purple-500 text-white mr-4">
            <!-- Heroicon - outline - chat-bubble-left-ellipsis -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-3.861 8.25-8.625 8.25S3.75 16.556 3.75 12S7.611 3.75 12.375 3.75S21 7.444 21 12Z" />
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-600">æ€»å’¨è¯¢é‡ (AI)</p>
            <p class="text-2xl font-semibold text-gray-800">{{ stats.totalAIConsultations }}</p>
          </div>
        </div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition-shadow">
        <div class="flex items-center">
          <div class="p-3 rounded-full bg-red-500 text-white mr-4">
            <!-- Heroicon - outline - document-magnifying-glass -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5 4.5H6.375c-.621 0-1.125-.504-1.125-1.125v-6.75c0-.621.504-1.125 1.125-1.125h9.75c.621 0 1.125.504 1.125 1.125v6.75e-3M6.375 17.25H12" />
            </svg>
          </div>
          <div>
            <p class="text-sm text-gray-600">å¾…å¤„ç†ä¸“å®¶å’¨è¯¢</p>
            <p class="text-2xl font-semibold text-gray-800">{{ stats.pendingExpertConsultations }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- åˆ—è¡¨åŒºåŸŸ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- æœ€æ–°æ³¨å†Œç”¨æˆ· -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">æœ€æ–°æ³¨å†Œç”¨æˆ·</h3>
        <ul v-if="latestUsers.length > 0" class="divide-y divide-gray-200">
          <li v-for="user in latestUsers" :key="user.id" class="py-3 flex justify-between items-center">
            <div>
              <p class="text-sm font-medium text-gray-800">{{ user.name || user.email }}</p>
              <p class="text-xs text-gray-500">æ³¨å†Œäº: {{ formatDate(user.registrationDate) }}</p>
            </div>
            <span :class="['px-2 py-0.5 text-xs font-semibold rounded-full', userStatusClass(user.status)]">
              {{ userStatusText(user.status) }}
            </span>
          </li>
        </ul>
        <p v-else class="text-sm text-gray-500">æš‚æ— æ–°ç”¨æˆ·æ•°æ®ã€‚</p>
      </div>

      <!-- æœ€æ–°å’¨è¯¢è¯·æ±‚ (ä¸“å®¶) -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">æœ€æ–°ä¸“å®¶å’¨è¯¢è¯·æ±‚</h3>
        <ul v-if="latestConsultations.length > 0" class="divide-y divide-gray-200">
          <li v-for="consultation in latestConsultations" :key="consultation.id" class="py-3">
            <div class="flex justify-between items-center mb-1">
              <p class="text-sm font-medium text-gray-800">{{ consultation.name }} <span class="text-xs text-gray-500">({{ consultation.contact }})</span></p>
              <span :class="['px-2 py-0.5 text-xs font-semibold rounded-full', expertConsultationStatusClass(consultation.status)]">
                {{ expertConsultationStatusText(consultation.status) }}
              </span>
            </div>
            <p class="text-xs text-gray-500 truncate" :title="consultation.issueSummary">
              é—®é¢˜: {{ consultation.issueSummary }}
            </p>
            <p class="text-xs text-gray-400 mt-1">æäº¤äº: {{ formatDate(consultation.submittedAt) }}</p>
          </li>
        </ul>
        <p v-else class="text-sm text-gray-500">æš‚æ— æ–°çš„ä¸“å®¶å’¨è¯¢è¯·æ±‚ã€‚</p>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, computed } from 'vue';
import { mockUserStore } from '@/store/mockUserStore';
import adminChatService from '@/services/adminChatService';
import expertConsultationService from '@/services/expertConsultationService';
import adminAuthService from '@/services/adminAuth';

const stats = reactive({
  totalUsers: 0,
  newUsersToday: 0,
  activeUsers: 0,
  totalAIConsultations: 0, // éœ€è¦ä»ç”¨æˆ·æ•°æ®ç´¯è®¡
  pendingExpertConsultations: 0,
});

const latestUsers = ref([]);
const latestConsultations = ref([]);

const formatDate = (dateString) => {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
};

const userStatusText = (status) => {
  const map = { active: 'æ´»è·ƒ', pending: 'å¾…éªŒè¯', disabled: 'ç¦ç”¨' };
  return map[status] || status;
};

const userStatusClass = (status) => {
  const map = {
    active: 'bg-green-100 text-green-700',
    pending: 'bg-yellow-100 text-yellow-700',
    disabled: 'bg-red-100 text-red-700',
  };
  return map[status] || 'bg-gray-100 text-gray-700';
};

const expertConsultationStatusText = (status) => {
  const map = { pending: 'å¾…å¤„ç†', processing: 'å¤„ç†ä¸­', completed: 'å·²è§£å†³', cancelled: 'å·²å–æ¶ˆ' };
  return map[status] || status;
};

const expertConsultationStatusClass = (status) => {
  const map = {
    pending: 'bg-yellow-100 text-yellow-700',
    processing: 'bg-blue-100 text-blue-700',
    completed: 'bg-green-100 text-green-700',
    cancelled: 'bg-gray-100 text-gray-700',
  };
  return map[status] || 'bg-gray-100 text-gray-700';
};

onMounted(async () => {
  try {
    // ä½¿ç”¨çœŸå¯¦çš„èŠå¤©çµ±è¨ˆAPI
    const today = new Date().toISOString().split('T')[0];
    const chatStats = await adminChatService.getChatStats({
      startDate: today,
      endDate: today
    });

    // æ›´æ–°èŠå¤©ç›¸é—œçµ±è¨ˆæ•¸æ“š
    if (chatStats.overview) {
      stats.totalAIConsultations = chatStats.overview.totalMessages || 0;
      stats.activeUsers = chatStats.overview.totalUsers || 0;
    }

    console.log('âœ… ç®¡ç†å¾Œå°èŠå¤©çµ±è¨ˆæ•¸æ“šåŠ è¼‰æˆåŠŸ:', chatStats);

  } catch (error) {
    console.error('âŒ åŠ è¼‰èŠå¤©çµ±è¨ˆæ•¸æ“šå¤±æ•—:', error);
    // å¦‚æœAPIå¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨mockæ•¸æ“š
  }

  // åŠ è½½ç”¨æˆ·æ•°æ®å’Œå…¶ä»–ç»Ÿè®¡ï¼ˆä¿æŒç¾æœ‰é‚è¼¯ï¼‰
  try {
    const { users: allUsers, total } = await mockUserStore.getUsers({ limit: 10000 });
    stats.totalUsers = total;

    const today = new Date().toISOString().split('T')[0];
    stats.newUsersToday = allUsers.filter(u => u.registrationDate === today).length;
    
    // åªæœ‰åœ¨APIå¤±æ•—æ™‚æ‰ä½¿ç”¨mockæ•¸æ“šæ›´æ–°activeUsers
    if (stats.activeUsers === 0) {
      stats.activeUsers = allUsers.filter(u => u.status === 'active').length;
    }

    latestUsers.value = [...allUsers]
      .sort((a, b) => new Date(b.registrationDate) - new Date(a.registrationDate))
      .slice(0, 5);

  } catch (error) {
    console.error('âŒ åŠ è¼‰ç”¨æˆ¶æ•¸æ“šå¤±æ•—:', error);
  }

  // ğŸš€ ä½¿ç”¨çœŸå¯¦APIåŠ è½½ä¸“å®¶å’¨è¯¢æ•°æ®
  try {
    console.log('ğŸš€ æ­£åœ¨å¾APIåŠ è¼‰å°ˆå®¶è«®è©¢çµ±è¨ˆæ•¸æ“š...');
    
    const adminToken = adminAuthService.getAccessToken();
    if (!adminToken) {
      console.warn('âš ï¸ æœªæ‰¾åˆ°ç®¡ç†å“¡tokenï¼Œè¯·å…ˆç™»å½•ç®¡ç†åå°');
      throw new Error('ç®¡ç†å“¡èªè­‰å¤±æ•—');
    }
    
    // ç²å–å°ˆå®¶è«®è©¢çµ±è¨ˆæ•¸æ“š
    const consultationsResponse = await expertConsultationService.getConsultationsWithFallback({
      isAdmin: true,
      adminToken: adminToken,
      page: 1,
      limit: 1000
    });
    
    if (consultationsResponse.success && consultationsResponse.data) {
      const allConsultations = consultationsResponse.data.consultations || [];
      console.log(`âœ… æˆåŠŸç²å– ${allConsultations.length} æ¢å°ˆå®¶è«®è©¢æ•¸æ“š`);
      
      // è¨ˆç®—å¾…è™•ç†æ•¸é‡
      stats.pendingExpertConsultations = allConsultations.filter(c => c.status === 'pending').length;
      
      // æº–å‚™æœ€æ–°è«®è©¢åˆ—è¡¨ï¼ˆæ ¼å¼è½‰æ›ï¼‰
      latestConsultations.value = allConsultations
        .sort((a, b) => new Date(b.created_at || b.createdAt) - new Date(a.created_at || a.createdAt))
        .slice(0, 5)
        .map(consultation => ({
          id: consultation.id || consultation._id,
          name: consultation.name,
          contact: consultation.phone || consultation.email || consultation.line_id || consultation.lineId,
          issueSummary: consultation.details?.substring(0, 50) + (consultation.details?.length > 50 ? '...' : '') || 'ç„¡è©³æƒ…',
          status: consultation.status,
          submittedAt: consultation.created_at || consultation.createdAt
        }));
        
      console.log('âœ… å°ˆå®¶è«®è©¢çµ±è¨ˆæ•¸æ“šè™•ç†å®Œæˆ');
      
    } else {
      throw new Error(consultationsResponse.message || 'APIéŸ¿æ‡‰æ ¼å¼éŒ¯èª¤');
    }
      
  } catch (apiError) {
    console.error("âŒ APIåŠ è¼‰å°ˆå®¶è«®è©¢æ•¸æ“šå¤±æ•—:", apiError);
    
    // è®¾ç½®é»˜è®¤ç©ºå€¼ï¼Œä¸å†ä½¿ç”¨localStorageé™çº§
    latestConsultations.value = [];
    stats.pendingExpertConsultations = 0;
    
    console.warn('ğŸ”„ ä¸“å®¶å’¨è¯¢æ•°æ®åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºç©ºæ•°æ®ã€‚è¯·ç¡®ä¿å·²æ­£ç¡®ç™»å½•ç®¡ç†åå°ã€‚');
  }
});

</script>

<style scoped>
/* Tailwind handles most styles */
</style>
