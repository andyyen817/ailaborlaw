<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AI 勞基法顧問 API 測試平台 v2.2 - 新增郵箱驗證功能</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f7f9fc;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            flex: 1;
            min-width: 300px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            max-height: 300px;
        }
        .success {
            color: #27ae60;
        }
        .error {
            color: #e74c3c;
        }
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .nav button {
            background-color: #95a5a6;
            flex: 1;
        }
        .nav button.active {
            background-color: #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>AI 勞基法顧問 API 測試平台 v2.2 - 新增郵箱驗證功能</h1>
    <p>此頁面用於測試後端 API 功能，可以幫助前端開發人員了解 API 的使用方式。</p>
    
    <div style="background: #ffeb3b; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #f57c00;">
        <strong>⚠️ 重要提示：</strong>如果遇到API測試問題，請嘗試：
        <br>1. 按 <kbd>Ctrl+F5</kbd> (Windows) 或 <kbd>Cmd+Shift+R</kbd> (Mac) 強制刷新
        <br>2. 清除瀏覽器快取後重新載入頁面
        <br>3. 開啟開發者工具查看控制台調試信息
    </div>

    <div class="nav">
        <button class="tab-btn active" data-tab="auth">認證 API</button>
        <button class="tab-btn" data-tab="email">📧 郵箱驗證 API</button>
        <button class="tab-btn" data-tab="user">用戶資料 API</button>
        <button class="tab-btn" data-tab="chat">聊天模組 API</button>
        <button class="tab-btn" data-tab="expert">專家諮詢 API</button>
        <button class="tab-btn" data-tab="advisor">劳资顾问管理 API</button>
        <button class="tab-btn" data-tab="invite">邀請管理 API</button>
        <button class="tab-btn" data-tab="query">咨詢次數 API</button>
        <button class="tab-btn" data-tab="admin">管理員 API</button>
        <button class="tab-btn" data-tab="test">權限測試</button>
        <button class="tab-btn" data-tab="debug">調試信息</button>
    </div>

    <div id="auth" class="tab-content active">
        <div class="container">
            <div class="card">
                <h2>用戶註冊</h2>
                <div class="form-group">
                    <label for="register-name">姓名</label>
                    <input type="text" id="register-name" placeholder="請輸入姓名">
                </div>
                <div class="form-group">
                    <label for="register-email">電子郵箱</label>
                    <input type="email" id="register-email" placeholder="請輸入電子郵箱">
                </div>
                <div class="form-group">
                    <label for="register-password">密碼</label>
                    <input type="password" id="register-password" placeholder="請輸入密碼">
                </div>
                <div class="form-group">
                    <label for="register-userType">用戶類型</label>
                    <select id="register-userType">
                        <option value="employee">員工</option>
                        <option value="employer">雇主</option>
                        <option value="hr">人資</option>
                        <option value="admin">管理員</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="register-industry">行業</label>
                    <input type="text" id="register-industry" placeholder="請輸入您的行業">
                </div>
                <div class="form-group">
                    <label for="register-position">職業</label>
                    <input type="text" id="register-position" placeholder="請輸入您的職業">
                </div>
                <div class="form-group">
                    <label for="register-inviteCode">邀請碼</label>
                    <input type="text" id="register-inviteCode" placeholder="請輸入邀請碼(選填)">
                </div>
                <button id="register-btn">註冊</button>
                <div id="register-result" class="result"></div>
            </div>

            <div class="card">
                <h2>用戶登入</h2>
                <div class="form-group">
                    <label for="login-email">電子郵箱</label>
                    <input type="email" id="login-email" placeholder="請輸入電子郵箱">
                </div>
                <div class="form-group">
                    <label for="login-password">密碼</label>
                    <input type="password" id="login-password" placeholder="請輸入密碼">
                </div>
                <button id="login-btn">登入</button>
                <div id="login-result" class="result"></div>
                
                <h3 style="margin-top: 20px;">快速登入選項</h3>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="admin-quick-login" style="flex: 1; background-color: #e74c3c;">超級管理員<br>(admin)</button>
                    <button id="user-quick-login" style="flex: 1; background-color: #27ae60;">普通管理員<br>(newadmin)</button>
                </div>
                <div id="quick-login-result" class="result"></div>
            </div>
        </div>
    </div>

    <!-- 郵箱驗證 API Tab -->
    <div id="email" class="tab-content">
        <h2>📧 郵箱驗證 API 測試</h2>
        <p>測試完整的郵箱驗證系統，包括註冊驗證、密碼重置、邀請註冊和管理後台功能</p>
        
        <div style="background: #e8f5e8; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #27ae60;">
            <strong>💡 提示：</strong>
            <br>• 所有驗證碼為6位數字，有效期15分鐘
            <br>• 防刷機制：60秒內只能發送1次，24小時內最多5次
            <br>• 管理後台功能需要管理員權限 (admin 角色)
            <br>• 支持三種郵件類型：註冊驗證、密碼重置、邀請確認
        </div>
        
        <!-- 用戶端API測試 -->
        <h3 style="margin-top: 30px; color: #2980b9;">👤 用戶端郵箱驗證功能 (7個API)</h3>
        
        <div class="container">
            <!-- 註冊郵箱驗證 -->
            <div class="card">
                <h3>1. 📝 註冊郵箱驗證</h3>
                
                <!-- 發送註冊驗證碼 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>📤 發送註冊驗證碼</h4>
                    <div class="form-group">
                        <label for="send-email">電子郵箱</label>
                        <input type="email" id="send-email" placeholder="請輸入要驗證的郵箱">
                    </div>
                    <button id="send-email-verification-btn" style="background-color: #3498db;">發送驗證碼</button>
                    <div id="send-email-verification-result" class="result"></div>
                </div>

                <!-- 驗證註冊郵箱 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>✅ 驗證註冊郵箱</h4>
                    <div class="form-group">
                        <label for="verify-email">電子郵箱</label>
                        <input type="email" id="verify-email" placeholder="請輸入郵箱">
                    </div>
                    <div class="form-group">
                        <label for="verify-code">驗證碼</label>
                        <input type="text" id="verify-code" placeholder="請輸入6位數字驗證碼" maxlength="6">
                    </div>
                    <button id="verify-email-btn" style="background-color: #27ae60;">驗證郵箱</button>
                    <div id="verify-email-result" class="result"></div>
                </div>

                <!-- 重發驗證碼 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>🔄 重發驗證碼</h4>
                    <div class="form-group">
                        <label for="resend-email">電子郵箱</label>
                        <input type="email" id="resend-email" placeholder="請輸入郵箱">
                    </div>
                    <button id="resend-verification-btn" style="background-color: #f39c12;">重發驗證碼</button>
                    <div id="resend-verification-result" class="result"></div>
                </div>

                <!-- 檢查驗證狀態 -->
                <div>
                    <h4>🔍 檢查郵箱驗證狀態</h4>
                    <div class="form-group">
                        <label for="status-email">電子郵箱</label>
                        <input type="email" id="status-email" placeholder="請輸入郵箱">
                    </div>
                    <button id="get-email-status-btn" style="background-color: #95a5a6;">檢查狀態</button>
                    <div id="get-email-status-result" class="result"></div>
                </div>
            </div>

            <!-- 密碼重置 -->
            <div class="card">
                <h3>2. 🔐 密碼重置</h3>
                
                <!-- 忘記密碼 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>📧 發送密碼重置驗證碼</h4>
                    <div class="form-group">
                        <label for="forgot-email">電子郵箱</label>
                        <input type="email" id="forgot-email" placeholder="請輸入註冊郵箱">
                    </div>
                    <button id="forgot-password-btn" style="background-color: #e67e22;">發送重置驗證碼</button>
                    <div id="forgot-password-result" class="result"></div>
                </div>

                <!-- 重置密碼 -->
                <div>
                    <h4>🔑 重置密碼</h4>
                    <div class="form-group">
                        <label for="reset-email">電子郵箱</label>
                        <input type="email" id="reset-email" placeholder="請輸入郵箱">
                    </div>
                    <div class="form-group">
                        <label for="reset-code">驗證碼</label>
                        <input type="text" id="reset-code" placeholder="請輸入6位數字驗證碼" maxlength="6">
                    </div>
                    <div class="form-group">
                        <label for="new-password">新密碼</label>
                        <input type="password" id="new-password" placeholder="請輸入新密碼(至少8位，包含大小寫字母和數字)">
                    </div>
                    <button id="reset-password-btn" style="background-color: #e74c3c;">重置密碼</button>
                    <div id="reset-password-result" class="result"></div>
                </div>
            </div>

            <!-- ⭐ 一步式驗證並註冊 (新增功能) -->
            <div class="card">
                <h3>4. ⭐ 一步式驗證並註冊</h3>
                
                <div style="background: #d1ecf1; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #17a2b8;">
                    <strong>🆕 新功能：</strong>一次性完成郵箱驗證+用戶註冊，優化前端單頁面體驗
                </div>

                <!-- 清理測試數據按鈕 -->
                <div style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #ffc107;">
                    <strong>🧪 測試工具：</strong>
                    <button onclick="clearTestData()" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                        🗑️ 清理測試數據
                    </button>
                    <small style="display: block; margin-top: 5px; color: #6c757d;">
                        清理指定郵箱的用戶數據和驗證碼，方便重複測試
                    </small>
                </div>

                <div class="form-group">
                    <label for="one-step-email">電子郵箱</label>
                    <input type="email" id="one-step-email" placeholder="請輸入郵箱">
                </div>
                <div class="form-group">
                    <label for="one-step-verification-code">郵箱驗證碼</label>
                    <input type="text" id="one-step-verification-code" placeholder="請輸入6位數字驗證碼" maxlength="6">
                </div>
                <div class="form-group">
                    <label for="one-step-name">姓名</label>
                    <input type="text" id="one-step-name" placeholder="請輸入真實姓名">
                </div>
                <div class="form-group">
                    <label for="one-step-password">密碼</label>
                    <input type="password" id="one-step-password" placeholder="至少8位，包含字母和數字">
                </div>
                <div class="form-group">
                    <label for="one-step-industry">行業</label>
                    <select id="one-step-industry">
                        <option value="">請選擇行業</option>
                        <option value="technology">科技業</option>
                        <option value="manufacturing">製造業</option>
                        <option value="finance">金融業</option>
                        <option value="retail">零售業</option>
                        <option value="education">教育業</option>
                        <option value="healthcare">醫療業</option>
                        <option value="service">服務業</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="one-step-position">職位</label>
                    <input type="text" id="one-step-position" placeholder="請輸入職位（可選）">
                </div>
                <div class="form-group">
                    <label for="one-step-invite-code">邀請碼（可選）</label>
                    <input type="text" id="one-step-invite-code" placeholder="8位邀請碼（可選）" maxlength="8">
                </div>
                <button id="verify-and-register-btn" class="btn">⭐ 一步式註冊</button>
                <div id="verify-and-register-result" class="result"></div>
            </div>

            <!-- 邀請註冊驗證 -->
            <div class="card">
                <h3>4. 🎉 邀請註冊驗證</h3>
                
                <div style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #ffc107;">
                    <strong>🆕 功能：</strong>支持邀請碼+郵箱驗證的組合註冊流程
                </div>
                
                <div class="form-group">
                    <label for="invite-email">電子郵箱</label>
                    <input type="email" id="invite-email" placeholder="請輸入郵箱">
                </div>
                <div class="form-group">
                    <label for="invite-verification-code">郵箱驗證碼</label>
                    <input type="text" id="invite-verification-code" placeholder="請輸入6位數字驗證碼" maxlength="6">
                </div>
                <div class="form-group">
                    <label for="invite-code">邀請碼</label>
                    <input type="text" id="invite-code" placeholder="請輸入8位邀請碼">
                </div>
                <button id="verify-invite-registration-btn" style="background-color: #9b59b6;">邀請註冊驗證</button>
                <div id="verify-invite-registration-result" class="result"></div>
            </div>
        </div>

        <!-- 管理後台API測試 -->
        <h3 style="margin-top: 40px; color: #c0392b;">🔧 管理後台郵件管理功能 (5個API)</h3>
        <div style="background: #f8d7da; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #dc3545;">
            <strong>⚠️ 注意：</strong>以下功能需要管理員權限 (admin 角色)，請先使用管理員賬號登入
        </div>
        
        <div class="container">
            <!-- 郵件統計 -->
            <div class="card">
                <h3>4. 📊 郵件發送統計</h3>
                
                <div class="form-group">
                    <label for="stats-start-date">開始日期 (可選)</label>
                    <input type="date" id="stats-start-date">
                </div>
                <div class="form-group">
                    <label for="stats-end-date">結束日期 (可選)</label>
                    <input type="date" id="stats-end-date">
                </div>
                <div class="form-group">
                    <label for="stats-type">郵件類型</label>
                    <select id="stats-type">
                        <option value="all">全部</option>
                        <option value="registration">註冊驗證</option>
                        <option value="password_reset">密碼重置</option>
                        <option value="invite_confirmation">邀請確認</option>
                    </select>
                </div>
                <button id="get-email-statistics-btn" style="background-color: #17a2b8;">獲取統計數據</button>
                <div id="get-email-statistics-result" class="result"></div>
            </div>

            <!-- 郵件日志查詢 -->
            <div class="card">
                <h3>5. 📋 郵件日志查詢</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label for="logs-page">頁碼</label>
                        <input type="number" id="logs-page" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label for="logs-limit">每頁數量</label>
                        <input type="number" id="logs-limit" value="20" min="1" max="100">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="logs-type">郵件類型</label>
                    <select id="logs-type">
                        <option value="">全部類型</option>
                        <option value="registration">註冊驗證</option>
                        <option value="password_reset">密碼重置</option>
                        <option value="invite_confirmation">邀請確認</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="logs-status">郵件狀態</label>
                    <select id="logs-status">
                        <option value="">全部狀態</option>
                        <option value="sent">發送成功</option>
                        <option value="failed">發送失敗</option>
                        <option value="verified">已驗證</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="logs-email">郵箱地址 (可選)</label>
                    <input type="email" id="logs-email" placeholder="篩選特定郵箱">
                </div>
                
                <div class="form-group">
                    <label for="logs-user-id">用戶ID (可選)</label>
                    <input type="text" id="logs-user-id" placeholder="篩選特定用戶">
                </div>
                
                <button id="get-email-logs-btn" style="background-color: #6c757d;">查詢郵件日志</button>
                <div id="get-email-logs-result" class="result"></div>
            </div>

            <!-- 管理功能 -->
            <div class="card">
                <h3>6. 🛠️ 郵件服務管理</h3>
                
                <!-- 重發失敗郵件 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>🔄 重發失敗郵件</h4>
                    <div class="form-group">
                        <label for="resend-log-id">郵件日志ID</label>
                        <input type="text" id="resend-log-id" placeholder="請輸入失敗郵件的日志ID">
                    </div>
                    <button id="resend-failed-email-btn" style="background-color: #fd7e14;">重發失敗郵件</button>
                    <div id="resend-failed-email-result" class="result"></div>
                </div>

                <!-- 測試郵件服務 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>🔧 測試郵件服務連接</h4>
                    <button id="test-email-service-btn" style="background-color: #20c997;">測試AokSend連接</button>
                    <div id="test-email-service-result" class="result"></div>
                </div>

                <!-- 清理過期日志 -->
                <div>
                    <h4>🗑️ 清理過期郵件日志</h4>
                    <div class="form-group">
                        <label for="cleanup-days">保留天數</label>
                        <input type="number" id="cleanup-days" value="60" min="1" max="365">
                        <small style="color: #666;">刪除指定天數之前的郵件日志</small>
                    </div>
                    <button id="cleanup-email-logs-btn" style="background-color: #dc3545;">清理過期日志</button>
                    <div id="cleanup-email-logs-result" class="result"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="user" class="tab-content">
        <h2>用戶資料 API 測試</h2>
        <p>測試用戶資料和諮詢次數管理相關API</p>
        
        <div class="container">
            <div class="card">
                <h3>用戶資料</h3>
                <button id="get-profile-btn">獲取用戶資料</button>
                <div id="profile-result" class="result"></div>
                
                <div class="form-group">
                    <label for="update-name">名稱</label>
                    <input type="text" id="update-name" placeholder="新的用戶名稱">
                </div>
                <div class="form-group">
                    <label for="update-phone">手機號碼</label>
                    <input type="text" id="update-phone" placeholder="手機號碼">
                </div>
                <div class="form-group">
                    <label for="update-company">公司名稱</label>
                    <input type="text" id="update-company" placeholder="公司名稱">
                </div>
                <div class="form-group">
                    <label for="update-industry">行業</label>
                    <input type="text" id="update-industry" placeholder="行業">
                </div>
                <div class="form-group">
                    <label for="update-position">職業</label>
                    <input type="text" id="update-position" placeholder="職業">
                </div>
                <button id="update-profile-btn">更新資料</button>
                <div id="update-profile-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>諮詢次數管理</h3>
                <button id="get-queries-btn">獲取剩餘次數</button>
                <div id="queries-result" class="result"></div>
                
                <button id="decrease-query-btn">使用一次諮詢</button>
                <div id="decrease-result" class="result"></div>
                
                <div class="form-group">
                    <label for="increase-amount">增加次數</label>
                    <input type="number" id="increase-amount" placeholder="增加的次數" min="1" value="1">
                </div>
                <div class="form-group">
                    <label for="target-user-id">目標用戶ID</label>
                    <input type="text" id="target-user-id" placeholder="用戶ID">
                </div>
                <button id="increase-queries-btn">增加諮詢次數 (僅管理員)</button>
                <div id="increase-result" class="result"></div>
            </div>
        </div>
    </div>

    <div id="chat" class="tab-content">
        <h2>聊天模組 API 測試</h2>
        <p>測試AI聊天功能相關API，包括會話管理、消息處理和N8N集成</p>
        
        <!-- 會話狀態顯示 -->
        <div class="container">
            <div class="card">
                <h3>🎯 當前會話狀態</h3>
                <div id="current-session-info">
                    <p>尚未選擇會話</p>
                </div>
                <button id="refresh-session-info-btn" style="background-color: #95a5a6;">刷新狀態</button>
            </div>
        </div>

        <!-- 用戶端API測試 -->
        <h3 style="margin-top: 30px; color: #2980b9;">👤 用戶端聊天功能 (7個API)</h3>
        
        <div class="container">
            <!-- 會話管理 -->
            <div class="card">
                <h3>1. 會話管理</h3>
                
                <!-- 創建會話 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>📝 創建新會話</h4>
                    <div class="form-group">
                        <label for="create-session-title">會話標題 (可選)</label>
                        <input type="text" id="create-session-title" placeholder="例：關於加班費的問題">
                    </div>
                    <button id="create-session-btn">創建會話</button>
                    <div id="create-session-result" class="result"></div>
                </div>

                <!-- 獲取會話列表 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>📋 會話列表</h4>
                    <div class="form-group">
                        <label for="sessions-search">搜索關鍵詞</label>
                        <input type="text" id="sessions-search" placeholder="搜索會話內容">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="sessions-page">頁碼</label>
                            <input type="number" id="sessions-page" value="1" min="1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="sessions-limit">每頁數量</label>
                            <input type="number" id="sessions-limit" value="20" min="1" max="50">
                        </div>
                    </div>
                    <button id="get-sessions-btn">獲取會話列表</button>
                    <div id="get-sessions-result" class="result"></div>
                </div>

                <!-- 會話詳情 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>🔍 會話詳情</h4>
                    <div class="form-group">
                        <label for="session-detail-id">會話ID</label>
                        <input type="text" id="session-detail-id" placeholder="請輸入會話ID">
                    </div>
                    <button id="get-session-detail-btn">獲取會話詳情</button>
                    <div id="get-session-detail-result" class="result"></div>
                </div>

                <!-- 更新會話標題 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>✏️ 更新會話標題</h4>
                    <div class="form-group">
                        <label for="update-session-id">會話ID</label>
                        <input type="text" id="update-session-id" placeholder="請輸入會話ID">
                    </div>
                    <div class="form-group">
                        <label for="update-session-title">新標題</label>
                        <input type="text" id="update-session-title" placeholder="請輸入新的會話標題">
                    </div>
                    <button id="update-session-title-btn">更新標題</button>
                    <div id="update-session-title-result" class="result"></div>
                </div>

                <!-- 刪除會話 -->
                <div>
                    <h4>🗑️ 刪除會話</h4>
                    <div class="form-group">
                        <label for="delete-session-id">會話ID</label>
                        <input type="text" id="delete-session-id" placeholder="請輸入要刪除的會話ID">
                    </div>
                    <button id="delete-session-btn" style="background-color: #e74c3c;">刪除會話</button>
                    <div id="delete-session-result" class="result"></div>
                </div>
            </div>

            <!-- 消息處理 -->
            <div class="card">
                <h3>2. 消息處理 ⭐ 核心功能</h3>
                
                <!-- 發送消息 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>💬 發送消息並獲取AI回復</h4>
                    <div class="form-group">
                        <label for="message-session-id">會話ID</label>
                        <input type="text" id="message-session-id" placeholder="請輸入會話ID">
                    </div>
                    <div class="form-group">
                        <label for="message-content">消息內容</label>
                        <textarea id="message-content" rows="3" placeholder="請輸入您的勞基法問題...例：請問加班費的計算方式？"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="message-type">消息類型</label>
                        <select id="message-type">
                            <option value="question">問題</option>
                            <option value="follow-up">追問</option>
                            <option value="clarification">澄清</option>
                        </select>
                    </div>
                    <button id="send-message-btn" style="background-color: #27ae60;">發送消息</button>
                    <div id="send-message-result" class="result"></div>
                </div>

                <!-- 獲取消息列表 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>📜 消息歷史</h4>
                    <div class="form-group">
                        <label for="messages-session-id">會話ID</label>
                        <input type="text" id="messages-session-id" placeholder="請輸入會話ID">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="messages-page">頁碼</label>
                            <input type="number" id="messages-page" value="1" min="1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="messages-limit">每頁數量</label>
                            <input type="number" id="messages-limit" value="50" min="1" max="100">
                        </div>
                    </div>
                    <button id="get-messages-btn">獲取消息列表</button>
                    <div id="get-messages-result" class="result"></div>
                </div>

                <!-- 用戶反饋 -->
                <div>
                    <h4>👍 用戶反饋</h4>
                    <div class="form-group">
                        <label for="feedback-session-id">會話ID</label>
                        <input type="text" id="feedback-session-id" placeholder="請輸入會話ID">
                    </div>
                    <div class="form-group">
                        <label for="feedback-message-id">消息ID</label>
                        <input type="text" id="feedback-message-id" placeholder="請輸入AI回復的消息ID">
                    </div>
                    <div class="form-group">
                        <label for="feedback-type">反饋類型</label>
                        <select id="feedback-type">
                            <option value="helpful">有幫助</option>
                            <option value="not_helpful">沒幫助</option>
                        </select>
                    </div>
                    <button id="submit-feedback-btn">提交反饋</button>
                    <div id="submit-feedback-result" class="result"></div>
                </div>
            </div>
        </div>

        <!-- 快速測試工具 -->
        <div class="container">
            <div class="card">
                <h3>🚀 快速測試工具</h3>
                
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>⚡ 一鍵完整測試流程</h4>
                    <p style="color: #666; font-size: 14px;">自動執行：創建會話 → 發送測試消息 → 獲取AI回復 → 查看會話詳情</p>
                    <button id="quick-test-btn" style="background-color: #9b59b6;">開始一鍵測試</button>
                    <div id="quick-test-result" class="result"></div>
                </div>

                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>🎯 預設問題測試</h4>
                    <p style="color: #666; font-size: 14px;">使用常見勞基法問題進行測試</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="preset-question-btn" data-question="請問加班費的計算方式？" style="background-color: #3498db; flex: 1; min-width: 200px;">加班費問題</button>
                        <button class="preset-question-btn" data-question="休假期間工資如何計算？" style="background-color: #e67e22; flex: 1; min-width: 200px;">休假工資</button>
                        <button class="preset-question-btn" data-question="被資遣時有什麼權利？" style="background-color: #1abc9c; flex: 1; min-width: 200px;">資遣權利</button>
                    </div>
                    <div id="preset-question-result" class="result"></div>
                </div>

                <div>
                    <h4>🧪 錯誤場景測試</h4>
                    <p style="color: #666; font-size: 14px;">測試各種錯誤情況的處理</p>
                    <div style="display: flex; gap: 10px;">
                        <button id="test-invalid-session-btn" style="background-color: #e74c3c; flex: 1;">無效會話ID</button>
                        <button id="test-empty-message-btn" style="background-color: #f39c12; flex: 1;">空消息內容</button>
                        <button id="test-no-auth-btn" style="background-color: #95a5a6; flex: 1;">無認證測試</button>
                    </div>
                    <div id="error-test-result" class="result"></div>
                </div>
            </div>
        </div>

        <!-- 管理員功能 -->
        <h3 style="margin-top: 30px; color: #e74c3c;">👨‍💼 管理員聊天功能 (4個API)</h3>
        <p style="color: #666;">注意：以下功能需要管理員權限</p>

        <div class="container">
            <!-- 管理員會話監控 -->
            <div class="card">
                <h3>3. 會話監控</h3>
                
                <!-- 獲取所有會話 -->
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>📊 所有用戶會話</h4>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-sessions-page">頁碼</label>
                            <input type="number" id="admin-sessions-page" value="1" min="1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-sessions-limit">每頁數量</label>
                            <input type="number" id="admin-sessions-limit" value="20" min="1" max="50">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-sessions-status">會話狀態</label>
                            <select id="admin-sessions-status">
                                <option value="">全部</option>
                                <option value="active">活躍</option>
                                <option value="completed">已完成</option>
                                <option value="abandoned">已放棄</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-sessions-user">用戶ID</label>
                            <input type="text" id="admin-sessions-user" placeholder="篩選特定用戶">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="admin-sessions-search">搜索關鍵詞</label>
                        <input type="text" id="admin-sessions-search" placeholder="搜索會話內容">
                    </div>
                    <button id="admin-get-sessions-btn">獲取所有會話</button>
                    <div id="admin-get-sessions-result" class="result"></div>
                </div>

                <!-- 管理員會話詳情 -->
                <div>
                    <h4>🔍 會話詳情 (管理員視角)</h4>
                    <div class="form-group">
                        <label for="admin-session-detail-id">會話ID</label>
                        <input type="text" id="admin-session-detail-id" placeholder="請輸入會話ID">
                    </div>
                    <button id="admin-get-session-detail-btn">獲取詳情</button>
                    <div id="admin-get-session-detail-result" class="result"></div>
                </div>
            </div>

            <!-- 統計數據 -->
            <div class="card">
                <h3>4. 統計數據</h3>
                
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>📈 聊天統計</h4>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="stats-start-date">開始日期</label>
                            <input type="date" id="stats-start-date">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="stats-end-date">結束日期</label>
                            <input type="date" id="stats-end-date">
                        </div>
                    </div>
                    <button id="get-chat-stats-btn">獲取統計數據</button>
                    <div id="get-chat-stats-result" class="result"></div>
                </div>

                <!-- 數據導出 -->
                <div>
                    <h4>📥 數據導出</h4>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="export-start-date">開始日期</label>
                            <input type="date" id="export-start-date">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="export-end-date">結束日期</label>
                            <input type="date" id="export-end-date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="export-format">導出格式</label>
                        <select id="export-format">
                            <option value="excel">Excel (XLSX)</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="export-include-user-info">包含用戶信息</label>
                        <select id="export-include-user-info">
                            <option value="true">是</option>
                            <option value="false">否</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="export-session-ids">特定會話ID (可選)</label>
                        <textarea id="export-session-ids" rows="2" placeholder="輸入會話ID，用逗號分隔"></textarea>
                    </div>
                    <button id="export-chat-records-btn" style="background-color: #27ae60;">導出聊天記錄</button>
                    <div id="export-chat-records-result" class="result"></div>
                </div>
            </div>
        </div>

        <!-- N8N服務狀態 -->
        <div class="container">
            <div class="card">
                <h3>🔧 N8N AI 服務狀態</h3>
                <p style="color: #666; font-size: 14px;">監控AI服務的運行狀態和性能指標</p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button id="check-n8n-status-btn" style="background-color: #3498db;">檢查服務狀態</button>
                    <button id="test-n8n-connection-btn" style="background-color: #e67e22;">測試連接</button>
                </div>
                
                <div id="n8n-service-status" class="result"></div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                    <h4>🎯 AI服務測試消息</h4>
                    <div class="form-group">
                        <label for="n8n-test-message">測試消息</label>
                        <textarea id="n8n-test-message" rows="2" placeholder="輸入測試消息，直接發送給N8N服務">請問加班費的計算方式？</textarea>
                    </div>
                    <button id="direct-n8n-test-btn" style="background-color: #9b59b6;">直接測試N8N</button>
                    <div id="direct-n8n-test-result" class="result"></div>
                </div>
            </div>
        </div>

        <!-- API文檔參考 -->
        <div class="container">
            <div class="card">
                <h3>📚 API文檔參考</h3>
                <p>快速查看聊天模組API的詳細信息</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                    <div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                        <h4 style="margin: 0 0 10px 0; color: #2980b9;">用戶端API (7個)</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                            <li>POST /chat/sessions - 創建會話</li>
                            <li>GET /chat/sessions - 會話列表</li>
                            <li>GET /chat/sessions/:id - 會話詳情</li>
                            <li>PUT /chat/sessions/:id - 更新標題</li>
                            <li>DELETE /chat/sessions/:id - 刪除會話</li>
                            <li>POST /chat/sessions/:id/messages - 發送消息</li>
                            <li>GET /chat/sessions/:id/messages - 消息列表</li>
                        </ul>
                    </div>
                    
                    <div style="padding: 10px; background-color: #fef9e7; border-radius: 4px;">
                        <h4 style="margin: 0 0 10px 0; color: #e67e22;">管理員API (4個)</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                            <li>GET /admin/chat/sessions - 所有會話</li>
                            <li>GET /admin/chat/stats - 統計數據</li>
                            <li>POST /admin/chat/export - 導出記錄</li>
                            <li>GET /admin/chat/sessions/:id/messages - 會話詳情</li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <a href="backendF/AI劳法通聊天模块API文档.md" target="_blank" style="color: #3498db; text-decoration: none;">📖 查看完整API文檔</a>
                </div>
            </div>
        </div>
    </div>

    <div id="test" class="tab-content">
        <h2>權限與中間件測試</h2>
        <p>測試各種權限中間件功能，查看不同角色用戶的權限限制</p>
        
        <div class="container">
            <div class="card">
                <h3>基本認證測試</h3>
                <button id="test-public-btn">公共路由</button>
                <button id="test-auth-btn">認證路由</button>
                <div id="test-basic-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>角色測試</h3>
                <button id="test-admin-btn">管理員路由</button>
                <button id="test-hr-btn">HR路由</button>
                <button id="test-employer-btn">雇主路由</button>
                <button id="test-employee-btn">員工路由</button>
                <div id="test-role-result" class="result"></div>
            </div>
        </div>
        
        <div class="container">
            <div class="card">
                <h3>多角色與諮詢次數測試</h3>
                <button id="test-admin-hr-btn">管理員或HR路由</button>
                <button id="test-check-queries-btn">檢查諮詢次數</button>
                <div id="test-special-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>資源訪問測試</h3>
                <div class="form-group">
                    <label for="test-user-id">用戶ID</label>
                    <input type="text" id="test-user-id" placeholder="要訪問的用戶ID">
                </div>
                <button id="test-user-profile-btn">訪問用戶資料</button>
                <div id="test-resource-result" class="result"></div>
            </div>
        </div>
        
        <div class="container">
            <div class="card">
                <h3>令牌信息</h3>
                <button id="test-token-info-btn">查看令牌信息</button>
                <div id="test-token-info-result" class="result"></div>
            </div>
        </div>
    </div>

    <div id="expert" class="tab-content">
        <h2>專家諮詢模組 API 測試 📋</h2>
        <p>測試專家諮詢功能相關API，包括申請提交、狀態管理和統計數據</p>
        
        <!-- 當前狀態顯示 -->
        <div class="container">
            <div class="card">
                <h3>🎯 模組狀態</h3>
                <div id="expert-module-info">
                    <p>專家諮詢模組已準備就緒</p>
                </div>
                <button id="refresh-expert-info-btn" style="background-color: #95a5a6;">刷新狀態</button>
            </div>
        </div>

        <!-- 用戶端API測試 -->
        <h3 style="margin-top: 30px; color: #2980b9;">👤 用戶端諮詢功能</h3>
        
        <div class="container">
            <!-- 提交諮詢申請 -->
            <div class="card">
                <h3>1. 提交專家諮詢申請 ⭐ 核心功能</h3>
                
                <div class="form-group">
                    <label for="expert-name">姓名 *</label>
                    <input type="text" id="expert-name" placeholder="請輸入您的姓名" value="測試用戶">
                </div>
                
                <div class="form-group">
                    <label for="expert-phone">手機號碼 *</label>
                    <input type="text" id="expert-phone" placeholder="台灣手機號碼格式：0912345678" value="0912345678">
                </div>
                
                <div class="form-group">
                    <label for="expert-email">電子郵箱</label>
                    <input type="email" id="expert-email" placeholder="請輸入電子郵箱" value="test@example.com">
                </div>
                
                <div class="form-group">
                    <label for="expert-line-id">Line ID</label>
                    <input type="text" id="expert-line-id" placeholder="請輸入Line ID" value="test_line_123">
                </div>
                
                <div class="form-group">
                    <label for="expert-service-type">服務類型 *</label>
                    <select id="expert-service-type">
                        <option value="labor_contract">勞動合同</option>
                        <option value="compensation">薪資福利</option>
                        <option value="termination">終止勞動關係</option>
                        <option value="workplace_safety">工作場所安全</option>
                        <option value="discrimination">歧視問題</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="expert-details">問題詳情 *</label>
                    <textarea id="expert-details" rows="4" placeholder="請詳細描述您的問題（至少10個字符）">我想了解勞動合同相關的法律問題，包括合同條款的合法性、員工權益保護等方面的內容。</textarea>
                </div>
                
                <div class="form-group">
                    <label for="expert-preferred-contact">偏好聯繫方式 *</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" id="contact-phone" value="phone" checked style="margin-right: 5px;">
                            電話
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" id="contact-email" value="email" checked style="margin-right: 5px;">
                            郵箱
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" id="contact-line" value="line" style="margin-right: 5px;">
                            Line
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="expert-time-preference">諮詢時間偏好</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="expert-time-of-day" style="flex: 1;">
                            <option value="">選擇時段</option>
                            <option value="morning">上午</option>
                            <option value="afternoon">下午</option>
                            <option value="evening">晚上</option>
                        </select>
                        <input type="time" id="expert-start-time" placeholder="開始時間" style="flex: 1;" value="09:00">
                        <input type="time" id="expert-end-time" placeholder="結束時間" style="flex: 1;" value="11:00">
                    </div>
                </div>
                
                <!-- === MVP新增字段 === -->
                <div class="form-group">
                    <label for="expert-region">所在地區</label>
                    <select id="expert-region">
                        <option value="">請選擇地區</option>
                        <option value="台北市">台北市</option>
                        <option value="新北市">新北市</option>
                        <option value="桃園市">桃園市</option>
                        <option value="台中市">台中市</option>
                        <option value="台南市">台南市</option>
                        <option value="高雄市">高雄市</option>
                        <option value="新竹市">新竹市</option>
                        <option value="新竹縣">新竹縣</option>
                        <option value="彰化縣">彰化縣</option>
                        <option value="雲林縣">雲林縣</option>
                        <option value="嘉義市">嘉義市</option>
                        <option value="嘉義縣">嘉義縣</option>
                        <option value="屏東縣">屏東縣</option>
                        <option value="宜蘭縣">宜蘭縣</option>
                        <option value="花蓮縣">花蓮縣</option>
                        <option value="台東縣">台東縣</option>
                        <option value="澎湖縣">澎湖縣</option>
                        <option value="金門縣">金門縣</option>
                        <option value="連江縣">連江縣</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="expert-simplified-time">偏好諮詢時間（簡化格式）</label>
                    <select id="expert-simplified-time">
                        <option value="">請選擇時間</option>
                        <option value="09:00">09:00</option>
                        <option value="09:30">09:30</option>
                        <option value="10:00">10:00</option>
                        <option value="10:30">10:30</option>
                        <option value="11:00">11:00</option>
                        <option value="11:30">11:30</option>
                        <option value="13:00">13:00</option>
                        <option value="13:30">13:30</option>
                        <option value="14:00">14:00</option>
                        <option value="14:30">14:30</option>
                        <option value="15:00">15:00</option>
                        <option value="15:30">15:30</option>
                        <option value="16:00">16:00</option>
                        <option value="16:30">16:30</option>
                        <option value="17:00">17:00</option>
                        <option value="17:30">17:30</option>
                    </select>
                </div>
                
                <button id="submit-expert-consultation-btn" style="background-color: #27ae60; font-size: 16px; padding: 12px 20px;">提交諮詢申請</button>
                <div id="submit-expert-consultation-result" class="result"></div>
            </div>

            <!-- 查看我的申請 -->
            <div class="card">
                <h3>2. 查看我的申請</h3>
                
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>📋 我的申請列表</h4>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="my-consultations-page">頁碼</label>
                            <input type="number" id="my-consultations-page" value="1" min="1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="my-consultations-limit">每頁數量</label>
                            <input type="number" id="my-consultations-limit" value="10" min="1" max="50">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="my-consultations-status">狀態篩選</label>
                            <select id="my-consultations-status">
                                <option value="">全部</option>
                                <option value="pending">待處理</option>
                                <option value="processing">處理中</option>
                                <option value="completed">已完成</option>
                                <option value="cancelled">已取消</option>
                            </select>
                        </div>
                    </div>
                    <button id="get-my-consultations-btn">獲取我的申請</button>
                    <div id="get-my-consultations-result" class="result"></div>
                </div>

                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>🔍 申請詳情</h4>
                    <div class="form-group">
                        <label for="consultation-detail-id">申請ID</label>
                        <input type="text" id="consultation-detail-id" placeholder="請輸入申請ID">
                    </div>
                    <button id="get-consultation-detail-btn">獲取申請詳情</button>
                    <div id="get-consultation-detail-result" class="result"></div>
                </div>

                <div>
                    <h4>❌ 取消申請</h4>
                    <div class="form-group">
                        <label for="cancel-consultation-id">申請ID</label>
                        <input type="text" id="cancel-consultation-id" placeholder="請輸入要取消的申請ID">
                    </div>
                    <div class="form-group">
                        <label for="cancel-reason">取消原因</label>
                        <input type="text" id="cancel-reason" placeholder="請輸入取消原因（可選）">
                    </div>
                    <button id="cancel-consultation-btn" style="background-color: #e74c3c;">取消申請</button>
                    <div id="cancel-consultation-result" class="result"></div>
                </div>
            </div>
        </div>

        <!-- 管理員端API測試 -->
        <h3 style="margin-top: 30px; color: #c0392b;">👨‍💼 管理員功能 (需要管理員權限)</h3>
        
        <div class="container">
            <div class="card">
                <h3>3. 管理所有申請</h3>
                
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>📊 申請列表</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-consultations-page">頁碼</label>
                            <input type="number" id="admin-consultations-page" value="1" min="1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-consultations-limit">每頁數量</label>
                            <input type="number" id="admin-consultations-limit" value="10" min="1" max="50">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-consultations-status">狀態</label>
                            <select id="admin-consultations-status">
                                <option value="">全部</option>
                                <option value="pending">待處理</option>
                                <option value="processing">處理中</option>
                                <option value="completed">已完成</option>
                                <option value="cancelled">已取消</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-consultations-service">服務類型</label>
                            <select id="admin-consultations-service">
                                <option value="">全部</option>
                                <option value="labor_contract">勞動合同</option>
                                <option value="compensation">薪資福利</option>
                                <option value="termination">終止勞動關係</option>
                                <option value="workplace_safety">工作場所安全</option>
                                <option value="discrimination">歧視問題</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-consultations-search">搜索</label>
                            <input type="text" id="admin-consultations-search" placeholder="姓名或電話">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-consultations-region">地區</label>
                            <select id="admin-consultations-region">
                                <option value="">全部地區</option>
                                <option value="台北市">台北市</option>
                                <option value="新北市">新北市</option>
                                <option value="桃園市">桃園市</option>
                                <option value="台中市">台中市</option>
                                <option value="台南市">台南市</option>
                                <option value="高雄市">高雄市</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="admin-consultations-advisor">指派顧問</label>
                            <input type="text" id="admin-consultations-advisor" placeholder="顧問ID">
                        </div>
                    </div>
                    <button id="get-admin-consultations-btn">獲取申請列表</button>
                    <div id="get-admin-consultations-result" class="result"></div>
                </div>

                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>✏️ 更新申請狀態</h4>
                    <div class="form-group">
                        <label for="update-consultation-id">申請ID</label>
                        <input type="text" id="update-consultation-id" placeholder="請輸入申請ID">
                    </div>
                    <div class="form-group">
                        <label for="update-consultation-status">新狀態</label>
                        <select id="update-consultation-status">
                            <option value="pending">待處理</option>
                            <option value="processing">處理中</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="update-admin-notes">管理員備註</label>
                        <textarea id="update-admin-notes" rows="3" placeholder="請輸入處理備註"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="update-assign-advisor">指派顧問ID</label>
                        <input type="text" id="update-assign-advisor" placeholder="輸入顧問ID（可選）">
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" id="update-force-update" style="margin-right: 5px;">
                            強制更新（跳過狀態流轉規則）
                        </label>
                    </div>
                    
                    <button id="update-consultation-btn" style="background-color: #3498db;">更新申請</button>
                    <div id="update-consultation-result" class="result"></div>
                </div>

                <div>
                    <h4>🗑️ 刪除申請</h4>
                    <div class="form-group">
                        <label for="delete-consultation-id">申請ID</label>
                        <input type="text" id="delete-consultation-id" placeholder="請輸入要刪除的申請ID">
                    </div>
                    <button id="delete-consultation-btn" style="background-color: #e74c3c;">刪除申請</button>
                    <div id="delete-consultation-result" class="result"></div>
                </div>
            </div>

            <div class="card">
                <h3>4. 統計數據</h3>
                
                <div class="form-group">
                    <label for="stats-start-date">開始日期</label>
                    <input type="date" id="stats-start-date">
                </div>
                <div class="form-group">
                    <label for="stats-end-date">結束日期</label>
                    <input type="date" id="stats-end-date">
                </div>
                <button id="get-consultation-stats-btn" style="background-color: #9b59b6;">獲取統計數據</button>
                <div id="get-consultation-stats-result" class="result"></div>
            </div>
        </div>

        <!-- 快速測試工具 -->
        <div class="container">
            <div class="card">
                <h3>🚀 快速測試工具</h3>
                
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>⚡ 一鍵完整測試流程</h4>
                    <p style="color: #666; font-size: 14px;">自動執行：提交申請 → 獲取申請詳情 → 更新狀態（如果是管理員）</p>
                    <button id="expert-quick-test-btn" style="background-color: #9b59b6;">開始一鍵測試</button>
                    <div id="expert-quick-test-result" class="result"></div>
                </div>

                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>🧪 驗證規則測試</h4>
                    <p style="color: #666; font-size: 14px;">測試無效數據的驗證規則</p>
                    <button id="test-validation-btn" style="background-color: #e67e22;">測試驗證規則</button>
                    <div id="test-validation-result" class="result"></div>
                </div>

                <div>
                    <h4>🔧 模型方法測試</h4>
                    <p style="color: #666; font-size: 14px;">測試數據庫模型的各種方法</p>
                    <button id="test-model-methods-btn" style="background-color: #34495e;">測試模型方法</button>
                    <div id="test-model-methods-result" class="result"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="advisor" class="tab-content">
        <h2>劳资顾问管理系統 API 測試 🧑‍💼</h2>
        <p>測試劳资顾问管理功能相關API，包括顧問CRUD、智能指派和統計數據</p>
        
        <!-- 顾问管理功能 -->
        <h3 style="margin-top: 30px; color: #2980b9;">👥 顧問管理功能</h3>
        
        <div class="container">
            <!-- 顾问列表查询 -->
            <div class="card">
                <h3>1. 顧問列表查詢</h3>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label for="advisor-list-page">頁碼</label>
                        <input type="number" id="advisor-list-page" value="1" min="1">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="advisor-list-limit">每頁數量</label>
                        <input type="number" id="advisor-list-limit" value="10" min="1" max="50">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="advisor-list-region">地區</label>
                        <select id="advisor-list-region">
                            <option value="">全部地區</option>
                            <option value="台北市">台北市</option>
                            <option value="新北市">新北市</option>
                            <option value="桃園市">桃園市</option>
                            <option value="台中市">台中市</option>
                            <option value="高雄市">高雄市</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="advisor-list-specialty">專業領域</label>
                        <select id="advisor-list-specialty">
                            <option value="">全部專業</option>
                            <option value="labor_contract">勞動合同</option>
                            <option value="compensation">薪資福利</option>
                            <option value="workplace_safety">工作場所安全</option>
                            <option value="termination">終止勞動關係</option>
                            <option value="discrimination">歧視問題</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="advisor-list-status">狀態</label>
                        <select id="advisor-list-status">
                            <option value="">全部狀態</option>
                            <option value="true">活躍</option>
                            <option value="false">停用</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="advisor-list-search">搜索</label>
                        <input type="text" id="advisor-list-search" placeholder="姓名或電話">
                    </div>
                </div>
                
                <button id="get-advisor-list-btn">獲取顧問列表</button>
                <div id="get-advisor-list-result" class="result"></div>
            </div>

            <!-- 创建新顾问 -->
            <div class="card">
                <h3>2. 創建新顧問</h3>
                
                <div class="form-group">
                    <label for="create-advisor-name">顧問姓名 *</label>
                    <input type="text" id="create-advisor-name" placeholder="請輸入顧問姓名" value="測試顧問">
                </div>
                
                <div class="form-group">
                    <label for="create-advisor-phone">聯繫電話 *</label>
                    <input type="text" id="create-advisor-phone" placeholder="電話號碼" value="02-12345678">
                </div>
                
                <div class="form-group">
                    <label for="create-advisor-email">電子郵箱 *</label>
                    <input type="email" id="create-advisor-email" placeholder="請輸入電子郵箱" value="test.advisor@example.com">
                </div>
                
                <div class="form-group">
                    <label for="create-advisor-line">Line ID</label>
                    <input type="text" id="create-advisor-line" placeholder="Line ID" value="test_advisor">
                </div>
                
                <div class="form-group">
                    <label for="create-advisor-region">服務地區 *</label>
                    <select id="create-advisor-region">
                        <option value="">請選擇地區</option>
                        <option value="台北市">台北市</option>
                        <option value="新北市">新北市</option>
                        <option value="桃園市">桃園市</option>
                        <option value="台中市">台中市</option>
                        <option value="台南市">台南市</option>
                        <option value="高雄市">高雄市</option>
                        <option value="新竹市">新竹市</option>
                        <option value="新竹縣">新竹縣</option>
                        <option value="彰化縣">彰化縣</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="create-advisor-specialties">專業領域 *（可多選）</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" class="advisor-specialty" value="labor_contract" checked style="margin-right: 5px;">
                            勞動合同
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" class="advisor-specialty" value="compensation" style="margin-right: 5px;">
                            薪資福利
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" class="advisor-specialty" value="workplace_safety" style="margin-right: 5px;">
                            工作場所安全
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" class="advisor-specialty" value="termination" style="margin-right: 5px;">
                            終止勞動關係
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" class="advisor-specialty" value="discrimination" style="margin-right: 5px;">
                            歧視問題
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" class="advisor-specialty" value="other" style="margin-right: 5px;">
                            其他
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="create-advisor-notes">備註信息</label>
                    <textarea id="create-advisor-notes" rows="3" placeholder="顧問相關備註信息（可選）">資深勞動法專家，處理效率高</textarea>
                </div>
                
                <button id="create-advisor-btn" style="background-color: #27ae60; font-size: 16px; padding: 12px 20px;">創建顧問</button>
                <div id="create-advisor-result" class="result"></div>
            </div>
        </div>

        <div class="container">
            <!-- 顾问详情和操作 -->
            <div class="card">
                <h3>3. 顧問詳情與操作</h3>
                
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>📋 顧問詳情</h4>
                    <div class="form-group">
                        <label for="advisor-detail-id">顧問ID</label>
                        <input type="text" id="advisor-detail-id" placeholder="請輸入顧問ID">
                    </div>
                    <button id="get-advisor-detail-btn">獲取顧問詳情</button>
                    <div id="get-advisor-detail-result" class="result"></div>
                </div>

                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>✏️ 更新顧問信息</h4>
                    <div class="form-group">
                        <label for="update-advisor-id">顧問ID</label>
                        <input type="text" id="update-advisor-id" placeholder="請輸入顧問ID">
                    </div>
                    <div class="form-group">
                        <label for="update-advisor-name">新姓名</label>
                        <input type="text" id="update-advisor-name" placeholder="更新後的姓名（可選）">
                    </div>
                    <div class="form-group">
                        <label for="update-advisor-phone">新電話</label>
                        <input type="text" id="update-advisor-phone" placeholder="新的電話號碼（可選）">
                    </div>
                    <div class="form-group">
                        <label for="update-advisor-region">新地區</label>
                        <select id="update-advisor-region">
                            <option value="">不更改地區</option>
                            <option value="台北市">台北市</option>
                            <option value="新北市">新北市</option>
                            <option value="桃園市">桃園市</option>
                            <option value="台中市">台中市</option>
                            <option value="高雄市">高雄市</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="update-advisor-notes">備註信息</label>
                        <textarea id="update-advisor-notes" rows="2" placeholder="更新的備註信息（可選）"></textarea>
                    </div>
                    <button id="update-advisor-btn" style="background-color: #3498db;">更新顧問信息</button>
                    <div id="update-advisor-result" class="result"></div>
                </div>

                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>🔄 切換顧問狀態</h4>
                    <div class="form-group">
                        <label for="toggle-advisor-id">顧問ID</label>
                        <input type="text" id="toggle-advisor-id" placeholder="請輸入顧問ID">
                    </div>
                    <button id="toggle-advisor-status-btn" style="background-color: #f39c12;">切換狀態</button>
                    <div id="toggle-advisor-status-result" class="result"></div>
                </div>

                <div>
                    <h4>🗑️ 刪除顧問</h4>
                    <div class="form-group">
                        <label for="delete-advisor-id">顧問ID</label>
                        <input type="text" id="delete-advisor-id" placeholder="請輸入要刪除的顧問ID">
                    </div>
                    <button id="delete-advisor-btn" style="background-color: #e74c3c;">刪除顧問</button>
                    <div id="delete-advisor-result" class="result"></div>
                </div>
            </div>

            <!-- 智能指派功能 -->
            <div class="card">
                <h3>4. 智能指派功能 ⭐</h3>
                
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>🔍 搜索可用顧問</h4>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="search-advisor-region">地區</label>
                            <select id="search-advisor-region">
                                <option value="">全部地區</option>
                                <option value="台北市">台北市</option>
                                <option value="新北市">新北市</option>
                                <option value="桃園市">桃園市</option>
                                <option value="台中市">台中市</option>
                                <option value="高雄市">高雄市</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="search-advisor-specialty">專業領域</label>
                            <select id="search-advisor-specialty">
                                <option value="">全部專業</option>
                                <option value="labor_contract">勞動合同</option>
                                <option value="compensation">薪資福利</option>
                                <option value="workplace_safety">工作場所安全</option>
                                <option value="termination">終止勞動關係</option>
                                <option value="discrimination">歧視問題</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="search-advisor-workload">工作負載</label>
                            <select id="search-advisor-workload">
                                <option value="">全部負載</option>
                                <option value="light">輕鬆</option>
                                <option value="normal">正常</option>
                                <option value="heavy">繁重</option>
                            </select>
                        </div>
                    </div>
                    <button id="search-available-advisors-btn">搜索可用顧問</button>
                    <div id="search-available-advisors-result" class="result"></div>
                </div>

                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>👤 手動指派顧問</h4>
                    <div class="form-group">
                        <label for="manual-assign-consultation">咨詢申請ID</label>
                        <input type="text" id="manual-assign-consultation" placeholder="請輸入咨詢申請ID">
                    </div>
                    <div class="form-group">
                        <label for="manual-assign-advisor">顧問ID</label>
                        <input type="text" id="manual-assign-advisor" placeholder="請輸入顧問ID">
                    </div>
                    <button id="manual-assign-advisor-btn" style="background-color: #9b59b6;">手動指派</button>
                    <div id="manual-assign-advisor-result" class="result"></div>
                </div>

                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>🤖 自動指派最佳顧問</h4>
                    <div class="form-group">
                        <label for="auto-assign-consultation">咨詢申請ID</label>
                        <input type="text" id="auto-assign-consultation" placeholder="請輸入咨詢申請ID">
                    </div>
                    <button id="auto-assign-advisor-btn" style="background-color: #1abc9c;">自動指派</button>
                    <div id="auto-assign-advisor-result" class="result"></div>
                </div>

                <div>
                    <h4>📋 指派歷史查詢</h4>
                    <div class="form-group">
                        <label for="assignment-history-consultation">咨詢申請ID</label>
                        <input type="text" id="assignment-history-consultation" placeholder="請輸入咨詢申請ID">
                    </div>
                    <button id="assignment-history-btn" style="background-color: #95a5a6;">查看指派歷史</button>
                    <div id="assignment-history-result" class="result"></div>
                </div>
            </div>
        </div>

        <!-- 统计分析功能 -->
        <h3 style="margin-top: 30px; color: #c0392b;">📊 統計分析功能</h3>
        
        <div class="container">
            <div class="card">
                <h3>5. 顧問統計數據</h3>
                
                <div class="form-group">
                    <label for="advisor-stats-start-date">開始日期</label>
                    <input type="date" id="advisor-stats-start-date">
                </div>
                <div class="form-group">
                    <label for="advisor-stats-end-date">結束日期</label>
                    <input type="date" id="advisor-stats-end-date">
                </div>
                <button id="get-advisor-statistics-btn" style="background-color: #34495e;">獲取統計數據</button>
                <div id="get-advisor-statistics-result" class="result"></div>
            </div>

            <!-- 快速测试工具 -->
            <div class="card">
                <h3>🚀 快速測試工具</h3>
                
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h4>⚡ 一鍵完整測試流程</h4>
                    <p style="color: #666; font-size: 14px;">自動執行：創建顧問 → 獲取列表 → 搜索可用顧問 → 獲取統計</p>
                    <button id="advisor-quick-test-btn" style="background-color: #9b59b6;">開始一鍵測試</button>
                    <div id="advisor-quick-test-result" class="result"></div>
                </div>

                <div>
                    <h4>🧪 端到端指派測試</h4>
                    <p style="color: #666; font-size: 14px;">測試完整指派流程：創建顧問 → 提交咨詢 → 自動指派 → 更新狀態</p>
                    <button id="e2e-assignment-test-btn" style="background-color: #e67e22;">端到端測試</button>
                    <div id="e2e-assignment-test-result" class="result"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="invite" class="tab-content">
        <h2>邀請管理 API 測試</h2>
        <p>測試邀請碼生成、驗證、統計等功能</p>
        
        <div style="background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #ffc107;">
            <strong>🔧 最新更新 (2024-12-27)：</strong>
            <br>• 修復了 <code>/invites/settings</code> API 404錯誤
            <br>• 修復了 <code>/invites/my-stats</code> API 響應格式，現在完全符合前端需求
            <br>• 建議先測試這兩個API確認修復成功，再給前端使用
        </div>
        
        <div class="container">
            <div class="card">
                <h3>邀請碼管理</h3>
                <button id="get-my-invite-code-btn">獲取我的邀請碼</button>
                <div id="my-invite-code-result" class="result"></div>
                
                <button id="regenerate-invite-code-btn" style="background-color: #f39c12; margin-top: 10px;">重新生成邀請碼</button>
                <div id="regenerate-invite-code-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>邀請碼驗證</h3>
                <div class="form-group">
                    <label for="validate-invite-code">邀請碼</label>
                    <input type="text" id="validate-invite-code" placeholder="輸入要驗證的邀請碼">
                </div>
                <button id="validate-invite-code-btn">驗證邀請碼</button>
                <div id="validate-invite-code-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>邀請統計 🔄 (已更新響應格式)</h3>
                <button id="get-my-invite-stats-btn">獲取我的邀請統計</button>
                <div id="my-invite-stats-result" class="result"></div>
                
                <div style="margin: 15px 0; padding: 10px; background-color: #e8f5e8; border-radius: 4px; border-left: 4px solid #27ae60;">
                    <strong>✅ 響應格式已修復：</strong>
                    <br>• <code>totalInvites</code> → <code>totalInvited</code>
                    <br>• 新增 <code>thisMonthInvited</code>, <code>thisMonthBonus</code>
                    <br>• 新增 <code>ranking</code>, <code>inviteUrl</code>
                    <br>• <code>recentInvites</code> → <code>recentInvitees</code>
                    <br>• 新增 <code>monthlyStats</code> 字段
                </div>
                
                <button id="get-invite-leaderboard-btn" style="background-color: #e74c3c; margin-top: 10px;">邀請排行榜</button>
                <div id="invite-leaderboard-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>🆕 邀請系統設置</h3>
                <p style="color: #666; font-size: 14px;">測試新開發的邀請設置API</p>
                <button id="get-invite-settings-btn" style="background-color: #9b59b6;">獲取邀請設置</button>
                <div id="invite-settings-result" class="result"></div>
                
                <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                    <strong>📋 測試說明：</strong>
                    <br>• 此API返回邀請系統的配置信息
                    <br>• 包含邀請人和被邀請人的獎勵次數
                    <br>• 前端可用此信息動態顯示獎勵規則
                </div>
            </div>
            
            <div class="card">
                <h3>邀請注冊處理</h3>
                <div class="form-group">
                    <label for="process-invite-code">邀請碼</label>
                    <input type="text" id="process-invite-code" placeholder="輸入邀請碼">
                </div>
                <button id="process-registration-btn">處理邀請注冊</button>
                <div id="process-registration-result" class="result"></div>
                
                <button id="grant-registration-bonus-btn" style="background-color: #27ae60; margin-top: 10px;">發放注冊獎勵</button>
                <div id="grant-registration-bonus-result" class="result"></div>
            </div>
        </div>
        
        <!-- 管理員專用功能 -->
        <div class="container" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e74c3c;">
            <h3 style="color: #e74c3c;">👨‍💼 管理員專用功能</h3>
            <div class="card">
                <h3>用戶邀請統計（管理員）</h3>
                <div class="form-group">
                    <label for="admin-user-id-invite">用戶ID</label>
                    <input type="text" id="admin-user-id-invite" placeholder="輸入用戶ID">
                </div>
                <button id="admin-get-user-invite-stats-btn">獲取用戶邀請統計</button>
                <div id="admin-user-invite-stats-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>邀請系統統計（管理員）</h3>
                <div class="form-group">
                    <label for="invite-stats-start-date">開始日期</label>
                    <input type="date" id="invite-stats-start-date">
                </div>
                <div class="form-group">
                    <label for="invite-stats-end-date">結束日期</label>
                    <input type="date" id="invite-stats-end-date">
                </div>
                <button id="admin-get-invite-system-stats-btn">獲取系統邀請統計</button>
                <div id="admin-invite-system-stats-result" class="result"></div>
            </div>
        </div>
    </div>

    <div id="query" class="tab-content">
        <h2>咨詢次數管理 API 測試</h2>
        <p>測試咨詢次數扣減、增加、統計等功能</p>
        
        <div class="container">
            <div class="card">
                <h3>用戶咨詢狀態</h3>
                <button id="get-my-query-status-btn">獲取我的咨詢狀態</button>
                <div id="my-query-status-result" class="result"></div>
                
                <button id="get-my-today-count-btn" style="background-color: #3498db; margin-top: 10px;">今日使用次數</button>
                <div id="my-today-count-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>咨詢次數操作</h3>
                <div class="form-group">
                    <label for="decrease-reason">扣減原因</label>
                    <input type="text" id="decrease-reason" placeholder="扣減原因（如：AI咨詢）" value="API測試扣減">
                </div>
                <div class="form-group">
                    <label for="decrease-metadata">元數據（JSON）</label>
                    <textarea id="decrease-metadata" placeholder='{"testMode": true}' rows="2">{"testMode": true}</textarea>
                </div>
                <button id="decrease-query-count-btn" style="background-color: #e74c3c;">扣減咨詢次數</button>
                <div id="decrease-query-count-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>咨詢記錄</h3>
                <div class="form-group">
                    <label for="query-records-page">頁碼</label>
                    <input type="number" id="query-records-page" placeholder="頁碼" value="1" min="1">
                </div>
                <div class="form-group">
                    <label for="query-records-limit">每頁數量</label>
                    <input type="number" id="query-records-limit" placeholder="每頁數量" value="10" min="1" max="100">
                </div>
                <div class="form-group">
                    <label for="query-records-action">操作類型</label>
                    <select id="query-records-action">
                        <option value="">全部</option>
                        <option value="decrease">扣減</option>
                        <option value="increase">增加</option>
                        <option value="admin_adjust">管理員調整</option>
                        <option value="invite_bonus">邀請獎勵</option>
                        <option value="registration_bonus">注冊獎勵</option>
                        <option value="system_grant">系統發放</option>
                    </select>
                </div>
                <button id="get-my-query-records-btn">獲取咨詢記錄</button>
                <div id="my-query-records-result" class="result"></div>
            </div>
        </div>
        
        <!-- 管理員專用功能 -->
        <div class="container" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e74c3c;">
            <h3 style="color: #e74c3c;">👨‍💼 管理員專用功能</h3>
            <div class="card">
                <h3>增加用戶咨詢次數</h3>
                <div class="form-group">
                    <label for="admin-increase-user-id">用戶ID</label>
                    <input type="text" id="admin-increase-user-id" placeholder="用戶ID">
                </div>
                <div class="form-group">
                    <label for="admin-increase-amount">增加數量</label>
                    <input type="number" id="admin-increase-amount" placeholder="增加數量" value="5" min="1" max="1000">
                </div>
                <div class="form-group">
                    <label for="admin-increase-reason">增加原因</label>
                    <input type="text" id="admin-increase-reason" placeholder="增加原因" value="管理員測試增加">
                </div>
                <button id="admin-increase-query-btn">增加咨詢次數</button>
                <div id="admin-increase-query-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>調整用戶咨詢次數</h3>
                <div class="form-group">
                    <label for="admin-adjust-user-id">用戶ID</label>
                    <input type="text" id="admin-adjust-user-id" placeholder="用戶ID">
                </div>
                <div class="form-group">
                    <label for="admin-adjust-operation">操作類型</label>
                    <select id="admin-adjust-operation">
                        <option value="increase">增加</option>
                        <option value="decrease">減少</option>
                        <option value="set">設定為</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="admin-adjust-amount">數量</label>
                    <input type="number" id="admin-adjust-amount" placeholder="數量" value="10" min="0" max="10000">
                </div>
                <div class="form-group">
                    <label for="admin-adjust-reason">調整原因</label>
                    <input type="text" id="admin-adjust-reason" placeholder="調整原因" value="管理員手動調整">
                </div>
                <button id="admin-adjust-query-btn">調整咨詢次數</button>
                <div id="admin-adjust-query-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>批量調整咨詢次數</h3>
                <div class="form-group">
                    <label for="admin-batch-user-ids">用戶ID列表（逗號分隔）</label>
                    <textarea id="admin-batch-user-ids" placeholder="用戶ID1,用戶ID2,用戶ID3" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="admin-batch-operation">操作類型</label>
                    <select id="admin-batch-operation">
                        <option value="increase">增加</option>
                        <option value="decrease">減少</option>
                        <option value="set">設定為</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="admin-batch-amount">數量</label>
                    <input type="number" id="admin-batch-amount" placeholder="數量" value="5" min="0" max="10000">
                </div>
                <div class="form-group">
                    <label for="admin-batch-reason">調整原因</label>
                    <input type="text" id="admin-batch-reason" placeholder="調整原因" value="批量調整測試">
                </div>
                <button id="admin-batch-adjust-query-btn" style="background-color: #f39c12;">批量調整咨詢次數</button>
                <div id="admin-batch-adjust-query-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>用戶咨詢狀態查詢（管理員）</h3>
                <div class="form-group">
                    <label for="admin-query-user-id">用戶ID</label>
                    <input type="text" id="admin-query-user-id" placeholder="用戶ID">
                </div>
                <button id="admin-get-user-query-status-btn">獲取用戶咨詢狀態</button>
                <div id="admin-user-query-status-result" class="result"></div>
                
                <button id="admin-get-user-query-records-btn" style="background-color: #9b59b6; margin-top: 10px;">獲取用戶咨詢記錄</button>
                <div id="admin-user-query-records-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>系統咨詢統計（管理員）</h3>
                <div class="form-group">
                    <label for="query-stats-start-date">開始日期</label>
                    <input type="date" id="query-stats-start-date">
                </div>
                <div class="form-group">
                    <label for="query-stats-end-date">結束日期</label>
                    <input type="date" id="query-stats-end-date">
                </div>
                <button id="admin-get-query-system-stats-btn">獲取系統咨詢統計</button>
                <div id="admin-query-system-stats-result" class="result"></div>
            </div>
        </div>
    </div>

    <div id="admin" class="tab-content">
        <h2>管理員 API 測試</h2>
        <p>注意：這些功能僅適用於管理員用戶</p>
        
        <div class="container">
            <div class="card">
                <h3>用戶管理</h3>
                <div class="form-group">
                    <label>搜索用戶</label>
                    <input type="text" id="admin-search-user" placeholder="用戶名或電子郵箱">
                </div>
                <div class="form-group">
                    <label>用戶類型</label>
                    <select id="admin-filter-userType">
                        <option value="all">全部</option>
                        <option value="admin">管理員</option>
                        <option value="hr">人資</option>
                        <option value="employer">雇主</option>
                        <option value="employee">員工</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>用戶狀態</label>
                    <select id="admin-filter-status">
                        <option value="all">全部</option>
                        <option value="active">啟用</option>
                        <option value="pending">待驗證</option>
                        <option value="disabled">禁用</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>註冊時間範圍</label>
                    <select id="admin-filter-dateRange">
                        <option value="all">全部</option>
                        <option value="today">今天</option>
                        <option value="week">本週</option>
                        <option value="month">本月</option>
                        <option value="year">本年</option>
                    </select>
                </div>
                <button id="admin-get-users-btn">獲取用戶列表</button>
                <button id="admin-export-users-btn">導出用戶數據</button>
                <div id="admin-users-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>新增用戶</h3>
                <div class="form-group">
                    <label for="admin-add-name">姓名</label>
                    <input type="text" id="admin-add-name" placeholder="用戶名稱">
                </div>
                <div class="form-group">
                    <label for="admin-add-email">電子郵箱</label>
                    <input type="email" id="admin-add-email" placeholder="電子郵箱">
                </div>
                <div class="form-group">
                    <label for="admin-add-password">初始密碼</label>
                    <input type="password" id="admin-add-password" placeholder="密碼">
                </div>
                <div class="form-group">
                    <label for="admin-add-userType">用戶類型</label>
                    <select id="admin-add-userType">
                        <option value="employee">員工</option>
                        <option value="employer">雇主</option>
                        <option value="hr">人資</option>
                        <option value="admin">管理員</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="admin-add-phone">手機號碼</label>
                    <input type="text" id="admin-add-phone" placeholder="手機號碼">
                </div>
                <div class="form-group">
                    <label for="admin-add-company">公司名稱</label>
                    <input type="text" id="admin-add-company" placeholder="公司名稱">
                </div>
                <div class="form-group">
                    <label for="admin-add-industry">行業</label>
                    <input type="text" id="admin-add-industry" placeholder="行業">
                </div>
                <div class="form-group">
                    <label for="admin-add-position">職業</label>
                    <input type="text" id="admin-add-position" placeholder="職業">
                </div>
                <div class="form-group">
                    <label for="admin-add-queries">初始諮詢次數</label>
                    <input type="number" id="admin-add-queries" placeholder="諮詢次數" value="5">
                </div>
                <button id="admin-create-user-btn">創建用戶</button>
                <div id="admin-create-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>用戶詳情</h3>
                <div class="form-group">
                    <label for="admin-view-userId">用戶ID</label>
                    <input type="text" id="admin-view-userId" placeholder="用戶ID">
                </div>
                <button id="admin-get-user-btn">獲取用戶詳情</button>
                <div id="admin-user-detail-result" class="result"></div>
            </div>
        </div>
    </div>

    <div id="debug" class="tab-content">
        <div class="container">
            <div class="card">
                <h2>API 端點</h2>
                <div class="form-group">
                    <label for="api-url">API 基礎 URL</label>
                    <input type="text" id="api-url" value="http://localhost:7070/api/v1" placeholder="API 基礎 URL">
                </div>
                <button id="save-api-url-btn">保存</button>
            </div>

            <div class="card">
                <h2>JWT 令牌</h2>
                <div class="form-group">
                    <label for="auth-token">認證令牌</label>
                    <textarea id="auth-token" rows="5" placeholder="登入後自動填入"></textarea>
                </div>
                <button id="save-token-btn">保存</button>
                <button id="clear-token-btn">清除</button>
            </div>
        </div>
    </div>

    <script>
        // API 配置
        const API = {
            BASE_URL: 'http://localhost:7070/api/v1',
            AUTH_TOKEN_KEY: 'auth_token',
            USER_KEY: 'user_info'
        };
        
        // 存儲token
        let authToken = localStorage.getItem(API.AUTH_TOKEN_KEY) || '';
        let refreshToken = localStorage.getItem('refreshToken') || '';
        let currentUser = JSON.parse(localStorage.getItem(API.USER_KEY) || 'null');
        
        // 默認測試賬號
        const TEST_ADMIN = {
            username: 'admin',
            email: 'test@ailaborlaw.com',
            password: 'Test1234'
        };
        
        const TEST_USER = {
            username: 'newadmin',
            email: 'newadmin@ailaborlaw.com',
            password: 'Admin1234'
        };
        
        // 切换标签页
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有active类
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // 添加active类到当前按钮和对应内容
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // 添加認證令牌到請求
        const getAuthHeaders = () => {
            const token = localStorage.getItem(API.AUTH_TOKEN_KEY);
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        };
        
        // 通用API调用函数
        async function callApi(endpoint, method = 'GET', data = null, auth = false) {
            try {
                const url = `${API.BASE_URL}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // 获取最新的token（从localStorage或全局变量）
                const currentToken = authToken || localStorage.getItem(API.AUTH_TOKEN_KEY);
                
                if (auth && currentToken) {
                    headers['Authorization'] = `Bearer ${currentToken}`;
                }
                
                const options = {
                    method,
                    headers
                };
                
                if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                    options.body = JSON.stringify(data);
                }
                
                console.log(`API调用: ${method} ${url}`, {
                    hasAuth: !!currentToken,
                    tokenLength: currentToken ? currentToken.length : 0,
                    data
                });
                
                const response = await fetch(url, options);
                const result = await response.json();
                
                console.log(`API响应: ${response.status}`, result);
                
                return result;
            } catch (error) {
                console.error('API调用错误:', error);
                return {
                    success: false,
                    message: '请求失败',
                    error: {
                        code: 'REQUEST_FAILED',
                        details: error.message
                    }
                };
            }
        }
        
        // 格式化输出结果
        function formatResult(element, data, isSuccess = true) {
            if (!element) return;
            
            element.innerHTML = '';
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
            
            if (typeof data === 'object') {
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                element.appendChild(pre);
            } else {
                element.textContent = data;
            }
        }
        
        // 更新UI以反映登录状态
        function updateLoginStatus() {
            const userInfo = document.getElementById('user-info');
            
            if (!userInfo) return;
            
            if (authToken && currentUser) {
                userInfo.innerHTML = `
                    <div class="logged-in">
                        <p><strong>已登录为:</strong> ${currentUser.name || 'Unknown'}</p>
                        <p><strong>用户类型:</strong> ${currentUser.userType || 'Unknown'}</p>
                        <button id="logout-btn">登出</button>
                    </div>
                `;
                
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
            } else {
                userInfo.innerHTML = '<p>未登录</p>';
            }
        }
        
        // 处理登出
        function handleLogout() {
            localStorage.removeItem(API.AUTH_TOKEN_KEY);
            localStorage.removeItem('refreshToken');
            localStorage.removeItem(API.USER_KEY);
            authToken = '';
            refreshToken = '';
            currentUser = null;
            updateLoginStatus();
            alert('成功登出');
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 注册处理程序
            document.getElementById('register-btn').addEventListener('click', handleRegister);
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('get-profile-btn').addEventListener('click', handleGetProfile);
            document.getElementById('update-profile-btn').addEventListener('click', handleUpdateProfile);
            document.getElementById('get-queries-btn').addEventListener('click', handleGetQueries);
            document.getElementById('decrease-query-btn').addEventListener('click', handleDecreaseQuery);
            document.getElementById('increase-queries-btn').addEventListener('click', handleIncreaseQueries);
            
            // 管理员API测试处理程序
            document.getElementById('admin-get-users-btn').addEventListener('click', handleGetUsers);
            document.getElementById('admin-export-users-btn').addEventListener('click', handleExportUsers);
            document.getElementById('admin-create-user-btn').addEventListener('click', handleCreateUser);
            document.getElementById('admin-get-user-btn').addEventListener('click', handleGetUserDetail);
            
            // 快速登入按鈕
            document.getElementById('admin-quick-login').addEventListener('click', () => handleQuickLogin(TEST_ADMIN));
            document.getElementById('user-quick-login').addEventListener('click', () => handleQuickLogin(TEST_USER));
            
            // 聊天模块事件监听器
            initChatEventListeners();
            
            // 郵箱驗證模块事件监听器
            initEmailVerificationEventListeners();
            
            updateLoginStatus();
        });
        
        // 注册处理函数
        async function handleRegister() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const userType = document.getElementById('register-userType').value;
            const industry = document.getElementById('register-industry').value;
            const position = document.getElementById('register-position').value;
            const inviteCode = document.getElementById('register-inviteCode').value;
            
            if (!name || !email || !password) {
                formatResult(document.getElementById('register-result'), '请填写必要信息', false);
                return;
            }
            
            const data = {
                name,
                email,
                password,
                userType,
                profile: {}
            };
            
            if (industry) data.profile.industry = industry;
            if (position) data.profile.position = position;
            if (inviteCode) data.inviteCode = inviteCode;
            
            const result = await callApi('/auth/register', 'POST', data);
            formatResult(document.getElementById('register-result'), result, result.success);
            
            if (result.success && result.data?.token) {
                authToken = result.data.token;
                currentUser = result.data.user;
                localStorage.setItem(API.AUTH_TOKEN_KEY, authToken);
                localStorage.setItem(API.USER_KEY, JSON.stringify(currentUser));
                updateLoginStatus();
                
                // 自动切换到用户信息页面
                document.querySelector('[data-tab="user"]').click();
            }
        }
        
        // 登录处理函数
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                formatResult(document.getElementById('login-result'), '请填写邮箱和密码', false);
                return;
            }
            
            const result = await callApi('/auth/login', 'POST', { email, password });
            formatResult(document.getElementById('login-result'), result, result.success);
            
            if (result.success && result.data?.token) {
                authToken = result.data.token;
                refreshToken = result.data.refreshToken || '';
                currentUser = result.data.user;
                localStorage.setItem(API.AUTH_TOKEN_KEY, authToken);
                localStorage.setItem('refreshToken', refreshToken);
                localStorage.setItem(API.USER_KEY, JSON.stringify(currentUser));
                updateLoginStatus();
                
                // 自动切换到用户信息页面
                document.querySelector('[data-tab="user"]').click();
            }
        }
        
        // 获取个人资料
        async function handleGetProfile() {
            if (!authToken) {
                formatResult(document.getElementById('profile-result'), '请先登录', false);
                return;
            }
            
            const result = await callApi('/users/me', 'GET', null, true);
            formatResult(document.getElementById('profile-result'), result, result.success);
            
            if (result.success) {
                document.getElementById('update-name').value = result.data.user.name || '';
                document.getElementById('update-phone').value = result.data.user.phone || '';
                document.getElementById('update-company').value = result.data.user.company || '';
                document.getElementById('update-industry').value = result.data.user.industry || '';
                document.getElementById('update-position').value = result.data.user.position || '';
            }
        }
        
        // 更新个人资料
        async function handleUpdateProfile() {
            if (!authToken) {
                formatResult(document.getElementById('update-profile-result'), '请先登录', false);
                return;
            }
            
            const name = document.getElementById('update-name').value;
            const phone = document.getElementById('update-phone').value;
            const company = document.getElementById('update-company').value;
            const industry = document.getElementById('update-industry').value;
            const position = document.getElementById('update-position').value;
            
            if (!name) {
                formatResult(document.getElementById('update-profile-result'), '名称不能为空', false);
                return;
            }
            
            const result = await callApi('/users/me', 'PUT', {
                name,
                phone,
                company,
                industry,
                position
            }, true);
            formatResult(document.getElementById('update-profile-result'), result, result.success);
        }
        
        // 获取咨询次数
        async function handleGetQueries() {
            if (!authToken) {
                formatResult(document.getElementById('queries-result'), '请先登录', false);
                return;
            }
            
            const result = await callApi('/users/me', 'GET', null, true);
            
            if (result.success) {
                const queryInfo = {
                    remainingQueries: result.data.user.remainingQueries,
                    totalConsultations: result.data.user.totalConsultations
                };
                formatResult(document.getElementById('queries-result'), queryInfo, true);
            } else {
                formatResult(document.getElementById('queries-result'), result, false);
            }
        }
        
        // 使用一次咨询
        async function handleDecreaseQuery() {
            if (!authToken) {
                formatResult(document.getElementById('decrease-result'), '请先登录', false);
                return;
            }
            
            const result = await callApi('/users/me/queries/decrease', 'POST', null, true);
            formatResult(document.getElementById('decrease-result'), result, result.success);
        }
        
        // 增加咨询次数 (管理员功能)
        async function handleIncreaseQueries() {
            if (!authToken) {
                formatResult(document.getElementById('increase-result'), '请先登录', false);
                return;
            }
            
            const userId = document.getElementById('target-user-id').value;
            const amount = parseInt(document.getElementById('increase-amount').value) || 1;
            
            if (!userId) {
                formatResult(document.getElementById('increase-result'), '请输入目标用户ID', false);
                return;
            }
            
            try {
                // 使用正確的Admin API路徑
                const url = `${API.BASE_URL}/admin/users/${userId}/queries/increase`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ amount })
                });
                
                const result = await response.json();
                formatResult(document.getElementById('increase-result'), result, result.success);
            } catch (error) {
                formatResult(document.getElementById('increase-result'), {
                    success: false,
                    message: `操作失敗: ${error.message}`,
                    error: { code: 'REQUEST_ERROR', details: error.toString() }
                }, false);
            }
        }
        
        // 获取用户列表
        async function handleGetUsers() {
            if (!authToken) {
                formatResult(document.getElementById('admin-users-result'), '请先登录', false);
                return;
            }
            
            const search = document.getElementById('admin-search-user').value;
            const userType = document.getElementById('admin-filter-userType').value;
            const status = document.getElementById('admin-filter-status').value;
            const dateRange = document.getElementById('admin-filter-dateRange').value;
            
            let queryParams = '?';
            if (search) queryParams += `search=${encodeURIComponent(search)}&`;
            if (userType && userType !== 'all') queryParams += `userType=${userType}&`;
            if (status && status !== 'all') queryParams += `status=${status}&`;
            if (dateRange && dateRange !== 'all') queryParams += `dateRange=${dateRange}&`;
            
            const result = await callApi(`/admin/users${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('admin-users-result'), result, result.success);
        }
        
        // 导出用户数据
        async function handleExportUsers() {
            if (!authToken) {
                formatResult(document.getElementById('admin-users-result'), '请先登录', false);
                return;
            }
            
            const search = document.getElementById('admin-search-user').value;
            const userType = document.getElementById('admin-filter-userType').value;
            const status = document.getElementById('admin-filter-status').value;
            const dateRange = document.getElementById('admin-filter-dateRange').value;
            
            let queryParams = '?';
            if (search) queryParams += `search=${encodeURIComponent(search)}&`;
            if (userType && userType !== 'all') queryParams += `userType=${userType}&`;
            if (status && status !== 'all') queryParams += `status=${status}&`;
            if (dateRange && dateRange !== 'all') queryParams += `dateRange=${dateRange}&`;
            
            // 下载CSV文件
            window.open(`${API.BASE_URL}/admin/users/export${queryParams}`, '_blank');
        }
        
        // 创建用户
        async function handleCreateUser() {
            if (!authToken) {
                formatResult(document.getElementById('admin-create-result'), '请先登录', false);
                return;
            }
            
            const name = document.getElementById('admin-add-name').value;
            const email = document.getElementById('admin-add-email').value;
            const password = document.getElementById('admin-add-password').value;
            const userType = document.getElementById('admin-add-userType').value;
            const phone = document.getElementById('admin-add-phone').value;
            const company = document.getElementById('admin-add-company').value;
            const industry = document.getElementById('admin-add-industry').value;
            const position = document.getElementById('admin-add-position').value;
            const queries = parseInt(document.getElementById('admin-add-queries').value) || 5;
            
            if (!name || !email || !password) {
                formatResult(document.getElementById('admin-create-result'), '请填写必要信息', false);
                return;
            }
            
            const result = await callApi('/admin/users', 'POST', {
                name,
                email,
                password,
                userType,
                phone,
                company,
                industry,
                position,
                queries
            }, true);
            formatResult(document.getElementById('admin-create-result'), result, result.success);
        }
        
        // 获取用户详情
        async function handleGetUserDetail() {
            if (!authToken) {
                formatResult(document.getElementById('admin-user-detail-result'), '请先登录', false);
                return;
            }
            
            const userId = document.getElementById('admin-view-userId').value;
            if (!userId) {
                formatResult(document.getElementById('admin-user-detail-result'), '请输入用户ID', false);
                return;
            }
            
            const result = await callApi(`/admin/users/${userId}`, 'GET', null, true);
            formatResult(document.getElementById('admin-user-detail-result'), result, result.success);
        }

        // 快速登入功能
        async function handleQuickLogin(credentials) {
            try {
                const resultElement = document.getElementById('quick-login-result');
                resultElement.innerHTML = '登入中...';
                
                // 正确的登入数据结构
                const loginData = {
                    email: credentials.email,
                    password: credentials.password
                };
                
                console.log('快速登入尝试:', loginData);
                
                // 使用管理員登入API
                const loginResult = await callApi('/admin/auth/login', 'POST', loginData);
                console.log('登入结果:', loginResult);
                
                if (loginResult.success) {
                    // 登入成功 - 注意Admin模型返回的資料結構不同
                    authToken = loginResult.data.tokens.access_token;
                    refreshToken = loginResult.data.tokens.refresh_token || '';
                    currentUser = loginResult.data.admin;
                    
                    // 更新所有存储
                    localStorage.setItem(API.AUTH_TOKEN_KEY, authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    localStorage.setItem(API.USER_KEY, JSON.stringify(currentUser));
                    
                    // 更新全局变量（确保与其他函数同步）
                    window.authToken = authToken;
                    window.currentUser = currentUser;
                    
                    updateLoginStatus();
                    
                    formatResult(resultElement, {
                        success: true,
                        message: `✅ 成功以 ${currentUser.username} (${currentUser.role}) 身份登入`,
                        data: {
                            admin: currentUser,
                            tokenLength: authToken.length
                        }
                    }, true);
                    
                    // 自動切換到管理頁面
                    document.querySelector('[data-tab="admin"]').click();
                    return;
                }
                
                // 登入失敗
                formatResult(resultElement, {
                    success: false,
                    message: `❌ 登入失敗: ${loginResult.message}`,
                    error: loginResult.error || { code: loginResult.code }
                }, false);
                
            } catch (error) {
                console.error('快速登入错误:', error);
                formatResult(document.getElementById('quick-login-result'), {
                    success: false,
                    message: `🚨 快速登入時發生錯誤: ${error.message}`,
                    error: { stack: error.stack }
                }, false);
            }
        }

        // ==============================================
        // 聊天模块功能实现
        // ==============================================
        
        // 聊天模块状态管理
        const ChatModule = {
            currentSession: null,
            sessionList: [],
            
            setCurrentSession(session) {
                this.currentSession = session;
                this.updateSessionInfo();
                
                // 自动填充相关输入框
                const sessionId = session?.sessionId || '';
                document.getElementById('message-session-id').value = sessionId;
                document.getElementById('messages-session-id').value = sessionId;
                document.getElementById('session-detail-id').value = sessionId;
                document.getElementById('update-session-id').value = sessionId;
            },
            
            updateSessionInfo() {
                const infoDiv = document.getElementById('current-session-info');
                if (this.currentSession) {
                    infoDiv.innerHTML = `
                        <div style="background-color: #d4edda; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb;">
                            <strong>📋 當前會話：</strong>${this.currentSession.title}<br>
                            <strong>🆔 會話ID：</strong><code>${this.currentSession.sessionId}</code><br>
                            <strong>💬 消息數量：</strong>${this.currentSession.messageCount || 0}<br>
                            <strong>📅 創建時間：</strong>${new Date(this.currentSession.createdAt).toLocaleString()}
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = '<p style="color: #666;">尚未選擇會話</p>';
                }
            }
        };
        
        // 初始化聊天模块事件监听器
        function initChatEventListeners() {
            // 会话状态
            document.getElementById('refresh-session-info-btn').addEventListener('click', () => {
                ChatModule.updateSessionInfo();
            });
            
            // 用户端API - 会话管理
            document.getElementById('create-session-btn').addEventListener('click', handleCreateSession);
            document.getElementById('get-sessions-btn').addEventListener('click', handleGetSessions);
            document.getElementById('get-session-detail-btn').addEventListener('click', handleGetSessionDetail);
            document.getElementById('update-session-title-btn').addEventListener('click', handleUpdateSessionTitle);
            document.getElementById('delete-session-btn').addEventListener('click', handleDeleteSession);
            
            // 用户端API - 消息处理
            document.getElementById('send-message-btn').addEventListener('click', handleSendMessage);
            document.getElementById('get-messages-btn').addEventListener('click', handleGetMessages);
            document.getElementById('submit-feedback-btn').addEventListener('click', handleSubmitFeedback);
            
            // 快速测试工具
            document.getElementById('quick-test-btn').addEventListener('click', handleQuickTest);
            document.querySelectorAll('.preset-question-btn').forEach(btn => {
                btn.addEventListener('click', handlePresetQuestion);
            });
            document.getElementById('test-invalid-session-btn').addEventListener('click', () => handleErrorTest('invalid-session'));
            document.getElementById('test-empty-message-btn').addEventListener('click', () => handleErrorTest('empty-message'));
            document.getElementById('test-no-auth-btn').addEventListener('click', () => handleErrorTest('no-auth'));
            
            // 管理员API
            document.getElementById('admin-get-sessions-btn').addEventListener('click', handleAdminGetSessions);
            document.getElementById('admin-get-session-detail-btn').addEventListener('click', handleAdminGetSessionDetail);
            document.getElementById('get-chat-stats-btn').addEventListener('click', handleGetChatStats);
            document.getElementById('export-chat-records-btn').addEventListener('click', handleExportChatRecords);
            
            // N8N服务测试
            document.getElementById('check-n8n-status-btn').addEventListener('click', handleCheckN8NStatus);
            document.getElementById('test-n8n-connection-btn').addEventListener('click', handleTestN8NConnection);
            document.getElementById('direct-n8n-test-btn').addEventListener('click', handleDirectN8NTest);
            
            // 专家咨询模块
            document.getElementById('refresh-expert-info-btn').addEventListener('click', handleRefreshExpertInfo);
            document.getElementById('submit-expert-consultation-btn').addEventListener('click', handleSubmitExpertConsultation);
            document.getElementById('get-my-consultations-btn').addEventListener('click', handleGetMyConsultations);
            document.getElementById('get-consultation-detail-btn').addEventListener('click', handleGetConsultationDetail);
            document.getElementById('cancel-consultation-btn').addEventListener('click', handleCancelConsultation);
            document.getElementById('get-admin-consultations-btn').addEventListener('click', handleGetAdminConsultations);
            document.getElementById('update-consultation-btn').addEventListener('click', handleUpdateConsultation);
            document.getElementById('delete-consultation-btn').addEventListener('click', handleDeleteConsultation);
            document.getElementById('get-consultation-stats-btn').addEventListener('click', handleGetConsultationStats);
            document.getElementById('expert-quick-test-btn').addEventListener('click', handleExpertQuickTest);
            document.getElementById('test-validation-btn').addEventListener('click', handleTestValidation);
            document.getElementById('test-model-methods-btn').addEventListener('click', handleTestModelMethods);
            
            // 劳资顾问管理模块
            document.getElementById('get-advisor-list-btn').addEventListener('click', handleGetAdvisorList);
            document.getElementById('create-advisor-btn').addEventListener('click', handleCreateAdvisor);
            document.getElementById('get-advisor-detail-btn').addEventListener('click', handleGetAdvisorDetail);
            document.getElementById('update-advisor-btn').addEventListener('click', handleUpdateAdvisor);
            document.getElementById('toggle-advisor-status-btn').addEventListener('click', handleToggleAdvisorStatus);
            document.getElementById('delete-advisor-btn').addEventListener('click', handleDeleteAdvisor);
            document.getElementById('search-available-advisors-btn').addEventListener('click', handleSearchAdvisors);
            document.getElementById('get-advisor-statistics-btn').addEventListener('click', handleGetAdvisorStats);
            document.getElementById('manual-assign-advisor-btn').addEventListener('click', handleManualAssign);
            document.getElementById('auto-assign-advisor-btn').addEventListener('click', handleAutoAssign);
            document.getElementById('assignment-history-btn').addEventListener('click', handleGetAssignmentHistory);
            document.getElementById('advisor-quick-test-btn').addEventListener('click', handleAdvisorQuickTest);
            document.getElementById('e2e-assignment-test-btn').addEventListener('click', handleEndToEndAssignmentTest);
            
            // 自动设置今天的日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('stats-start-date').value = today;
            document.getElementById('stats-end-date').value = today;
            document.getElementById('export-start-date').value = today;
            document.getElementById('export-end-date').value = today;
            document.getElementById('advisor-stats-start-date').value = today;
            document.getElementById('advisor-stats-end-date').value = today;
        }
        
        // ==============================
        // 专家咨询模块处理函数
        // ==============================
        
        // 刷新专家咨询模块状态
        async function handleRefreshExpertInfo() {
            const infoDiv = document.getElementById('expert-module-info');
            infoDiv.innerHTML = `
                <p>📋 專家諮詢模組狀態：<span style="color: #27ae60;">運行中</span></p>
                <p>🔗 API端點：/api/v1/expert-consultations</p>
                <p>⚡ 後端服務：${authToken ? '已連接' : '未認證'}</p>
                <p>🕒 刷新時間：${new Date().toLocaleString()}</p>
            `;
        }
        
        // 提交专家咨询申请
        async function handleSubmitExpertConsultation() {
            const name = document.getElementById('expert-name').value;
            const phone = document.getElementById('expert-phone').value;
            const email = document.getElementById('expert-email').value;
            const lineId = document.getElementById('expert-line-id').value;
            const service = document.getElementById('expert-service-type').value;
            const details = document.getElementById('expert-details').value;
            
            // 获取选中的联系方式
            const preferredContact = [];
            if (document.getElementById('contact-phone').checked) preferredContact.push('phone');
            if (document.getElementById('contact-email').checked) preferredContact.push('email');
            if (document.getElementById('contact-line').checked) preferredContact.push('line');
            
            const timeOfDay = document.getElementById('expert-time-of-day').value;
            const startTime = document.getElementById('expert-start-time').value;
            const endTime = document.getElementById('expert-end-time').value;
            
            // === MVP新增字段 ===
            const region = document.getElementById('expert-region').value;
            const simplifiedTime = document.getElementById('expert-simplified-time').value;
            
            if (!name || !phone || !service || !details || preferredContact.length === 0) {
                formatResult(document.getElementById('submit-expert-consultation-result'), '請填寫所有必填項目', false);
                return;
            }
            
            const data = {
                name,
                phone,
                email: email || null,
                lineId: lineId || null,
                service,
                details,
                preferredContact,
                timeOfDay: timeOfDay || null,
                startTime: startTime || null,
                endTime: endTime || null,
                // === MVP新增字段 ===
                region: region || null,
                simplifiedTime: simplifiedTime || null
            };
            
            const result = await callApi('/expert-consultations', 'POST', data, true);
            formatResult(document.getElementById('submit-expert-consultation-result'), result, result.success);
            
            if (result.success && result.data) {
                // 自动填充申请ID到详情查询
                document.getElementById('consultation-detail-id').value = result.data.customId;
                
                formatResult(document.getElementById('submit-expert-consultation-result'), {
                    ...result,
                    message: `✅ 申請提交成功！申請ID: ${result.data.customId}`
                }, true);
            }
        }
        
        // 获取我的咨询申请列表
        async function handleGetMyConsultations() {
            if (!authToken || !currentUser) {
                formatResult(document.getElementById('get-my-consultations-result'), '請先登錄', false);
                return;
            }
            
            const page = document.getElementById('my-consultations-page').value || 1;
            const limit = document.getElementById('my-consultations-limit').value || 10;
            const status = document.getElementById('my-consultations-status').value;
            
            let queryParams = `?page=${page}&limit=${limit}`;
            if (status) queryParams += `&status=${status}`;
            
            const result = await callApi(`/expert-consultations/user/${currentUser.id}${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('get-my-consultations-result'), result, result.success);
        }
        
        // 获取咨询申请详情
        async function handleGetConsultationDetail() {
            const consultationId = document.getElementById('consultation-detail-id').value;
            if (!consultationId) {
                formatResult(document.getElementById('get-consultation-detail-result'), '請輸入申請ID', false);
                return;
            }
            
            const result = await callApi(`/expert-consultations/${consultationId}`, 'GET', null, authToken ? true : false);
            formatResult(document.getElementById('get-consultation-detail-result'), result, result.success);
            
            if (result.success && result.data) {
                // 自动填充到取消申请表单
                document.getElementById('cancel-consultation-id').value = consultationId;
                
                // 如果是管理员，也填充到更新表单
                if (currentUser && currentUser.userType === 'admin') {
                    document.getElementById('update-consultation-id').value = consultationId;
                    document.getElementById('update-consultation-status').value = result.data.status;
                    document.getElementById('delete-consultation-id').value = consultationId;
                }
            }
        }
        
        // 取消咨询申请
        async function handleCancelConsultation() {
            if (!authToken) {
                formatResult(document.getElementById('cancel-consultation-result'), '請先登錄', false);
                return;
            }
            
            const consultationId = document.getElementById('cancel-consultation-id').value;
            const reason = document.getElementById('cancel-reason').value;
            
            if (!consultationId) {
                formatResult(document.getElementById('cancel-consultation-result'), '請輸入申請ID', false);
                return;
            }
            
            if (!confirm(`確定要取消申請 ${consultationId} 嗎？`)) {
                return;
            }
            
            const data = reason ? { reason } : {};
            const result = await callApi(`/expert-consultations/${consultationId}/cancel`, 'PUT', data, true);
            formatResult(document.getElementById('cancel-consultation-result'), result, result.success);
        }
        
        // 管理员获取所有咨询申请
        async function handleGetAdminConsultations() {
            if (!authToken) {
                formatResult(document.getElementById('get-admin-consultations-result'), '請先登錄', false);
                return;
            }
            
            const page = document.getElementById('admin-consultations-page').value || 1;
            const limit = document.getElementById('admin-consultations-limit').value || 10;
            const status = document.getElementById('admin-consultations-status').value;
            const serviceType = document.getElementById('admin-consultations-service').value;
            const search = document.getElementById('admin-consultations-search').value;
            const region = document.getElementById('admin-consultations-region').value;
            const advisorId = document.getElementById('admin-consultations-advisor').value;
            
            let queryParams = `?page=${page}&limit=${limit}`;
            if (status) queryParams += `&status=${status}`;
            if (serviceType) queryParams += `&service_type=${serviceType}`;
            if (search) queryParams += `&search=${encodeURIComponent(search)}`;
            if (region) queryParams += `&region=${encodeURIComponent(region)}`;
            if (advisorId) queryParams += `&assigned_advisor_id=${encodeURIComponent(advisorId)}`;
            
            const result = await callApi(`/expert-consultations/admin/list${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('get-admin-consultations-result'), result, result.success);
        }
        
        // 管理员更新咨询申请
        async function handleUpdateConsultation() {
            if (!authToken) {
                formatResult(document.getElementById('update-consultation-result'), '請先登錄', false);
                return;
            }
            
            const consultationId = document.getElementById('update-consultation-id').value;
            const status = document.getElementById('update-consultation-status').value;
            const adminNotes = document.getElementById('update-admin-notes').value;
            const assignAdvisor = document.getElementById('update-assign-advisor').value;
            const forceUpdate = document.getElementById('update-force-update').checked;
            
            if (!consultationId) {
                formatResult(document.getElementById('update-consultation-result'), '請輸入申請ID', false);
                return;
            }
            
            const data = {};
            if (status) data.status = status;
            if (adminNotes) data.adminNotes = adminNotes;
            if (assignAdvisor) data.assigned_advisor_id = assignAdvisor;
            if (forceUpdate) data.forceUpdate = true;
            
            const result = await callApi(`/expert-consultations/admin/${consultationId}`, 'PUT', data, true);
            formatResult(document.getElementById('update-consultation-result'), result, result.success);
        }
        
        // 管理员删除咨询申请
        async function handleDeleteConsultation() {
            if (!authToken) {
                formatResult(document.getElementById('delete-consultation-result'), '請先登錄', false);
                return;
            }
            
            const consultationId = document.getElementById('delete-consultation-id').value;
            if (!consultationId) {
                formatResult(document.getElementById('delete-consultation-result'), '請輸入申請ID', false);
                return;
            }
            
            if (!confirm(`確定要刪除申請 ${consultationId} 嗎？此操作無法撤銷。`)) {
                return;
            }
            
            const result = await callApi(`/expert-consultations/admin/${consultationId}`, 'DELETE', null, true);
            formatResult(document.getElementById('delete-consultation-result'), result, result.success);
        }
        
        // 获取咨询统计数据
        async function handleGetConsultationStats() {
            if (!authToken) {
                formatResult(document.getElementById('get-consultation-stats-result'), '請先登錄', false);
                return;
            }
            
            const startDate = document.getElementById('stats-start-date').value;
            const endDate = document.getElementById('stats-end-date').value;
            
            let queryParams = '';
            if (startDate) queryParams += `?startDate=${startDate}`;
            if (endDate) queryParams += `${queryParams ? '&' : '?'}endDate=${endDate}`;
            
            const result = await callApi(`/expert-consultations/admin/statistics${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('get-consultation-stats-result'), result, result.success);
        }
        
        // 专家咨询快速测试
        async function handleExpertQuickTest() {
            const resultDiv = document.getElementById('expert-quick-test-result');
            resultDiv.innerHTML = '<p style="color: #f39c12;">🚀 開始專家諮詢一鍵測試流程...</p>';
            
            try {
                // 1. 提交咨询申请
                resultDiv.innerHTML += '<p>📝 步驟1: 提交測試申請...</p>';
                const submitResult = await callApi('/expert-consultations', 'POST', {
                    name: '一鍵測試用戶',
                    phone: '0987654321',
                    email: 'quicktest@example.com',
                    service: 'labor_contract',
                    details: '這是一鍵測試提交的專家諮詢申請，測試系統功能是否正常運作。',
                    preferredContact: ['email', 'phone']
                }, true);
                
                if (!submitResult.success) {
                    throw new Error('提交申請失敗: ' + submitResult.message);
                }
                
                const consultationId = submitResult.data.customId;
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 申請提交成功: ${consultationId}</p>`;
                
                // 2. 获取申请详情
                resultDiv.innerHTML += '<p>🔍 步驟2: 獲取申請詳情...</p>';
                const detailResult = await callApi(`/expert-consultations/${consultationId}`, 'GET', null, false);
                
                if (!detailResult.success) {
                    throw new Error('獲取詳情失敗: ' + detailResult.message);
                }
                
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 詳情獲取成功</p>`;
                
                // 3. 如果是管理员，测试状态更新
                if (authToken && currentUser && currentUser.userType === 'admin') {
                    resultDiv.innerHTML += '<p>👨‍💼 步驟3: 測試管理員功能...</p>';
                    const updateResult = await callApi(`/expert-consultations/admin/${consultationId}`, 'PUT', {
                        status: 'processing',
                        adminNotes: '一鍵測試：狀態更新為處理中'
                    }, true);
                    
                    if (updateResult.success) {
                        resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 狀態更新成功</p>`;
                    }
                }
                
                formatResult(resultDiv, {
                    success: true,
                    message: '🎉 專家諮詢一鍵測試完成！',
                    data: {
                        consultationId: consultationId,
                        steps: [
                            '✅ 申請提交成功',
                            '✅ 詳情獲取成功',
                            authToken && currentUser?.userType === 'admin' ? '✅ 管理員功能測試成功' : '⏭️ 跳過管理員功能（非管理員用戶）'
                        ],
                        submitResult: submitResult.data,
                        detailResult: detailResult.data
                    }
                }, true);
                
            } catch (error) {
                formatResult(resultDiv, {
                    success: false,
                    message: '一鍵測試失敗',
                    error: { details: error.message }
                }, false);
            }
        }
        
        // 测试验证规则
        async function handleTestValidation() {
            const resultDiv = document.getElementById('test-validation-result');
            resultDiv.innerHTML = '<p style="color: #f39c12;">🧪 開始驗證規則測試...</p>';
            
            const invalidData = {
                name: '', // 空姓名
                phone: '123', // 无效手机号
                email: 'invalid-email', // 无效邮箱
                service: 'invalid_service', // 无效服务类型
                details: '短', // 太短的详情
                preferredContact: [] // 空联系方式
            };
            
            const result = await callApi('/expert-consultations', 'POST', invalidData, true);
            
            if (!result.success && result.error && result.error.details) {
                formatResult(resultDiv, {
                    success: true,
                    message: '✅ 驗證規則正常工作！成功阻止了無效數據',
                    data: {
                        testData: invalidData,
                        validationErrors: result.error.details
                    }
                }, true);
            } else {
                formatResult(resultDiv, {
                    success: false,
                    message: '❌ 驗證規則可能有問題',
                    data: result
                }, false);
            }
        }
        
        // 测试模型方法
        async function handleTestModelMethods() {
            const result = await callApi('/test/expert-consultation/model-test', 'GET', null, false);
            formatResult(document.getElementById('test-model-methods-result'), result, result.success);
        }
        
        // ==============================
        // 劳资顾问管理系统函数
        // ==============================
        
        // 1. 获取顾问列表
        async function handleGetAdvisorList() {
            if (!authToken) {
                formatResult(document.getElementById('get-advisor-list-result'), '請先登錄', false);
                return;
            }
            
            const page = document.getElementById('advisor-list-page').value || 1;
            const limit = document.getElementById('advisor-list-limit').value || 10;
            const region = document.getElementById('advisor-list-region').value;
            const specialty = document.getElementById('advisor-list-specialty').value;
            const isActive = document.getElementById('advisor-list-status').value;
            const search = document.getElementById('advisor-list-search').value;
            
            let queryParams = `?page=${page}&limit=${limit}`;
            if (region) queryParams += `&region=${encodeURIComponent(region)}`;
            if (specialty) queryParams += `&specialty=${specialty}`;
            if (isActive !== '') queryParams += `&is_active=${isActive}`;
            if (search) queryParams += `&search=${encodeURIComponent(search)}`;
            
            const result = await callApi(`/labor-advisors${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('get-advisor-list-result'), result, result.success);
        }
        
        // 2. 创建新顾问
        async function handleCreateAdvisor() {
            if (!authToken) {
                formatResult(document.getElementById('create-advisor-result'), '請先登錄', false);
                return;
            }
            
            const name = document.getElementById('create-advisor-name').value;
            const phone = document.getElementById('create-advisor-phone').value;
            const email = document.getElementById('create-advisor-email').value;
            const lineId = document.getElementById('create-advisor-line').value;
            const region = document.getElementById('create-advisor-region').value;
            const notes = document.getElementById('create-advisor-notes').value;
            
            // 获取选中的专业领域
            const specialties = [];
            document.querySelectorAll('.advisor-specialty:checked').forEach(checkbox => {
                specialties.push(checkbox.value);
            });
            
            if (!name || !phone || !email || !region || specialties.length === 0) {
                formatResult(document.getElementById('create-advisor-result'), '請填寫所有必填項目', false);
                return;
            }
            
            const data = {
                name,
                phone,
                email,
                lineId: lineId || null,
                region,
                specialties,
                notes: notes || null
            };
            
            const result = await callApi('/labor-advisors', 'POST', data, true);
            formatResult(document.getElementById('create-advisor-result'), result, result.success);
            
            if (result.success) {
                // 自动填充顾问ID到其他操作表单
                const advisorId = result.data.id;
                document.getElementById('advisor-detail-id').value = advisorId;
                document.getElementById('update-advisor-id').value = advisorId;
                document.getElementById('toggle-advisor-id').value = advisorId;
                
                formatResult(document.getElementById('create-advisor-result'), {
                    ...result,
                    message: `✅ 顧問創建成功！顧問ID: ${advisorId}`
                }, true);
            }
        }
        
        // 3. 获取顾问详情
        async function handleGetAdvisorDetail() {
            if (!authToken) {
                formatResult(document.getElementById('get-advisor-detail-result'), '請先登錄', false);
                return;
            }
            
            const advisorId = document.getElementById('advisor-detail-id').value;
            if (!advisorId) {
                formatResult(document.getElementById('get-advisor-detail-result'), '請輸入顧問ID', false);
                return;
            }
            
            const result = await callApi(`/labor-advisors/${advisorId}`, 'GET', null, true);
            formatResult(document.getElementById('get-advisor-detail-result'), result, result.success);
        }
        
        // 4. 更新顾问信息
        async function handleUpdateAdvisor() {
            if (!authToken) {
                formatResult(document.getElementById('update-advisor-result'), '請先登錄', false);
                return;
            }
            
            const advisorId = document.getElementById('update-advisor-id').value;
            const name = document.getElementById('update-advisor-name').value;
            const phone = document.getElementById('update-advisor-phone').value;
            const region = document.getElementById('update-advisor-region').value;
            const notes = document.getElementById('update-advisor-notes').value;
            
            if (!advisorId) {
                formatResult(document.getElementById('update-advisor-result'), '請輸入顧問ID', false);
                return;
            }
            
            const data = {};
            if (name) data.name = name;
            if (phone) data.phone = phone;
            if (region) data.region = region;
            if (notes) data.notes = notes;
            
            if (Object.keys(data).length === 0) {
                formatResult(document.getElementById('update-advisor-result'), '請至少填寫一個要更新的字段', false);
                return;
            }
            
            const result = await callApi(`/labor-advisors/${advisorId}`, 'PUT', data, true);
            formatResult(document.getElementById('update-advisor-result'), result, result.success);
        }
        
        // 5. 切换顾问状态
        async function handleToggleAdvisorStatus() {
            if (!authToken) {
                formatResult(document.getElementById('toggle-advisor-status-result'), '請先登錄', false);
                return;
            }
            
            const advisorId = document.getElementById('toggle-advisor-id').value;
            if (!advisorId) {
                formatResult(document.getElementById('toggle-advisor-status-result'), '請輸入顧問ID', false);
                return;
            }
            
            const result = await callApi(`/labor-advisors/${advisorId}/toggle-status`, 'PUT', null, true);
            formatResult(document.getElementById('toggle-advisor-status-result'), result, result.success);
        }
        
        // 6. 删除顾问
        async function handleDeleteAdvisor() {
            if (!authToken) {
                formatResult(document.getElementById('delete-advisor-result'), '請先登錄', false);
                return;
            }
            
            const advisorId = document.getElementById('delete-advisor-id').value;
            if (!advisorId) {
                formatResult(document.getElementById('delete-advisor-result'), '請輸入顧問ID', false);
                return;
            }
            
            if (!confirm(`確定要刪除顧問 ${advisorId} 嗎？此操作無法撤銷。`)) {
                return;
            }
            
            const result = await callApi(`/labor-advisors/${advisorId}`, 'DELETE', null, true);
            formatResult(document.getElementById('delete-advisor-result'), result, result.success);
        }
        
        // 7. 搜索可用顾问
        async function handleSearchAdvisors() {
            if (!authToken) {
                formatResult(document.getElementById('search-available-advisors-result'), '請先登錄', false);
                return;
            }
            
            const region = document.getElementById('search-advisor-region').value;
            const specialty = document.getElementById('search-advisor-specialty').value;
            const workload = document.getElementById('search-advisor-workload').value;
            
            let queryParams = '';
            if (region) queryParams += `?region=${encodeURIComponent(region)}`;
            if (specialty) queryParams += `${queryParams ? '&' : '?'}specialty=${specialty}`;
            if (workload) queryParams += `${queryParams ? '&' : '?'}workload=${workload}`;
            
            const result = await callApi(`/labor-advisors/search${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('search-available-advisors-result'), result, result.success);
        }
        
        // 8. 获取顾问统计数据
        async function handleGetAdvisorStats() {
            if (!authToken) {
                formatResult(document.getElementById('get-advisor-statistics-result'), '請先登錄', false);
                return;
            }
            
            const startDate = document.getElementById('advisor-stats-start-date').value;
            const endDate = document.getElementById('advisor-stats-end-date').value;
            
            let queryParams = '';
            if (startDate) queryParams += `?startDate=${startDate}`;
            if (endDate) queryParams += `${queryParams ? '&' : '?'}endDate=${endDate}`;
            
            const result = await callApi(`/labor-advisors/statistics${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('get-advisor-statistics-result'), result, result.success);
        }
        
        // 9. 手动指派顾问
        async function handleManualAssign() {
            if (!authToken) {
                formatResult(document.getElementById('manual-assign-advisor-result'), '請先登錄', false);
                return;
            }
            
            const consultationId = document.getElementById('manual-assign-consultation').value;
            const advisorId = document.getElementById('manual-assign-advisor').value;
            
            if (!consultationId || !advisorId) {
                formatResult(document.getElementById('manual-assign-advisor-result'), '請輸入咨詢申請ID和顧問ID', false);
                return;
            }
            
            // 调试输出：显示即将发送的数据
            const requestData = { advisorId: advisorId };
            console.log('🔍 手動指派調試信息:', {
                consultationId: consultationId,
                advisorId: advisorId,
                requestData: requestData,
                url: `/labor-advisors/assign/${consultationId}`,
                timestamp: new Date().toISOString()
            });
            
            const result = await callApi(`/labor-advisors/assign/${consultationId}`, 'PUT', requestData, true);
            formatResult(document.getElementById('manual-assign-advisor-result'), result, result.success);
        }
        
        // 10. 自动指派顾问
        async function handleAutoAssign() {
            if (!authToken) {
                formatResult(document.getElementById('auto-assign-advisor-result'), '請先登錄', false);
                return;
            }
            
            const consultationId = document.getElementById('auto-assign-consultation').value;
            if (!consultationId) {
                formatResult(document.getElementById('auto-assign-advisor-result'), '請輸入咨詢申請ID', false);
                return;
            }
            
            const result = await callApi(`/labor-advisors/auto-assign/${consultationId}`, 'POST', null, true);
            formatResult(document.getElementById('auto-assign-advisor-result'), result, result.success);
        }
        
        // 11. 获取指派历史
        async function handleGetAssignmentHistory() {
            if (!authToken) {
                formatResult(document.getElementById('assignment-history-result'), '請先登錄', false);
                return;
            }
            
            const consultationId = document.getElementById('assignment-history-consultation').value;
            if (!consultationId) {
                formatResult(document.getElementById('assignment-history-result'), '請輸入咨詢申請ID', false);
                return;
            }
            
            const result = await callApi(`/labor-advisors/assignment-history/${consultationId}`, 'GET', null, true);
            formatResult(document.getElementById('assignment-history-result'), result, result.success);
        }
        
        // 劳资顾问快速测试
        async function handleAdvisorQuickTest() {
            const resultDiv = document.getElementById('advisor-quick-test-result');
            resultDiv.innerHTML = '<p style="color: #f39c12;">🚀 開始劳资顾问管理一鍵測試流程...</p>';
            
            try {
                // 1. 创建测试顾问
                resultDiv.innerHTML += '<p>👥 步驟1: 創建測試顧問...</p>';
                const createResult = await callApi('/labor-advisors', 'POST', {
                    name: '一鍵測試顧問',
                    phone: '02-87654321',
                    email: `quicktest.advisor.${Date.now()}@example.com`,
                    region: '台北市',
                    specialties: ['labor_contract', 'compensation'],
                    notes: '這是一鍵測試創建的顧問'
                }, true);
                
                if (!createResult.success) {
                    throw new Error('創建顧問失敗: ' + createResult.message);
                }
                
                const advisorId = createResult.data.id;
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 顧問創建成功: ${advisorId}</p>`;
                
                // 2. 获取顾问详情
                resultDiv.innerHTML += '<p>🔍 步驟2: 獲取顧問詳情...</p>';
                const detailResult = await callApi(`/labor-advisors/${advisorId}`, 'GET', null, true);
                
                if (!detailResult.success) {
                    throw new Error('獲取顧問詳情失敗: ' + detailResult.message);
                }
                
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 顧問詳情獲取成功</p>`;
                
                // 3. 测试顾问搜索
                resultDiv.innerHTML += '<p>🔍 步驟3: 測試顧問搜索...</p>';
                const searchResult = await callApi('/labor-advisors/search?region=台北市&specialty=labor_contract', 'GET', null, true);
                
                if (searchResult.success) {
                    resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 顧問搜索成功，找到 ${searchResult.data.total_found || 0} 位顧問</p>`;
                }
                
                // 4. 清理测试数据
                resultDiv.innerHTML += '<p>🗑️ 步驟4: 清理測試數據...</p>';
                const deleteResult = await callApi(`/labor-advisors/${advisorId}`, 'DELETE', null, true);
                
                if (deleteResult.success) {
                    resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 測試數據清理完成</p>`;
                }
                
                formatResult(resultDiv, {
                    success: true,
                    message: '🎉 劳资顾问管理一鍵測試完成！',
                    data: {
                        advisorId: advisorId,
                        steps: [
                            '✅ 顧問創建成功',
                            '✅ 顧問詳情獲取成功',
                            '✅ 顧問搜索測試成功',
                            '✅ 測試數據清理完成'
                        ],
                        createResult: createResult.data,
                        detailResult: detailResult.data,
                        searchResult: searchResult.data
                    }
                }, true);
                
            } catch (error) {
                formatResult(resultDiv, {
                    success: false,
                    message: '劳资顾问管理一鍵測試失敗',
                    error: { details: error.message }
                }, false);
            }
        }
        
        // 端到端指派测试
        async function handleEndToEndAssignmentTest() {
            const resultDiv = document.getElementById('e2e-assignment-test-result');
            resultDiv.innerHTML = '<p style="color: #f39c12;">🚀 開始端到端指派測試流程...</p>';
            
            try {
                // 1. 创建测试顾问
                resultDiv.innerHTML += '<p>👥 步驟1: 創建測試顧問...</p>';
                const advisorResult = await callApi('/labor-advisors', 'POST', {
                    name: '端到端測試顧問',
                    phone: '02-11111111',
                    email: `e2e.advisor.${Date.now()}@example.com`,
                    region: '台北市',
                    specialties: ['labor_contract'],
                    notes: '端到端測試專用顧問'
                }, true);
                
                if (!advisorResult.success) {
                    throw new Error('創建顧問失敗: ' + advisorResult.message);
                }
                
                const advisorId = advisorResult.data.id;
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 顧問創建成功: ${advisorId}</p>`;
                
                // 2. 创建测试咨询申请
                resultDiv.innerHTML += '<p>📝 步驟2: 創建測試咨詢申請...</p>';
                const consultationResult = await callApi('/expert-consultations', 'POST', {
                    name: '端到端測試用戶',
                    phone: '0987777777',
                    email: `e2e.user.${Date.now()}@example.com`,
                    service: 'labor_contract',
                    details: '這是端到端測試的咨詢申請，用於測試指派功能。',
                    preferredContact: ['email'],
                    region: '台北市'
                }, true);
                
                if (!consultationResult.success) {
                    throw new Error('創建咨詢申請失敗: ' + consultationResult.message);
                }
                
                const consultationId = consultationResult.data.customId;
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 咨詢申請創建成功: ${consultationId}</p>`;
                
                // 3. 测试手动指派
                resultDiv.innerHTML += '<p>🎯 步驟3: 測試手動指派...</p>';
                const assignResult = await callApi(`/labor-advisors/assign/${consultationId}`, 'PUT', { advisorId: advisorId }, true);
                
                if (!assignResult.success) {
                    throw new Error('手動指派失敗: ' + assignResult.message);
                }
                
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 手動指派成功</p>`;
                
                // 4. 查看指派历史
                resultDiv.innerHTML += '<p>📋 步驟4: 查看指派歷史...</p>';
                const historyResult = await callApi(`/labor-advisors/assignment-history/${consultationId}`, 'GET', null, true);
                
                if (historyResult.success) {
                    resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 指派歷史查看成功</p>`;
                }
                
                // 5. 清理测试数据
                resultDiv.innerHTML += '<p>🗑️ 步驟5: 清理測試數據...</p>';
                await callApi(`/expert-consultations/admin/${consultationId}`, 'DELETE', null, true);
                await callApi(`/labor-advisors/${advisorId}`, 'DELETE', null, true);
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 測試數據清理完成</p>`;
                
                formatResult(resultDiv, {
                    success: true,
                    message: '🎉 端到端指派測試完成！',
                    data: {
                        advisorId: advisorId,
                        consultationId: consultationId,
                        steps: [
                            '✅ 顧問創建成功',
                            '✅ 咨詢申請創建成功', 
                            '✅ 手動指派成功',
                            '✅ 指派歷史查看成功',
                            '✅ 測試數據清理完成'
                        ],
                        assignResult: assignResult.data,
                        historyResult: historyResult.data
                    }
                }, true);
                
            } catch (error) {
                formatResult(resultDiv, {
                    success: false,
                    message: '端到端指派測試失敗',
                    error: { details: error.message }
                }, false);
            }
        }
        
        // ==============================
        // 用户端API处理函数
        // ==============================
        
        // 1. 创建会话
        async function handleCreateSession() {
            if (!authToken) {
                formatResult(document.getElementById('create-session-result'), '请先登录', false);
                return;
            }
            
            const title = document.getElementById('create-session-title').value;
            const data = title ? { title } : {};
            
            const result = await callApi('/chat/sessions', 'POST', data, true);
            formatResult(document.getElementById('create-session-result'), result, result.success);
            
            if (result.success && result.data) {
                ChatModule.setCurrentSession(result.data);
                formatResult(document.getElementById('create-session-result'), {
                    ...result,
                    message: `✅ 会话创建成功！已自动设置为当前会话`
                }, true);
            }
        }
        
        // 2. 获取会话列表
        async function handleGetSessions() {
            if (!authToken) {
                formatResult(document.getElementById('get-sessions-result'), '请先登录', false);
                return;
            }
            
            const search = document.getElementById('sessions-search').value;
            const page = document.getElementById('sessions-page').value || 1;
            const limit = document.getElementById('sessions-limit').value || 20;
            
            let queryParams = `?page=${page}&limit=${limit}`;
            if (search) queryParams += `&search=${encodeURIComponent(search)}`;
            
            const result = await callApi(`/chat/sessions${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('get-sessions-result'), result, result.success);
            
            if (result.success && result.data?.sessions) {
                ChatModule.sessionList = result.data.sessions;
                
                // 添加选择会话的功能
                const resultDiv = document.getElementById('get-sessions-result');
                if (result.data.sessions.length > 0) {
                    resultDiv.innerHTML += `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <h4>选择会话：</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${result.data.sessions.map(session => `
                                    <div style="margin: 5px 0; padding: 8px; background-color: #f8f9fa; border-radius: 4px; cursor: pointer;" 
                                         onclick="selectSession('${session.sessionId}', '${session.title}', ${session.messageCount}, '${session.createdAt}')">
                                        <strong>${session.title}</strong><br>
                                        <small style="color: #666;">ID: ${session.sessionId} | 消息数: ${session.messageCount}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // 选择会话的全局函数
        window.selectSession = function(sessionId, title, messageCount, createdAt) {
            ChatModule.setCurrentSession({
                sessionId,
                title,
                messageCount,
                createdAt
            });
            alert(`已选择会话: ${title}`);
        };
        
        // 3. 获取会话详情
        async function handleGetSessionDetail() {
            if (!authToken) {
                formatResult(document.getElementById('get-session-detail-result'), '请先登录', false);
                return;
            }
            
            const sessionId = document.getElementById('session-detail-id').value;
            if (!sessionId) {
                formatResult(document.getElementById('get-session-detail-result'), '请输入会话ID', false);
                return;
            }
            
            const result = await callApi(`/chat/sessions/${sessionId}`, 'GET', null, true);
            formatResult(document.getElementById('get-session-detail-result'), result, result.success);
        }
        
        // 4. 更新会话标题
        async function handleUpdateSessionTitle() {
            if (!authToken) {
                formatResult(document.getElementById('update-session-title-result'), '请先登录', false);
                return;
            }
            
            const sessionId = document.getElementById('update-session-id').value;
            const title = document.getElementById('update-session-title').value;
            
            if (!sessionId || !title) {
                formatResult(document.getElementById('update-session-title-result'), '请输入会话ID和新标题', false);
                return;
            }
            
            const result = await callApi(`/chat/sessions/${sessionId}`, 'PUT', { title }, true);
            formatResult(document.getElementById('update-session-title-result'), result, result.success);
            
            if (result.success && ChatModule.currentSession?.sessionId === sessionId) {
                ChatModule.currentSession.title = title;
                ChatModule.updateSessionInfo();
            }
        }
        
        // 5. 删除会话
        async function handleDeleteSession() {
            if (!authToken) {
                formatResult(document.getElementById('delete-session-result'), '请先登录', false);
                return;
            }
            
            const sessionId = document.getElementById('delete-session-id').value;
            if (!sessionId) {
                formatResult(document.getElementById('delete-session-result'), '请输入会话ID', false);
                return;
            }
            
            if (!confirm(`确定要删除会话 ${sessionId} 吗？此操作无法撤销。`)) {
                return;
            }
            
            const result = await callApi(`/chat/sessions/${sessionId}`, 'DELETE', null, true);
            formatResult(document.getElementById('delete-session-result'), result, result.success);
            
            if (result.success && ChatModule.currentSession?.sessionId === sessionId) {
                ChatModule.setCurrentSession(null);
            }
        }
        
        // 6. 发送消息并获取AI回复 (核心功能)
        async function handleSendMessage() {
            if (!authToken) {
                formatResult(document.getElementById('send-message-result'), '请先登录', false);
                return;
            }
            
            const sessionId = document.getElementById('message-session-id').value;
            const content = document.getElementById('message-content').value;
            const messageType = document.getElementById('message-type').value;
            
            if (!sessionId || !content) {
                formatResult(document.getElementById('send-message-result'), '请输入会话ID和消息内容', false);
                return;
            }
            
            // 显示发送中状态
            const resultDiv = document.getElementById('send-message-result');
            resultDiv.innerHTML = '<p style="color: #f39c12;">🚀 正在发送消息并等待AI回复...</p>';
            
            const result = await callApi(`/chat/sessions/${sessionId}/messages`, 'POST', {
                content,
                messageType
            }, true);
            
            formatResult(resultDiv, result, result.success);
            
            // 特殊处理AI回复显示
            if (result.success && result.data?.aiResponse) {
                const aiResponse = result.data.aiResponse;
                resultDiv.innerHTML += `
                    <div style="margin-top: 15px; padding: 15px; background-color: #e8f5e8; border-radius: 8px; border-left: 4px solid #27ae60;">
                        <h4 style="margin: 0 0 10px 0; color: #27ae60;">🤖 AI回复</h4>
                        <div style="background-color: white; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                            ${aiResponse.content.replace(/\n/g, '<br>')}
                        </div>
                        
                        ${aiResponse.references && aiResponse.references.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong>📚 法条引用：</strong>
                                ${aiResponse.references.map(ref => `
                                    <div style="margin: 5px 0; padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                                        <strong>${ref.law} ${ref.article}</strong><br>
                                        <small>${ref.content}</small>
                                        ${ref.url ? `<br><a href="${ref.url}" target="_blank" style="color: #3498db;">查看详情</a>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            消息ID: ${aiResponse.messageId} | 
                            处理时间: ${aiResponse.processingTime}ms |
                            剩余咨询次数: ${result.data.remainingQueries}
                        </div>
                    </div>
                `;
                
                // 自动填充反馈表单
                document.getElementById('feedback-session-id').value = sessionId;
                document.getElementById('feedback-message-id').value = aiResponse.messageId;
            }
        }
        
        // 7. 获取消息列表
        async function handleGetMessages() {
            if (!authToken) {
                formatResult(document.getElementById('get-messages-result'), '请先登录', false);
                return;
            }
            
            const sessionId = document.getElementById('messages-session-id').value;
            if (!sessionId) {
                formatResult(document.getElementById('get-messages-result'), '请输入会话ID', false);
                return;
            }
            
            const page = document.getElementById('messages-page').value || 1;
            const limit = document.getElementById('messages-limit').value || 50;
            
            const queryParams = `?page=${page}&limit=${limit}`;
            const result = await callApi(`/chat/sessions/${sessionId}/messages${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('get-messages-result'), result, result.success);
        }
        
        // 8. 提交用户反馈
        async function handleSubmitFeedback() {
            if (!authToken) {
                formatResult(document.getElementById('submit-feedback-result'), '请先登录', false);
                return;
            }
            
            const sessionId = document.getElementById('feedback-session-id').value;
            const messageId = document.getElementById('feedback-message-id').value;
            const feedback = document.getElementById('feedback-type').value;
            
            if (!sessionId || !messageId) {
                formatResult(document.getElementById('submit-feedback-result'), '请输入会话ID和消息ID', false);
                return;
            }
            
            const result = await callApi(`/chat/sessions/${sessionId}/messages/${messageId}/feedback`, 'POST', {
                feedback
            }, true);
            formatResult(document.getElementById('submit-feedback-result'), result, result.success);
        }
        
        // ==============================
        // 快速测试工具
        // ==============================
        
        // 一键完整测试流程
        async function handleQuickTest() {
            if (!authToken) {
                formatResult(document.getElementById('quick-test-result'), '请先登录', false);
                return;
            }
            
            const resultDiv = document.getElementById('quick-test-result');
            resultDiv.innerHTML = '<p style="color: #f39c12;">🚀 开始一键测试流程...</p>';
            
            try {
                // 1. 创建会话
                resultDiv.innerHTML += '<p>📝 步骤1: 创建测试会话...</p>';
                const createResult = await callApi('/chat/sessions', 'POST', {
                    title: '一键测试会话 - ' + new Date().toLocaleString()
                }, true);
                
                if (!createResult.success) {
                    throw new Error('创建会话失败: ' + createResult.message);
                }
                
                const sessionId = createResult.data.sessionId;
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 会话创建成功: ${sessionId}</p>`;
                
                // 2. 发送测试消息
                resultDiv.innerHTML += '<p>💬 步骤2: 发送测试消息...</p>';
                const messageResult = await callApi(`/chat/sessions/${sessionId}/messages`, 'POST', {
                    content: '请问加班费的计算方式？',
                    messageType: 'question'
                }, true);
                
                if (!messageResult.success) {
                    throw new Error('发送消息失败: ' + messageResult.message);
                }
                
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 消息发送成功，AI回复已生成</p>`;
                
                // 3. 获取会话详情
                resultDiv.innerHTML += '<p>🔍 步骤3: 获取会话详情...</p>';
                const detailResult = await callApi(`/chat/sessions/${sessionId}`, 'GET', null, true);
                
                if (!detailResult.success) {
                    throw new Error('获取详情失败: ' + detailResult.message);
                }
                
                resultDiv.innerHTML += `<p style="color: #27ae60;">✅ 会话详情获取成功</p>`;
                
                // 显示完整结果
                formatResult(resultDiv, {
                    success: true,
                    message: '🎉 一键测试完成！',
                    data: {
                        sessionId: sessionId,
                        steps: [
                            '✅ 会话创建成功',
                            '✅ 消息发送成功',
                            '✅ AI回复生成',
                            '✅ 会话详情获取成功'
                        ],
                        aiResponse: messageResult.data?.aiResponse,
                        sessionDetail: detailResult.data
                    }
                }, true);
                
                // 设置为当前会话
                ChatModule.setCurrentSession(createResult.data);
                
            } catch (error) {
                formatResult(resultDiv, {
                    success: false,
                    message: '一键测试失败',
                    error: { details: error.message }
                }, false);
            }
        }
        
        // 预设问题测试
        async function handlePresetQuestion(event) {
            const question = event.target.getAttribute('data-question');
            
            if (!authToken) {
                formatResult(document.getElementById('preset-question-result'), '请先登录', false);
                return;
            }
            
            // 检查是否有当前会话
            if (!ChatModule.currentSession) {
                formatResult(document.getElementById('preset-question-result'), '请先创建或选择一个会话', false);
                return;
            }
            
            // 自动填充并发送消息
            document.getElementById('message-content').value = question;
            document.getElementById('message-session-id').value = ChatModule.currentSession.sessionId;
            
            formatResult(document.getElementById('preset-question-result'), {
                message: `已自动填充问题："${question}"，请点击发送消息按钮`
            }, true);
        }
        
        // 错误场景测试
        async function handleErrorTest(testType) {
            const resultDiv = document.getElementById('error-test-result');
            
            switch (testType) {
                case 'invalid-session':
                    const invalidResult = await callApi('/chat/sessions/invalid-session-id/messages', 'POST', {
                        content: '测试消息',
                        messageType: 'question'
                    }, true);
                    formatResult(resultDiv, {
                        testType: '无效会话ID测试',
                        result: invalidResult
                    }, false);
                    break;
                    
                case 'empty-message':
                    if (ChatModule.currentSession) {
                        const emptyResult = await callApi(`/chat/sessions/${ChatModule.currentSession.sessionId}/messages`, 'POST', {
                            content: '',
                            messageType: 'question'
                        }, true);
                        formatResult(resultDiv, {
                            testType: '空消息测试',
                            result: emptyResult
                        }, false);
                    } else {
                        formatResult(resultDiv, '请先选择一个会话', false);
                    }
                    break;
                    
                case 'no-auth':
                    const originalToken = authToken;
                    authToken = '';
                    const noAuthResult = await callApi('/chat/sessions', 'GET', null, true);
                    authToken = originalToken;
                    formatResult(resultDiv, {
                        testType: '无认证测试',
                        result: noAuthResult
                    }, false);
                    break;
            }
        }
        
        // ==============================
        // 管理员API处理函数
        // ==============================
        
        // 获取所有用户会话 (管理员)
        async function handleAdminGetSessions() {
            if (!authToken) {
                formatResult(document.getElementById('admin-get-sessions-result'), '请先登录', false);
                return;
            }
            
            const page = document.getElementById('admin-sessions-page').value || 1;
            const limit = document.getElementById('admin-sessions-limit').value || 20;
            const status = document.getElementById('admin-sessions-status').value;
            const userId = document.getElementById('admin-sessions-user').value;
            const search = document.getElementById('admin-sessions-search').value;
            
            let queryParams = `?page=${page}&limit=${limit}`;
            if (status) queryParams += `&status=${status}`;
            if (userId) queryParams += `&userId=${userId}`;
            if (search) queryParams += `&search=${encodeURIComponent(search)}`;
            
            const result = await callApi(`/admin/chat/sessions${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('admin-get-sessions-result'), result, result.success);
        }
        
        // 获取会话详情 (管理员视角)
        async function handleAdminGetSessionDetail() {
            if (!authToken) {
                formatResult(document.getElementById('admin-get-session-detail-result'), '请先登录', false);
                return;
            }
            
            const sessionId = document.getElementById('admin-session-detail-id').value;
            if (!sessionId) {
                formatResult(document.getElementById('admin-get-session-detail-result'), '请输入会话ID', false);
                return;
            }
            
            const result = await callApi(`/admin/chat/sessions/${sessionId}/messages`, 'GET', null, true);
            formatResult(document.getElementById('admin-get-session-detail-result'), result, result.success);
        }
        
        // 获取聊天统计数据
        async function handleGetChatStats() {
            if (!authToken) {
                formatResult(document.getElementById('get-chat-stats-result'), '请先登录', false);
                return;
            }
            
            const startDate = document.getElementById('stats-start-date').value;
            const endDate = document.getElementById('stats-end-date').value;
            
            let queryParams = '';
            if (startDate) queryParams += `?startDate=${startDate}`;
            if (endDate) queryParams += `${queryParams ? '&' : '?'}endDate=${endDate}`;
            
            const result = await callApi(`/admin/chat/stats${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('get-chat-stats-result'), result, result.success);
        }
        
        // 导出聊天记录
        async function handleExportChatRecords() {
            if (!authToken) {
                formatResult(document.getElementById('export-chat-records-result'), '请先登录', false);
                return;
            }
            
            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;
            const format = document.getElementById('export-format').value;
            const includeUserInfo = document.getElementById('export-include-user-info').value === 'true';
            const sessionIds = document.getElementById('export-session-ids').value
                .split(',')
                .map(id => id.trim())
                .filter(id => id);
            
            const data = {
                startDate,
                endDate,
                format,
                includeUserInfo
            };
            
            if (sessionIds.length > 0) {
                data.sessionIds = sessionIds;
            }
            
            try {
                // 🔧 修复：使用专门的文件下载处理而不是JSON解析
                const url = `${API.BASE_URL}/admin/chat/export`;
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                };
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    // 检查响应的Content-Type
                    const contentType = response.headers.get('Content-Type');
                    
                    if (contentType && contentType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')) {
                        // 🔧 Excel文件：直接下载
                        const blob = await response.blob();
                        const contentDisposition = response.headers.get('Content-Disposition');
                        let filename = 'chat_records_export.xlsx';
                        
                        // 尝试从Content-Disposition提取文件名
                        if (contentDisposition) {
                            const filenameMatch = contentDisposition.match(/filename\*?=['"]?([^'";]+)['"]?/);
                            if (filenameMatch) {
                                filename = decodeURIComponent(filenameMatch[1]);
                            }
                        }
                        
                        // 创建下载链接
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = filename;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(downloadUrl);
                        
                        // 显示成功消息
                        formatResult(document.getElementById('export-chat-records-result'), {
                            success: true,
                            message: '✅ 导出成功！文件已开始下载',
                            filename: filename,
                            timestamp: new Date().toISOString(),
                            fileSize: `${(blob.size / 1024).toFixed(2)} KB`
                        }, true);
                        
                    } else {
                        // 🔧 JSON响应：正常解析
                        const result = await response.json();
                        formatResult(document.getElementById('export-chat-records-result'), result, result.success);
                    }
                } else {
                    // 🔧 错误响应：尝试解析JSON错误信息
                    try {
                        const errorResult = await response.json();
                        formatResult(document.getElementById('export-chat-records-result'), errorResult, false);
                    } catch (e) {
                        formatResult(document.getElementById('export-chat-records-result'), {
                            success: false,
                            message: `导出失败: HTTP ${response.status}`,
                            error: {
                                code: 'EXPORT_FAILED',
                                details: `${response.status} ${response.statusText}`
                            }
                        }, false);
                    }
                }
                
            } catch (error) {
                formatResult(document.getElementById('export-chat-records-result'), {
                    success: false,
                    message: '导出请求失败',
                    error: {
                        code: 'REQUEST_FAILED',
                        details: error.message
                    }
                }, false);
            }
        }
        
        // ==============================
        // N8N 服务测试
        // ==============================
        
        // 检查N8N服务状态
        async function handleCheckN8NStatus() {
            try {
                // 显示检查中状态
                formatResult(document.getElementById('n8n-service-status'), {
                    message: '正在检查N8N服务状态...',
                    timestamp: new Date().toISOString(),
                    status: '检查中...'
                }, true);
                
                // 调用真实的N8N健康检查API
                const result = await callApi('/test/n8n/health', 'GET', null, false);
                
                if (result.success) {
                    // 成功响应，显示服务状态
                    const statusResult = {
                        message: result.message,
                        serviceUrl: result.data.serviceUrl,
                        status: result.data.status,
                        isHealthy: result.data.isHealthy,
                        stats: result.data.stats,
                        timestamp: result.data.timestamp
                    };
                    
                    formatResult(document.getElementById('n8n-service-status'), statusResult, true);
                    
                    // 如果有统计信息，显示额外详情
                    if (result.data.stats) {
                        const statsInfo = document.createElement('div');
                        statsInfo.style.marginTop = '10px';
                        statsInfo.style.padding = '10px';
                        statsInfo.style.backgroundColor = '#f0f8ff';
                        statsInfo.style.borderRadius = '5px';
                        statsInfo.innerHTML = `
                            <strong>📊 服务统计:</strong><br>
                            • 总调用次数: ${result.data.stats.totalCalls}<br>
                            • 成功调用: ${result.data.stats.successCalls}<br>
                            • 失败调用: ${result.data.stats.failedCalls}<br>
                            • 成功率: ${result.data.stats.successRate}<br>
                            • 平均响应时间: ${result.data.stats.avgResponseTimeFormatted}
                        `;
                        document.getElementById('n8n-service-status').appendChild(statsInfo);
                    }
                } else {
                    // 错误响应
                    formatResult(document.getElementById('n8n-service-status'), result, false);
                }
                
            } catch (error) {
                formatResult(document.getElementById('n8n-service-status'), {
                    message: 'N8N服务状态检查失败',
                    error: error.message,
                    timestamp: new Date().toISOString(),
                    status: '❌ 检查失败'
                }, false);
            }
        }
        
        // 测试N8N连接
        async function handleTestN8NConnection() {
            try {
                const testResult = {
                    message: '正在测试N8N连接...',
                    timestamp: new Date().toISOString(),
                    test: 'ping',
                    status: '测试中...'
                };
                formatResult(document.getElementById('n8n-service-status'), testResult, true);
                
                // 可以在这里添加实际的ping测试
                setTimeout(() => {
                    formatResult(document.getElementById('n8n-service-status'), {
                        ...testResult,
                        status: '✅ 连接正常',
                        message: 'N8N服务连接测试完成'
                    }, true);
                }, 2000);
                
            } catch (error) {
                formatResult(document.getElementById('n8n-service-status'), {
                    message: 'N8N连接测试失败',
                    error: error.message
                }, false);
            }
        }
        
        // 直接测试N8N
        async function handleDirectN8NTest() {
            const message = document.getElementById('n8n-test-message').value;
            if (!message) {
                formatResult(document.getElementById('direct-n8n-test-result'), '请输入测试消息', false);
                return;
            }
            
            try {
                // 显示测试中状态
                const testData = {
                    message: '正在直接测试N8N服务...',
                    input: message,
                    timestamp: new Date().toISOString(),
                    status: '处理中...'
                };
                
                formatResult(document.getElementById('direct-n8n-test-result'), testData, true);
                
                // 调用真实的N8N测试API
                const result = await callApi('/test/n8n/direct', 'POST', { message }, false);
                
                if (result.success) {
                    // 成功响应，显示AI的真实回复
                    const successResult = {
                        message: result.message,
                        input: result.data.input,
                        output: result.data.output,
                        references: result.data.references,
                        processingTime: result.data.processingTime + 'ms',
                        testDuration: result.data.testDuration + 'ms',
                        qualityScore: result.data.qualityScore,
                        sessionId: result.data.sessionId,
                        timestamp: result.data.timestamp,
                        status: '✅ 测试完成 - 收到真实AI回复'
                    };
                    
                    formatResult(document.getElementById('direct-n8n-test-result'), successResult, true);
                    
                    // 如果有法条引用，显示额外信息
                    if (result.data.references && result.data.references.length > 0) {
                        const referencesInfo = document.createElement('div');
                        referencesInfo.style.marginTop = '10px';
                        referencesInfo.style.padding = '10px';
                        referencesInfo.style.backgroundColor = '#e8f5e8';
                        referencesInfo.style.borderRadius = '5px';
                        referencesInfo.innerHTML = `
                            <strong>📚 法条引用 (${result.data.references.length}条):</strong><br>
                            ${result.data.references.map(ref => 
                                `• ${ref.law} ${ref.article}${ref.url ? ` <a href="${ref.url}" target="_blank">查看详情</a>` : ''}`
                            ).join('<br>')}
                        `;
                        document.getElementById('direct-n8n-test-result').appendChild(referencesInfo);
                    }
                } else {
                    // 错误响应
                    formatResult(document.getElementById('direct-n8n-test-result'), result, false);
                }
                
            } catch (error) {
                formatResult(document.getElementById('direct-n8n-test-result'), {
                    message: 'N8N直接测试失败',
                    error: error.message,
                    timestamp: new Date().toISOString(),
                    status: '❌ 测试失败'
                }, false);
            }
        }
        
        // ==============================
        // 郵箱驗證 API 事件處理器
        // ==============================
        
        // 初始化郵箱驗證模块事件监听器
        function initEmailVerificationEventListeners() {
            // 用戶端API - 註冊郵箱驗證
            document.getElementById('send-email-verification-btn').addEventListener('click', handleSendEmailVerification);
            document.getElementById('verify-email-btn').addEventListener('click', handleVerifyEmail);
            document.getElementById('resend-verification-btn').addEventListener('click', handleResendVerification);
            document.getElementById('get-email-status-btn').addEventListener('click', handleGetEmailStatus);
            
            // 用戶端API - 密碼重置
            document.getElementById('forgot-password-btn').addEventListener('click', handleForgotPassword);
            document.getElementById('reset-password-btn').addEventListener('click', handleResetPassword);
            
            // 用戶端API - ⭐ 一步式驗證並註冊 (新增)
            document.getElementById('verify-and-register-btn').addEventListener('click', handleVerifyAndRegister);
            
            // 用戶端API - 邀請註冊驗證
            document.getElementById('verify-invite-registration-btn').addEventListener('click', handleVerifyInviteRegistration);
            
            // 管理後台API
            document.getElementById('get-email-statistics-btn').addEventListener('click', handleGetEmailStatistics);
            document.getElementById('get-email-logs-btn').addEventListener('click', handleGetEmailLogs);
            document.getElementById('resend-failed-email-btn').addEventListener('click', handleResendFailedEmail);
            document.getElementById('test-email-service-btn').addEventListener('click', handleTestEmailService);
            document.getElementById('cleanup-email-logs-btn').addEventListener('click', handleCleanupEmailLogs);
        }
        
        // ==============================
        // 郵箱驗證 API 處理函數
        // ==============================
        
        // 1. 發送註冊驗證碼
        async function handleSendEmailVerification() {
            const email = document.getElementById('send-email').value;
            if (!email) {
                formatResult(document.getElementById('send-email-verification-result'), '請輸入電子郵箱', false);
                return;
            }
            
            const result = await callApi('/auth/send-email-verification', 'POST', { 
                email, 
                type: 'registration' 
            });
            formatResult(document.getElementById('send-email-verification-result'), result, result.success);
        }
        
        // 2. 驗證註冊郵箱
        async function handleVerifyEmail() {
            const email = document.getElementById('verify-email').value;
            const verificationCode = document.getElementById('verify-code').value;
            
            if (!email || !verificationCode) {
                formatResult(document.getElementById('verify-email-result'), '請輸入郵箱和驗證碼', false);
                return;
            }
            
            const result = await callApi('/auth/verify-email', 'POST', { 
                email, 
                verificationCode,
                type: 'registration'
            });
            formatResult(document.getElementById('verify-email-result'), result, result.success);
        }
        
        // 3. 重發驗證碼
        async function handleResendVerification() {
            const email = document.getElementById('resend-email').value;
            if (!email) {
                formatResult(document.getElementById('resend-verification-result'), '請輸入電子郵箱', false);
                return;
            }
            
            const result = await callApi('/auth/resend-verification', 'POST', { 
                email, 
                type: 'registration' 
            });
            formatResult(document.getElementById('resend-verification-result'), result, result.success);
        }
        
        // 4. 檢查郵箱驗證狀態
        async function handleGetEmailStatus() {
            const email = document.getElementById('status-email').value;
            if (!email) {
                formatResult(document.getElementById('get-email-status-result'), '請輸入電子郵箱', false);
                return;
            }
            
            const result = await callApi(`/auth/email-verification-status?email=${encodeURIComponent(email)}`, 'GET');
            formatResult(document.getElementById('get-email-status-result'), result, result.success);
        }
        
        // 5. 忘記密碼
        async function handleForgotPassword() {
            const email = document.getElementById('forgot-email').value;
            if (!email) {
                formatResult(document.getElementById('forgot-password-result'), '請輸入電子郵箱', false);
                return;
            }
            
            const result = await callApi('/auth/forgot-password', 'POST', { email });
            formatResult(document.getElementById('forgot-password-result'), result, result.success);
        }
        
        // 6. 重置密碼
        async function handleResetPassword() {
            const email = document.getElementById('reset-email').value;
            const verificationCode = document.getElementById('reset-code').value;
            const newPassword = document.getElementById('new-password').value;
            
            if (!email || !verificationCode || !newPassword) {
                formatResult(document.getElementById('reset-password-result'), '請填寫所有必填項目', false);
                return;
            }
            
            const result = await callApi('/auth/reset-password', 'POST', { 
                email, 
                verificationCode, 
                newPassword 
            });
            formatResult(document.getElementById('reset-password-result'), result, result.success);
        }
        
        // 🗑️ 清理測試數據（方便重複測試一步式註冊）
        async function clearTestData() {
            const email = document.getElementById('one-step-email').value;
            
            if (!email) {
                alert('請先輸入要清理的郵箱地址');
                return;
            }
            
            if (!confirm(`確定要清理 ${email} 的所有測試數據嗎？\n\n這將刪除：\n- 用戶記錄\n- 驗證碼記錄\n\n此操作不可恢復！`)) {
                return;
            }
            
            try {
                // 手動清理提示（由於清理API尚未實現）
                alert(`⚠️ 清理API暫未實現\n\n請手動清理數據庫中的記錄：\n\n1. 用戶表：db.users.deleteOne({email: "${email}"})\n2. 驗證碼表：db.emailverifications.deleteMany({email: "${email}"})\n\n或者使用不同的測試郵箱`);
            } catch (error) {
                alert(`❌ 操作失敗：${error.message}`);
            }
        }

        // ⭐ 7. 一步式驗證並註冊 (新增API)
        async function handleVerifyAndRegister() {
            const email = document.getElementById('one-step-email').value;
            const verificationCode = document.getElementById('one-step-verification-code').value;
            const name = document.getElementById('one-step-name').value;
            const password = document.getElementById('one-step-password').value;
            const industry = document.getElementById('one-step-industry').value;
            const position = document.getElementById('one-step-position').value;
            const inviteCode = document.getElementById('one-step-invite-code').value;
            
            // 驗證必填項目
            if (!email || !verificationCode || !name || !password) {
                formatResult(document.getElementById('verify-and-register-result'), {
                    success: false,
                    message: '請填寫所有必填項目 (郵箱、驗證碼、姓名、密碼)',
                    error: { code: 'MISSING_REQUIRED_FIELDS' }
                }, false);
                return;
            }
            
            // 驗證密碼強度
            if (password.length < 8 || !/^(?=.*[a-zA-Z])(?=.*\d).{8,}$/.test(password)) {
                formatResult(document.getElementById('verify-and-register-result'), {
                    success: false,
                    message: '密碼必須至少8位，包含字母和數字',
                    error: { code: 'WEAK_PASSWORD' }
                }, false);
                return;
            }
            
            // 準備用戶數據
            const userData = {
                name: name.trim(),
                password,
                industry: industry.trim(),
                position: position.trim()
            };
            
            // 如果有邀請碼，添加到用戶數據中
            if (inviteCode && inviteCode.trim()) {
                userData.inviteCode = inviteCode.trim().toUpperCase();
            }
            
            // 顯示處理中狀態
            formatResult(document.getElementById('verify-and-register-result'), {
                message: '正在處理註冊請求...',
                status: '處理中'
            }, true);
            
            // 調用API
            const result = await callApi('/auth/verify-and-register', 'POST', { 
                email, 
                verificationCode, 
                userData 
            });
            
            // 處理成功響應，添加額外信息展示
            if (result.success && result.data) {
                const successData = {
                    ...result,
                    additionalInfo: {
                        '✅ 註冊完成': '用戶賬戶已成功創建',
                        '📧 郵箱狀態': '已驗證',
                        '🎯 查詢次數': `${result.data.user.remainingQueries}次`,
                        '🆔 用戶ID': result.data.user.id
                    }
                };
                
                if (result.data.inviteInfo) {
                    successData.additionalInfo['🎉 邀請獎勵'] = `來自 ${result.data.inviteInfo.inviterName} 的邀請，獲得額外${result.data.inviteInfo.bonusReceived}次查詢`;
                }
                
                if (result.data.token) {
                    successData.additionalInfo['🔐 登錄狀態'] = '已自動登錄';
                }
                
                formatResult(document.getElementById('verify-and-register-result'), successData, true);
            } else {
                formatResult(document.getElementById('verify-and-register-result'), result, result.success);
            }
        }

        // 8. 邀請註冊驗證
        async function handleVerifyInviteRegistration() {
            const email = document.getElementById('invite-email').value;
            const verificationCode = document.getElementById('invite-verification-code').value;
            const inviteCode = document.getElementById('invite-code').value;
            
            if (!email || !verificationCode || !inviteCode) {
                formatResult(document.getElementById('verify-invite-registration-result'), '請填寫所有必填項目', false);
                return;
            }
            
            const result = await callApi('/auth/verify-invite-registration', 'POST', { 
                email, 
                verificationCode, 
                inviteCode 
            });
            formatResult(document.getElementById('verify-invite-registration-result'), result, result.success);
        }
        
        // ==============================
        // 管理後台郵件管理 API 處理函數
        // ==============================
        
        // 8. 獲取郵件統計
        async function handleGetEmailStatistics() {
            if (!authToken) {
                formatResult(document.getElementById('get-email-statistics-result'), '請先登錄', false);
                return;
            }
            
            const startDate = document.getElementById('stats-start-date').value;
            const endDate = document.getElementById('stats-end-date').value;
            const type = document.getElementById('stats-type').value;
            
            let queryParams = '';
            const params = new URLSearchParams();
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            if (type !== 'all') params.append('type', type);
            
            if (params.toString()) {
                queryParams = '?' + params.toString();
            }
            
            const result = await callApi(`/admin/emails/statistics${queryParams}`, 'GET', null, true);
            formatResult(document.getElementById('get-email-statistics-result'), result, result.success);
        }
        
        // 9. 獲取郵件日志
        async function handleGetEmailLogs() {
            if (!authToken) {
                formatResult(document.getElementById('get-email-logs-result'), '請先登錄', false);
                return;
            }
            
            const page = document.getElementById('logs-page').value || 1;
            const limit = document.getElementById('logs-limit').value || 20;
            const type = document.getElementById('logs-type').value;
            const status = document.getElementById('logs-status').value;
            const email = document.getElementById('logs-email').value;
            const userId = document.getElementById('logs-user-id').value;
            
            const params = new URLSearchParams();
            params.append('page', page);
            params.append('limit', limit);
            if (type) params.append('type', type);
            if (status) params.append('status', status);
            if (email) params.append('email', email);
            if (userId) params.append('userId', userId);
            
            const result = await callApi(`/admin/emails/logs?${params.toString()}`, 'GET', null, true);
            formatResult(document.getElementById('get-email-logs-result'), result, result.success);
        }
        
        // 10. 重發失敗郵件
        async function handleResendFailedEmail() {
            if (!authToken) {
                formatResult(document.getElementById('resend-failed-email-result'), '請先登錄', false);
                return;
            }
            
            const logId = document.getElementById('resend-log-id').value;
            if (!logId) {
                formatResult(document.getElementById('resend-failed-email-result'), '請輸入郵件日志ID', false);
                return;
            }
            
            const result = await callApi(`/admin/emails/resend/${logId}`, 'POST', null, true);
            formatResult(document.getElementById('resend-failed-email-result'), result, result.success);
        }
        
        // 11. 測試郵件服務
        async function handleTestEmailService() {
            if (!authToken) {
                formatResult(document.getElementById('test-email-service-result'), '請先登錄', false);
                return;
            }
            
            const result = await callApi('/admin/emails/test-service', 'POST', null, true);
            formatResult(document.getElementById('test-email-service-result'), result, result.success);
        }
        
        // 12. 清理過期日志
        async function handleCleanupEmailLogs() {
            if (!authToken) {
                formatResult(document.getElementById('cleanup-email-logs-result'), '請先登錄', false);
                return;
            }
            
            const daysOld = document.getElementById('cleanup-days').value || 60;
            
            if (!confirm(`確定要清理 ${daysOld} 天之前的郵件日志嗎？此操作無法撤銷。`)) {
                return;
            }
            
            const result = await callApi('/admin/emails/cleanup', 'POST', { daysOld: parseInt(daysOld) }, true);
            formatResult(document.getElementById('cleanup-email-logs-result'), result, result.success);
        }
        
        // ==============================
        // 邀請管理 API 事件處理器
        // ==============================
        
        // 綁定邀請管理相關事件
        document.addEventListener('DOMContentLoaded', function() {
            // 獲取我的邀請碼
            document.getElementById('get-my-invite-code-btn')?.addEventListener('click', async () => {
                const result = await callApi('/invites/my-code', 'GET', null, true);
                formatResult(document.getElementById('my-invite-code-result'), result, result.success);
            });
            
            // 重新生成邀請碼
            document.getElementById('regenerate-invite-code-btn')?.addEventListener('click', async () => {
                const result = await callApi('/invites/regenerate-code', 'POST', {}, true);
                formatResult(document.getElementById('regenerate-invite-code-result'), result, result.success);
            });
            
            // 驗證邀請碼
            document.getElementById('validate-invite-code-btn')?.addEventListener('click', async () => {
                const inviteCode = document.getElementById('validate-invite-code').value;
                if (!inviteCode) {
                    formatResult(document.getElementById('validate-invite-code-result'), '請輸入邀請碼', false);
                    return;
                }
                const result = await callApi('/invites/validate', 'POST', { inviteCode });
                formatResult(document.getElementById('validate-invite-code-result'), result, result.success);
            });
            
            // 獲取我的邀請統計
            document.getElementById('get-my-invite-stats-btn')?.addEventListener('click', async () => {
                const result = await callApi('/invites/my-stats', 'GET', null, true);
                formatResult(document.getElementById('my-invite-stats-result'), result, result.success);
            });
            
            // 🆕 獲取邀請設置
            document.getElementById('get-invite-settings-btn')?.addEventListener('click', async () => {
                const result = await callApi('/invites/settings', 'GET', null, true);
                formatResult(document.getElementById('invite-settings-result'), result, result.success);
            });
            
            // 邀請排行榜
            document.getElementById('get-invite-leaderboard-btn')?.addEventListener('click', async () => {
                const result = await callApi('/invites/leaderboard?limit=10', 'GET', null, true);
                formatResult(document.getElementById('invite-leaderboard-result'), result, result.success);
            });
            
            // 處理邀請註冊
            document.getElementById('process-registration-btn')?.addEventListener('click', async () => {
                const inviteCode = document.getElementById('process-invite-code').value;
                if (!inviteCode) {
                    formatResult(document.getElementById('process-registration-result'), '請輸入邀請碼', false);
                    return;
                }
                const result = await callApi('/invites/process-registration', 'POST', { inviteCode }, true);
                formatResult(document.getElementById('process-registration-result'), result, result.success);
            });
            
            // 發放註冊獎勵
            document.getElementById('grant-registration-bonus-btn')?.addEventListener('click', async () => {
                const result = await callApi('/invites/grant-registration-bonus', 'POST', {}, true);
                formatResult(document.getElementById('grant-registration-bonus-result'), result, result.success);
            });
            
            // 管理員 - 獲取用戶邀請統計
            document.getElementById('admin-get-user-invite-stats-btn')?.addEventListener('click', async () => {
                const userId = document.getElementById('admin-user-id-invite').value;
                if (!userId) {
                    formatResult(document.getElementById('admin-user-invite-stats-result'), '請輸入用戶ID', false);
                    return;
                }
                const result = await callApi(`/invites/user/${userId}/stats`, 'GET', null, true);
                formatResult(document.getElementById('admin-user-invite-stats-result'), result, result.success);
            });
            
            // 管理員 - 獲取邀請系統統計
            document.getElementById('admin-get-invite-system-stats-btn')?.addEventListener('click', async () => {
                const startDate = document.getElementById('invite-stats-start-date').value;
                const endDate = document.getElementById('invite-stats-end-date').value;
                
                let url = '/invites/system-stats';
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (params.toString()) url += '?' + params.toString();
                
                const result = await callApi(url, 'GET', null, true);
                formatResult(document.getElementById('admin-invite-system-stats-result'), result, result.success);
            });
        });
        
        // ==============================
        // 咨詢次數管理 API 事件處理器
        // ==============================
        
        // 綁定咨詢次數管理相關事件
        document.addEventListener('DOMContentLoaded', function() {
            // 獲取我的咨詢狀態
            document.getElementById('get-my-query-status-btn')?.addEventListener('click', async () => {
                const result = await callApi('/queries/my-status', 'GET', null, true);
                formatResult(document.getElementById('my-query-status-result'), result, result.success);
            });
            
            // 今日使用次數
            document.getElementById('get-my-today-count-btn')?.addEventListener('click', async () => {
                const result = await callApi('/queries/my-today-count', 'GET', null, true);
                formatResult(document.getElementById('my-today-count-result'), result, result.success);
            });
            
            // 扣減咨詢次數
            document.getElementById('decrease-query-count-btn')?.addEventListener('click', async () => {
                const reason = document.getElementById('decrease-reason').value || 'API測試扣減';
                let metadata = {};
                try {
                    const metadataText = document.getElementById('decrease-metadata').value;
                    if (metadataText) {
                        metadata = JSON.parse(metadataText);
                    }
                } catch (e) {
                    formatResult(document.getElementById('decrease-query-count-result'), '元數據格式錯誤，請輸入有效的JSON', false);
                    return;
                }
                
                const result = await callApi('/queries/decrease', 'POST', { reason, metadata }, true);
                formatResult(document.getElementById('decrease-query-count-result'), result, result.success);
            });
            
            // 獲取咨詢記錄
            document.getElementById('get-my-query-records-btn')?.addEventListener('click', async () => {
                const page = document.getElementById('query-records-page').value || 1;
                const limit = document.getElementById('query-records-limit').value || 10;
                const action = document.getElementById('query-records-action').value;
                
                let url = `/queries/my-records?page=${page}&limit=${limit}`;
                if (action) url += `&action=${action}`;
                
                const result = await callApi(url, 'GET', null, true);
                formatResult(document.getElementById('my-query-records-result'), result, result.success);
            });
            
            // 管理員 - 增加用戶咨詢次數
            document.getElementById('admin-increase-query-btn')?.addEventListener('click', async () => {
                const userId = document.getElementById('admin-increase-user-id').value;
                const amount = parseInt(document.getElementById('admin-increase-amount').value);
                const reason = document.getElementById('admin-increase-reason').value;
                
                if (!userId || !amount || !reason) {
                    formatResult(document.getElementById('admin-increase-query-result'), '請填寫所有必填欄位', false);
                    return;
                }
                
                const result = await callApi('/queries/increase', 'POST', { userId, amount, reason }, true);
                formatResult(document.getElementById('admin-increase-query-result'), result, result.success);
            });
            
            // 管理員 - 調整用戶咨詢次數
            document.getElementById('admin-adjust-query-btn')?.addEventListener('click', async () => {
                const userId = document.getElementById('admin-adjust-user-id').value;
                const operation = document.getElementById('admin-adjust-operation').value;
                const amount = parseInt(document.getElementById('admin-adjust-amount').value);
                const reason = document.getElementById('admin-adjust-reason').value;
                
                if (!userId || !operation || isNaN(amount) || !reason) {
                    formatResult(document.getElementById('admin-adjust-query-result'), '請填寫所有必填欄位', false);
                    return;
                }
                
                const result = await callApi('/queries/admin/adjust', 'POST', { userId, operation, amount, reason }, true);
                formatResult(document.getElementById('admin-adjust-query-result'), result, result.success);
            });
            
            // 管理員 - 批量調整咨詢次數
            document.getElementById('admin-batch-adjust-query-btn')?.addEventListener('click', async () => {
                const userIdsText = document.getElementById('admin-batch-user-ids').value;
                const operation = document.getElementById('admin-batch-operation').value;
                const amount = parseInt(document.getElementById('admin-batch-amount').value);
                const reason = document.getElementById('admin-batch-reason').value;
                
                if (!userIdsText || !operation || isNaN(amount) || !reason) {
                    formatResult(document.getElementById('admin-batch-adjust-query-result'), '請填寫所有必填欄位', false);
                    return;
                }
                
                const userIds = userIdsText.split(',').map(id => id.trim()).filter(id => id);
                if (userIds.length === 0) {
                    formatResult(document.getElementById('admin-batch-adjust-query-result'), '請輸入有效的用戶ID列表', false);
                    return;
                }
                
                const result = await callApi('/queries/admin/batch-adjust', 'POST', { userIds, operation, amount, reason }, true);
                formatResult(document.getElementById('admin-batch-adjust-query-result'), result, result.success);
            });
            
            // 管理員 - 獲取用戶咨詢狀態
            document.getElementById('admin-get-user-query-status-btn')?.addEventListener('click', async () => {
                const userId = document.getElementById('admin-query-user-id').value;
                if (!userId) {
                    formatResult(document.getElementById('admin-user-query-status-result'), '請輸入用戶ID', false);
                    return;
                }
                const result = await callApi(`/queries/user/${userId}/status`, 'GET', null, true);
                formatResult(document.getElementById('admin-user-query-status-result'), result, result.success);
            });
            
            // 管理員 - 獲取用戶咨詢記錄
            document.getElementById('admin-get-user-query-records-btn')?.addEventListener('click', async () => {
                const userId = document.getElementById('admin-query-user-id').value;
                if (!userId) {
                    formatResult(document.getElementById('admin-user-query-records-result'), '請輸入用戶ID', false);
                    return;
                }
                const result = await callApi(`/queries/user/${userId}/records?page=1&limit=10`, 'GET', null, true);
                formatResult(document.getElementById('admin-user-query-records-result'), result, result.success);
            });
            
            // 管理員 - 獲取系統咨詢統計
            document.getElementById('admin-get-query-system-stats-btn')?.addEventListener('click', async () => {
                const startDate = document.getElementById('query-stats-start-date').value;
                const endDate = document.getElementById('query-stats-end-date').value;
                
                let url = '/queries/admin/system-stats';
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (params.toString()) url += '?' + params.toString();
                
                const result = await callApi(url, 'GET', null, true);
                formatResult(document.getElementById('admin-query-system-stats-result'), result, result.success);
            });
        });
    </script>
</body>
</html>