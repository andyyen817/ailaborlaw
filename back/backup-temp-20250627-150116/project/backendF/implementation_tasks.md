# 勞法通AI後端開發小任務清單

本文檔將後端開發任務拆分為小任務單元，便於逐步實施。每個任務都包含明確的目標、具體步驟和成功指標，幫助非技術人員理解和跟進開發進度。

## 任務組1: 專案初始化與基礎設置

### 任務1.1: 專案基礎結構設置

**目標**：建立專案基本結構，配置必要的開發環境和依賴。

**具體步驟**：
1. 創建專案目錄和基本文件
2. 初始化 npm 專案
3. 安裝核心依賴項 (Express.js, MongoDB, JWT等)
4. 設置基本配置文件
5. 創建環境變量配置文件

**成功指標**：
- 專案目錄結構建立完成
- package.json 文件配置正確
- npm install 命令執行無錯誤
- 可以啟動一個基本的空服務器

### 任務1.2: 數據庫連接設置

**目標**：建立與MongoDB數據庫的連接，確保應用可以正常訪問數據庫。

**具體步驟**：
1. 安裝 mongoose 包
2. 創建數據庫連接配置文件
3. 實現數據庫連接邏輯
4. 添加連接錯誤處理
5. 設置適當的數據庫日誌

**成功指標**：
- 成功連接到指定的MongoDB數據庫
- 連接過程中的錯誤能被正確捕獲並記錄
- 應用啟動時顯示數據庫連接成功的日誌

### 任務1.3: 錯誤處理與日誌系統

**目標**：建立全局錯誤處理機制和日誌記錄系統，確保應用穩定性和可調試性。

**具體步驟**：
1. 安裝 winston 或其他日誌庫
2. 設置錯誤處理中間件
3. 配置日誌記錄格式和存儲
4. 實現不同級別的日誌記錄
5. 添加請求日誌記錄中間件

**成功指標**：
- 應用錯誤能被捕獲而不崩潰
- 日誌正確記錄到指定位置
- 不同類型的錯誤有適當的日誌級別
- API請求都有相應的日誌記錄

## 任務組2: 用戶認證模塊

### 任務2.1: 用戶模型實現

**目標**：創建用戶數據模型，定義用戶屬性和方法。

**具體步驟**：
1. 創建 User Schema 定義用戶字段
2. 添加密碼加密功能
3. 添加密碼比較方法
4. 設置必要的數據驗證規則
5. 添加索引以優化查詢

**成功指標**：
- User 模型可以成功定義和導入
- 密碼正確加密存儲
- 可以使用 User 模型創建、查詢和更新用戶

### 任務2.2: 用戶註冊功能

**目標**：實現用戶註冊API，允許新用戶創建帳戶。

**具體步驟**：
1. 創建註冊路由
2. 實現輸入數據驗證
3. 檢查用戶是否已存在
4. 創建新用戶記錄
5. 生成JWT認證令牌
6. 返回適當的響應

**成功指標**：
- 可以通過API成功創建新用戶
- 重複郵箱註冊會被拒絕
- 無效的輸入數據返回適當的錯誤
- 成功註冊返回用戶資料和JWT令牌

### 任務2.3: 用戶登入功能

**目標**：實現用戶登入API，驗證用戶身份並提供訪問令牌。

**具體步驟**：
1. 創建登入路由
2. 驗證用戶郵箱和密碼
3. 檢查用戶帳戶狀態
4. 生成JWT認證令牌
5. 更新最後登入時間
6. 返回用戶資料和令牌

**成功指標**：
- 正確的郵箱和密碼可以成功登入
- 錯誤的憑證返回適當的錯誤消息
- 停用的帳戶無法登入
- 成功登入返回有效的JWT令牌

### 任務2.4: JWT認證中間件

**目標**：實現JWT認證中間件，保護需要認證的API路由。

**具體步驟**：
1. 創建令牌驗證函數
2. 實現認證中間件
3. 添加令牌解析和用戶載入
4. 處理無效令牌的情況
5. 添加角色權限檢查功能

**成功指標**：
- 受保護的路由需要有效令牌才能訪問
- 無令牌或無效令牌請求返回401錯誤
- 中間件正確提取用戶信息
- 權限檢查能有效控制不同角色的訪問

## 任務組3: 用戶管理模塊

### 任務3.1: 用戶資料API

**目標**：實現獲取和更新用戶資料的API。

**具體步驟**：
1. 創建獲取用戶資料的路由
2. 創建更新用戶資料的路由
3. 添加輸入驗證
4. 實現資料更新邏輯
5. 返回更新後的用戶資料

**成功指標**：
- 可以成功獲取當前登入用戶的資料
- 可以更新用戶名稱、電話等非敏感信息
- 更新操作有適當的數據驗證
- 返回更新後的完整用戶資料

### 任務3.2: 諮詢次數管理API

**目標**：實現管理用戶剩餘諮詢次數的API。

**具體步驟**：
1. 創建獲取剩餘諮詢次數的路由
2. 創建扣減諮詢次數的路由
3. 添加諮詢次數檢查邏輯
4. 實現原子性操作以避免競態條件
5. 更新用戶的總諮詢次數

**成功指標**：
- 可以正確獲取用戶剩餘諮詢次數
- 剩餘次數為0時無法再扣減
- 諮詢次數的扣減是原子操作
- 總諮詢次數隨著使用而增加

## 任務組4: 聊天會話模塊

### 任務4.1: 會話與消息模型

**目標**：創建會話和消息數據模型，定義它們的屬性和關聯。

**具體步驟**：
1. 創建 Conversation Schema
2. 創建 Message Schema
3. 建立用戶與會話的關聯
4. 建立會話與消息的關聯
5. 設置必要的索引

**成功指標**：
- 成功定義會話和消息模型
- 模型之間的關聯正確建立
- 索引設置有助於提高查詢效率
- 模型可以正確創建和查詢數據

### 任務4.2: 會話管理API

**目標**：實現創建、查詢、更新和刪除會話的API。

**具體步驟**：
1. 創建會話相關的路由
2. 實現獲取會話列表的功能
3. 實現創建新會話的功能
4. 實現獲取會話詳情的功能
5. 實現更新和刪除會話的功能

**成功指標**：
- 用戶可以成功創建新會話
- 用戶可以獲取自己的會話列表
- 可以獲取特定會話的詳情和消息
- 會話標題可以被更新
- 會話可以被正確刪除

### 任務4.3: 消息管理API

**目標**：實現發送、查詢和反饋消息的API。

**具體步驟**：
1. 創建消息相關的路由
2. 實現發送用戶消息的功能
3. 實現AI回复生成的功能
4. 實現獲取消息歷史的功能
5. 實現消息反饋的功能

**成功指標**：
- 用戶可以發送消息並獲得AI回复
- 消息歷史可以按照時間順序獲取
- 分頁功能確保大量消息的高效加載
- 用戶可以對AI回复提供有用/無用的反饋

### 任務4.4: AI聊天集成

**目標**：集成外部AI服務，處理消息的轉發和回复。

**具體步驟**：
1. 配置外部AI服務的連接
2. 實現消息轉發邏輯
3. 處理AI回复內容和參考資料
4. 實現錯誤處理和重試機制
5. 優化AI回复的存儲和展示

**成功指標**：
- 用戶消息能成功轉發到AI服務
- AI回复能正確處理並存儲
- 參考資料正確關聯到回复
- 連接問題有適當的錯誤處理

## 任務組5: 專家諮詢模塊

### 任務5.1: 專家諮詢模型

**目標**：創建專家諮詢數據模型，定義相關屬性和狀態。

**具體步驟**：
1. 創建 ExpertConsultation Schema
2. 定義諮詢狀態和類型
3. 建立用戶與諮詢的關聯
4. 設置必要的索引和驗證
5. 添加狀態變更的輔助方法

**成功指標**：
- 諮詢模型成功定義並可使用
- 模型字段覆蓋所有需求
- 狀態轉換邏輯清晰
- 用戶與諮詢之間的關聯正確

### 任務5.2: 諮詢請求API

**目標**：實現提交、查詢和管理諮詢請求的API。

**具體步驟**：
1. 創建提交諮詢請求的路由
2. 實現獲取用戶諮詢列表的功能
3. 實現獲取諮詢詳情的功能
4. 實現取消諮詢的功能
5. 確保諮詢次數的扣減

**成功指標**：
- 用戶可以成功提交諮詢請求
- 用戶可以查看自己的諮詢列表
- 諮詢狀態變更正確反映
- 取消未處理的諮詢請求功能正常

## 任務組6: 管理員功能模塊

### 任務6.1: 管理員用戶管理

**目標**：實現管理員管理用戶的API。

**具體步驟**：
1. 創建獲取用戶列表的路由
2. 實現用戶查詢和篩選功能
3. 實現用戶詳情查看功能
4. 實現用戶資料更新功能
5. 實現用戶狀態管理功能

**成功指標**：
- 管理員可以查看所有用戶列表
- 支持分頁、排序和篩選
- 可以查看任意用戶的詳細資料
- 可以更新用戶的諮詢次數和狀態

### 任務6.2: 管理員諮詢管理

**目標**：實現管理員管理專家諮詢的API。

**具體步驟**：
1. 創建獲取諮詢列表的路由
2. 實現諮詢查詢和篩選功能
3. 實現諮詢詳情查看功能
4. 實現諮詢狀態更新功能
5. 實現專家分配功能

**成功指標**：
- 管理員可以查看所有諮詢請求
- 支持按狀態、日期等篩選
- 可以更新諮詢的處理狀態
- 可以分配專家處理特定諮詢

## 任務組7: 系統優化與部署

### 任務7.1: 性能優化

**目標**：優化API性能和數據庫訪問效率。

**具體步驟**：
1. 審查並優化數據庫查詢
2. 添加適當的數據庫索引
3. 實現數據緩存策略
4. 優化大量數據的查詢和分頁
5. 減少不必要的數據庫操作

**成功指標**：
- API響應時間明顯改善
- 數據庫查詢效率提高
- 服務能處理較大的並發請求
- 系統資源利用率合理

### 任務7.2: 部署準備

**目標**：準備應用程序用於生產環境部署。

**具體步驟**：
1. 配置生產環境變量
2. 設置安全相關的HTTP頭
3. 優化錯誤處理和日誌
4. 準備Docker部署文件
5. 創建部署腳本和說明

**成功指標**：
- 應用可以以生產模式運行
- 安全配置得到適當設置
- Docker容器可以正確構建
- 部署文檔詳細且易於遵循 